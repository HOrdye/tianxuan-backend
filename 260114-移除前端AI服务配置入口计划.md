# 移除前端"AI 服务配置"入口 - 完整修改计划

**创建日期**: 2026-01-14  
**优先级**: P0 - 战略级架构调整  
**状态**: 待执行

---

## 📋 战略背景

### 为什么必须移除用户自填 API Key？

在"天玄藏经阁"这个产品定位下，让用户自己填 API Key 是一个**严重的战略错误**，它会直接摧毁我们辛苦构建的"去 AI 化"氛围和商业闭环。

### 三个维度的深度分析

#### 1. 体验维度：打破"第四面墙" (Immersion Breaker)

**用户画像**: 你的用户是来"求签问卦"的迷茫者，不是来 GitHub 找项目的开发者。

**现状问题**: 
- 如果让用户填 Key，等于直接告诉他："嘿，我是个机器人，不是大师。你自己去买电池装进我身体里。"
- 神秘感瞬间归零，产品定位完全错位

**目标状态**: 
- 用户只需要做一件事：付"功德钱"（天机币），然后领"签文"
- 中间怎么算的，是"天机"，不需要他知道

#### 2. 商业维度：利润来自"信息差" (Arbitrage)

**商业模式对比**:

| 模式 | 用户自填 Key | 平台统一 Key |
|------|------------|------------|
| **模式类型** | PaaS (Platform/Tool) | SaaS (Service) |
| **用户付费** | 直接付钱给 OpenAI/DeepSeek | 付天机币给平台 |
| **平台收入** | 只能收一点点"SaaS 订阅费" | 20倍差价（成本 ¥0.05 vs 售价 ¥1.00） |
| **溢价权** | ❌ 失去溢价权 | ✅ 算法、提示词工程、产品体验的价值 |
| **商业模式** | ❌ 不健康 | ✅ 最健康的商业模式 |

**利润结构**:
- **成本**: 调用 DeepSeek API 生成一次解读，成本可能不到 ¥0.05
- **售价**: 收用户 10 币（假设约 ¥1.00）
- **利润**: 这 20倍的差价，就是你的算法、提示词工程和产品体验的价值

#### 3. 品控维度：标准化的"宗师"人设 (Quality Control)

**风险**: 
- 如果允许用户自填 Key，用户可能会填一个 GPT-3.5 的 Key，或者是某个廉价的国产模型 Key
- 出来的结果可能逻辑不通、文风不对，甚至不听你的 Prompt 指令
- 用户不会怪模型烂，只会怪你的产品"算得不准"

**对策**: 
- 只有你掌握 API Key，你才能强制使用最顶级的模型（如 GPT-4o 或 DeepSeek-V3）
- 确保输出的永远是"宗师级"水准

---

## 🎯 修改目标

### 核心目标
1. **彻底移除**前端所有"AI 服务配置"入口
2. **删除**所有用户自填 API Key 的界面和逻辑
3. **清理**所有相关的 localStorage 存储逻辑
4. **保留**后端统一管理 API Key 的能力（通过环境变量）

### 技术实施原则
- ✅ **前端**: 删掉所有"设置 -> API Key"的界面
- ✅ **前端**: 删掉任何在 LocalStorage 存储 API Key 的逻辑
- ✅ **后端**: 统一管理（在 Node.js/Python 服务器的 .env 文件中配置企业级 API Key）
- ✅ **后端**: 计费逻辑（用户消耗数据库里的 coins，服务器消耗绑定的信用卡的 dollars/rmb）

---

## 📦 需要移除的代码清单

### 1. 组件文件（需删除）

#### 1.1 全局配置组件
- **文件**: `src/components/GlobalLLMConfig.vue`
- **功能**: 右下角浮动的 AI 配置按钮和弹窗
- **引用位置**: `src/App.vue` 第14行和第37行

#### 1.2 两难抉择配置面板
- **文件**: `src/features/dilemma/components/LLMConfigPanel.vue`
- **功能**: 两难抉择功能内的 AI 配置面板
- **引用位置**: 需要搜索确认

### 2. Store 文件（需重构）

#### 2.1 LLM 配置 Store
- **文件**: `src/store/llmConfig.ts`
- **需要移除的功能**:
  - `openModal()` / `closeModal()` - 打开/关闭配置弹窗
  - `validateCurrentConfig()` - 验证用户配置
  - `updateConfig()` - 更新用户配置（保留但改为只读）
  - `resetConfig()` - 重置用户配置
  - `saveToStorage()` - 保存到 localStorage
  - `initializeFromStorage()` - 从 localStorage 初始化
- **需要保留的功能**:
  - `getConfig()` - 获取配置（改为从后端获取或使用环境变量默认值）
  - 配置状态管理（但不再允许用户修改）

### 3. 服务层文件（需修改）

#### 3.1 LLMService
- **文件**: `src/services/LLMService.ts`
- **需要修改**:
  - `setConfig()` - 移除或改为只读（不允许用户设置）
  - `getConfig()` - 改为从后端 API 获取或使用环境变量
  - `testConnection()` - 移除（不再需要用户测试连接）

#### 3.2 EnvConfigManager
- **文件**: `src/utils/envConfig.ts`
- **需要修改**:
  - 移除 LLM 配置的 localStorage 存储逻辑
  - 只保留从环境变量读取的逻辑

### 4. 引用位置（需清理）

#### 4.1 App.vue
- **文件**: `src/App.vue`
- **需要移除**:
  - 第14行: `<GlobalLLMConfig />` 组件引用
  - 第37行: `import GlobalLLMConfig from './components/GlobalLLMConfig.vue';`
  - 第41行: `import { useLLMConfigStore } from './store/llmConfig';`
  - 第48行: `const llmStore = useLLMConfigStore();`
  - 第88行: `await llmStore.initializeFromStorage();`

#### 4.2 其他可能的引用
- 需要全局搜索 `LLMConfigPanel` 组件引用
- 需要全局搜索 `useLLMConfigStore` 的使用位置

### 5. localStorage 存储键（需清理）

#### 5.1 需要清除的存储键
- `llm_config` - 两难抉择功能使用的配置
- `llm-config-store` - Store 使用的配置
- `tianxuan_env_config` 中的 LLM 相关字段:
  - `VITE_LLM_PROVIDER`
  - `VITE_LLM_API_KEY`
  - `VITE_LLM_BASE_URL`
  - `VITE_LLM_MODEL`

### 6. 文档文件（需归档）

#### 6.1 API 配置指南
- **文件**: `memory-bank/archive/tech-docs/API-CONFIG-GUIDE.md`
- **操作**: 移动到归档目录，添加废弃说明

---

## 🔧 详细修改步骤

### Phase 1: 准备工作（风险评估）

#### Step 1.1: 搜索所有引用
```bash
# 搜索 GlobalLLMConfig 组件引用
grep -r "GlobalLLMConfig" src/

# 搜索 LLMConfigPanel 组件引用
grep -r "LLMConfigPanel" src/

# 搜索 useLLMConfigStore 使用位置
grep -r "useLLMConfigStore" src/

# 搜索 localStorage 中的 LLM 配置
grep -r "llm_config\|llm-config-store" src/
```

#### Step 1.2: 确认后端 API 状态
- [ ] 确认后端是否已有统一的 LLM API 调用接口
- [ ] 确认后端环境变量配置是否已就绪
- [ ] 确认前端如何调用后端 LLM API（是否已有接口）

### Phase 2: 移除 UI 组件

#### Step 2.1: 移除 GlobalLLMConfig 组件
1. 删除 `src/components/GlobalLLMConfig.vue` 文件
2. 从 `src/App.vue` 移除组件引用和导入
3. 移除相关的 Store 初始化代码

#### Step 2.2: 移除 LLMConfigPanel 组件
1. 搜索并确认 `LLMConfigPanel` 的所有使用位置
2. 从相关页面移除组件引用
3. 删除 `src/features/dilemma/components/LLMConfigPanel.vue` 文件

### Phase 3: 重构 Store 和服务层

#### Step 3.1: 重构 llmConfig Store
1. 移除所有用户配置相关的方法（`openModal`, `closeModal`, `updateConfig`, `resetConfig`, `saveToStorage`, `initializeFromStorage`）
2. 修改 `getConfig()` 方法，改为从后端 API 获取或使用环境变量默认值
3. 保留配置状态管理，但改为只读

#### Step 3.2: 修改 LLMService
1. 移除或禁用 `setConfig()` 方法（不允许用户设置）
2. 修改 `getConfig()` 方法，改为从后端获取或使用环境变量
3. 移除 `testConnection()` 方法（不再需要用户测试）

#### Step 3.3: 修改 EnvConfigManager
1. 移除 LLM 配置的 localStorage 存储逻辑
2. 只保留从环境变量读取的逻辑

### Phase 4: 清理 localStorage

#### Step 4.1: 添加清理逻辑
1. 在应用启动时，自动清除所有 LLM 相关的 localStorage 数据
2. 确保不会影响其他功能的 localStorage 数据

#### Step 4.2: 清理代码示例
```typescript
// 在 App.vue 的 onMounted 中添加清理逻辑
function cleanupLLMConfig() {
  try {
    localStorage.removeItem('llm_config');
    localStorage.removeItem('llm-config-store');
    
    // 清理 tianxuan_env_config 中的 LLM 字段
    const envConfig = localStorage.getItem('tianxuan_env_config');
    if (envConfig) {
      const config = JSON.parse(envConfig);
      delete config.VITE_LLM_PROVIDER;
      delete config.VITE_LLM_API_KEY;
      delete config.VITE_LLM_BASE_URL;
      delete config.VITE_LLM_MODEL;
      localStorage.setItem('tianxuan_env_config', JSON.stringify(config));
    }
    
    console.log('✅ LLM 用户配置已清理');
  } catch (error) {
    console.warn('⚠️ 清理 LLM 配置失败:', error);
  }
}
```

### Phase 5: 更新文档

#### Step 5.1: 归档旧文档
1. 将 `memory-bank/archive/tech-docs/API-CONFIG-GUIDE.md` 移动到归档目录
2. 在文档开头添加废弃说明

#### Step 5.2: 更新相关文档
1. 更新 `README.MD`，移除 API 配置相关说明
2. 更新开发文档，说明 LLM 配置现在由后端统一管理

### Phase 6: 测试验证

#### Step 6.1: 功能测试
- [ ] 确认所有 AI 功能（塔罗、易经、紫微等）仍能正常工作
- [ ] 确认不再显示任何 API Key 配置入口
- [ ] 确认 localStorage 中不再存储 LLM 配置
- [ ] 确认后端 API 调用正常

#### Step 6.2: 代码检查
- [ ] TypeScript 类型检查通过
- [ ] 无未使用的导入和变量
- [ ] 无控制台错误和警告

---

## ⚠️ 注意事项

### 1. 向后兼容性
- **重要**: 如果已有用户配置了 API Key，需要在移除前先清理他们的 localStorage
- 建议在移除前先运行清理脚本，清除所有用户的 LLM 配置

### 2. 后端 API 准备
- **必须**: 确保后端已有统一的 LLM API 调用接口
- **必须**: 确保后端环境变量配置已就绪
- **建议**: 在移除前端配置前，先测试后端 API 调用是否正常

### 3. 错误处理
- 如果后端 API 调用失败，需要有友好的错误提示
- 不应该显示"请配置 API Key"之类的提示，而应该显示"服务暂时不可用，请稍后重试"

### 4. 渐进式迁移（可选）
- 如果担心影响太大，可以考虑先隐藏配置入口，保留代码
- 观察一段时间后再彻底删除代码

---

## ✅ 验证清单

### 代码层面
- [ ] `GlobalLLMConfig.vue` 文件已删除
- [ ] `LLMConfigPanel.vue` 文件已删除
- [ ] `src/App.vue` 中已移除所有相关引用
- [ ] `llmConfig.ts` Store 已重构为只读模式
- [ ] `LLMService.ts` 已移除用户配置相关方法
- [ ] `EnvConfigManager.ts` 已移除 localStorage 存储逻辑
- [ ] 所有 localStorage 清理逻辑已添加

### 功能层面
- [ ] 所有 AI 功能（塔罗、易经、紫微等）正常工作
- [ ] 不再显示任何 API Key 配置入口
- [ ] localStorage 中不再存储 LLM 配置
- [ ] 后端 API 调用正常
- [ ] 错误处理友好（不显示配置提示）

### 文档层面
- [ ] 旧文档已归档
- [ ] README.MD 已更新
- [ ] 开发文档已更新

---

## 📊 影响范围评估

### 受影响的模块
1. **塔罗牌功能** - 使用 LLMService 生成解读
2. **易经占卜功能** - 使用 LLMService 生成卦象解读
3. **两难抉择功能** - 使用 LLMService 生成建议（有独立的配置面板）
4. **紫微斗数功能** - 使用 LLMService 生成命盘解读
5. **今日运势功能** - 使用 LLMService 生成运势内容

### 风险评估
- **风险等级**: 🟡 中等
- **主要风险**: 如果后端 API 未准备好，可能导致所有 AI 功能不可用
- **缓解措施**: 
  1. 确保后端 API 已就绪后再执行移除
  2. 保留降级方案（如果后端 API 失败，显示友好错误提示）

---

## 🚀 执行建议

### 推荐执行顺序
1. **第一步**: 确认后端 API 已就绪
2. **第二步**: 先隐藏配置入口（CSS display: none），观察一段时间
3. **第三步**: 如果一切正常，再彻底删除代码
4. **第四步**: 清理 localStorage 和文档

### 时间估算
- **Phase 1 (准备)**: 1-2 小时
- **Phase 2 (移除组件)**: 1-2 小时
- **Phase 3 (重构 Store)**: 2-3 小时
- **Phase 4 (清理存储)**: 1 小时
- **Phase 5 (更新文档)**: 1 小时
- **Phase 6 (测试验证)**: 2-3 小时

**总计**: 约 8-12 小时

---

## 📝 后续工作

### 后端工作（需要后端团队配合）
1. **环境变量配置**: 在 `.env` 文件中配置企业级 API Key
   ```env
   DEEPSEEK_API_KEY=sk-proj-xxxxxxxx
   ```

2. **API 调用接口**: 确保后端有统一的 LLM API 调用接口
   - 接收前端请求（包含 prompt、模型参数等）
   - 使用后端配置的 API Key 调用 LLM 服务
   - 返回结果给前端

3. **成本监控**: 在后端添加 Dashboard，监控 API 调用成本 vs 天机币充值收入
   - 确保毛利率健康
   - 及时发现异常调用

### 前端工作（本次修改）
1. **API 调用改造**: 将所有直接调用 LLM API 的代码改为调用后端 API
2. **错误处理**: 统一错误处理，不显示配置相关提示

---

## 🔗 相关文档

- [API开发规则](../.cursor/rules/api-development-rules.mdc)
- [前端转后端迁移指南](../active/migrations/FRONTEND_MIGRATION_GUIDE.md)
- [经济型全栈部署方案](../active/deployment/260130-经济型全栈部署方案-All-in-One.md)

---

## 📌 更新记录

- **2026-01-14**: 创建计划文档
