# 签到奖励修复说明

## 📋 修复日期
2025-01-11

## 🐛 问题描述

**问题现象**：
- 用户签到2天，第1次10币，本次签到为天命师等级（premium），应该奖励500币
- 但实际只奖励了40币
- 控制台显示：连续签到1天，奖励10币

**问题根源**：
1. 后端签到服务（`checkin.service.ts`）硬编码了 `baseReward = 10`，完全忽略了用户等级
2. 后端没有实现前端的7天循环奖励机制
3. 后端使用的是旧的固定奖励配置（premium: 20币），而不是前端的7天循环奖励表（destiny_master: 500币）

## ✅ 修复内容

### 1. 添加7天循环奖励配置表

**文件位置**：`src/services/checkin.service.ts`

**奖励配置表**：
```typescript
const REWARD_TABLE: Record<Tier, number[]> = {
  guest: [0, 0, 0, 0, 0, 0, 0],           // 游客：0 天机币（无法签到）
  explorer: [2, 3, 3, 4, 4, 5, 5],        // 探索者：平均3.4币/天
  basic: [45, 48, 50, 52, 55, 58, 70],    // 开悟者：平均54币/天
  premium: [500, 500, 500, 500, 500, 500, 600], // 天命师：平均514币/天
  vip: [500, 500, 500, 500, 500, 500, 600],     // 玄机大师：与天命师相同（待开发）
};
```

**计算逻辑**：
- 使用7天循环奖励机制
- 根据连续签到天数（1-7循环）从奖励表中取值
- 第1天=索引0，第2天=索引1，...，第7天=索引6
- 第8天重新循环到第1天

### 2. 创建统一的奖励计算函数

**函数**：`calculateCheckinReward(tier: Tier, consecutiveDays: number): number`

**功能**：
- 根据用户等级和连续签到天数计算奖励
- 使用7天循环机制，确保奖励与前端一致

### 3. 修复签到服务

**文件位置**：`src/services/checkin.service.ts`

**修改内容**：
- ✅ 在 `dailyCheckIn` 函数中获取用户等级（`tier`）
- ✅ 使用 `calculateCheckinReward` 函数计算奖励，而不是硬编码的10币
- ✅ 根据用户等级和连续签到天数计算正确的奖励

### 4. 修复签到状态查询

**文件位置**：`src/controllers/checkin.controller.ts`

**修改内容**：
- ✅ 导入并使用 `calculateCheckinReward` 函数
- ✅ 如果今天已签到，返回实际获得的奖励
- ✅ 如果今天未签到，计算预期奖励（使用当前连续天数+1）

### 5. 统一升级补差服务

**文件位置**：
- `src/services/checkin-upgrade.service.ts`
- `src/controllers/checkin-upgrade.controller.ts`

**修改内容**：
- ✅ 导入并使用统一的 `calculateCheckinReward` 函数
- ✅ 移除旧的固定奖励配置
- ✅ 确保升级补差计算使用相同的7天循环奖励机制

## 📊 奖励配置对比

### 修复前（旧配置）
```typescript
const TIER_CHECKIN_REWARDS: Record<Tier, number> = {
  guest: 0,
  explorer: 10,
  basic: 15,
  premium: 20,  // ❌ 只有20币
  vip: 30,
};
```

### 修复后（7天循环配置）
```typescript
const REWARD_TABLE: Record<Tier, number[]> = {
  guest: [0, 0, 0, 0, 0, 0, 0],
  explorer: [2, 3, 3, 4, 4, 5, 5],
  basic: [45, 48, 50, 52, 55, 58, 70],
  premium: [500, 500, 500, 500, 500, 500, 600], // ✅ 第1-6天500币，第7天600币
  vip: [500, 500, 500, 500, 500, 500, 600],
};
```

## 🧪 测试步骤

### 测试场景1：天命师等级签到

1. **准备**：
   - 确保用户等级为 `premium`（天命师）
   - 确保用户今天未签到

2. **测试步骤**：
   - 调用签到API：`POST /api/checkin/daily`
   - 检查返回的 `coinsEarned` 字段

3. **预期结果**：
   - 第1天签到：应获得 **500** 天机币
   - 第2天签到：应获得 **500** 天机币
   - ...
   - 第7天签到：应获得 **600** 天机币
   - 第8天签到：应获得 **500** 天机币（重新循环）

### 测试场景2：查询签到状态

1. **准备**：
   - 确保用户等级为 `premium`（天命师）
   - 确保用户今天未签到

2. **测试步骤**：
   - 调用查询状态API：`GET /api/checkin/status`
   - 检查返回的 `todayReward` 字段

3. **预期结果**：
   - 如果今天未签到：`todayReward` 应该显示预期奖励（根据连续天数+1计算）
   - 如果今天已签到：`todayReward` 应该显示实际获得的奖励

### 测试场景3：不同等级奖励对比

1. **测试步骤**：
   - 使用不同等级的用户进行签到
   - 对比不同等级的奖励

2. **预期结果**：
   - **探索者（explorer）**：第1天2币，第2天3币，...，第7天5币
   - **开悟者（basic）**：第1天45币，第2天48币，...，第7天70币
   - **天命师（premium）**：第1-6天500币，第7天600币

## ✅ 验证清单

- [x] 添加7天循环奖励配置表
- [x] 创建统一的奖励计算函数
- [x] 修复签到服务，使用新的奖励计算逻辑
- [x] 修复签到状态查询，使用新的奖励计算逻辑
- [x] 统一升级补差服务，使用新的奖励计算逻辑
- [x] 确保所有相关文件使用相同的奖励配置

## 📝 注意事项

1. **等级映射**：
   - 后端数据库等级：`premium` = 天命师
   - 前端映射：`premium` → `destiny_master`
   - 奖励配置使用后端等级值（`premium`）

2. **连续天数计算**：
   - 连续天数从1开始（第1天=1，第2天=2，...）
   - 奖励表索引从0开始（第1天=索引0，第2天=索引1，...）
   - 计算公式：`(consecutiveDays - 1) % 7`

3. **7天循环机制**：
   - 第1-7天使用奖励表中的值
   - 第8天重新循环到第1天
   - 第15天、第22天等也会重新循环

4. **已签到用户**：
   - 如果用户今天已签到，查询状态时返回实际获得的奖励
   - 如果用户今天未签到，查询状态时计算预期奖励（使用连续天数+1）

## 🎯 下一步

1. **测试验证**：按照测试步骤验证修复是否生效
2. **监控日志**：观察签到奖励是否正确计算
3. **用户反馈**：收集用户反馈，确认奖励是否正确发放
