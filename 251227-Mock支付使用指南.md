# Mock 支付开发者调试功能使用指南

## 📋 概述

Mock 支付功能是专为开发环境设计的虚拟支付网关，允许开发者在没有真实支付 API 的情况下，完整测试支付业务流程。

---

## 🎯 功能说明

### 开发者调试面板

在开发环境中，支付弹窗会显示一个**黄色渐变背景的开发者调试面板**，包含以下功能：

1. **模拟支付成功** - 模拟支付成功流程，测试完整业务逻辑
2. **模拟支付失败** - 模拟支付失败场景
3. **模拟支付取消** - 模拟用户取消支付

---

## 🚀 使用步骤

### 第一步：打开支付弹窗

1. 进入充值页面或点击充值按钮
2. 选择一个充值包（如：新人礼 ¥1.00 / 20币）
3. 选择支付方式（微信/支付宝）
4. 点击"确认支付"

### 第二步：使用 Mock 支付

**重要**：在开发环境中，支付弹窗会自动显示开发者调试面板。

#### 方式一：使用开发者调试面板（推荐）

1. 点击"确认支付"后，会看到开发者调试面板
2. 在面板中点击"模拟支付成功"按钮
3. 系统会自动：
   - 调用 `PaymentService.mockPaymentSuccess()`
   - 处理支付回调（复用真实业务逻辑）
   - 发放天机币
   - 更新订单状态
   - 刷新余额显示

#### 方式二：使用控制台（高级）

如果需要手动测试，可以在浏览器控制台执行：

```javascript
// 需要先创建订单，获取订单ID
// 假设订单ID为 order-123
import { PaymentService } from '@/services/payment/PaymentService';

// 模拟支付成功
await PaymentService.mockPaymentSuccess('order-123', 'wechat');

// 模拟支付失败
await PaymentService.mockPaymentFailure('order-123');

// 模拟支付取消
await PaymentService.mockPaymentCancelled('order-123');
```

---

## ✅ 验证结果

使用 Mock 支付后，应该验证以下内容：

1. **余额增加** - 检查天机币余额是否正确增加
2. **订单状态** - 检查订单状态是否更新为 'paid'
3. **幂等性** - 重复点击"模拟支付成功"，余额不应重复增加
4. **控制台日志** - 查看控制台是否有错误信息

---

## 🔍 常见问题

### Q1: 为什么看不到开发者调试面板？

**A**: 检查以下几点：
- 确保在开发环境（`npm run dev`）
- 检查环境变量 `VITE_ENABLE_MOCK_PAYMENT` 是否设置为 'true'（可选）
- 确保已创建订单（点击"确认支付"后）

### Q2: 控制台出现 `btoa()` 编码错误？

**A**: 这个问题已经修复。如果仍然出现，请刷新页面。

**错误信息**：
```
InvalidCharacterError: Failed to execute 'btoa' on 'Window': 
The string to be encoded contains characters outside of the Latin1 range.
```

**解决方案**：已修复，使用 `btoa(unescape(encodeURIComponent()))` 正确处理中文。

### Q3: 第一次失败后，无法重新加载充值页面？

**A**: 这个问题已经修复。现在每次打开弹窗时都会重置状态并重新加载。

**解决方案**：已修复，在 `watch(isVisible)` 中添加了状态重置逻辑。

### Q4: Mock 支付成功后，余额没有增加？

**A**: 检查以下几点：
- 查看控制台是否有错误信息
- 检查订单状态是否为 'paid'
- 检查数据库中的 `profiles` 表的 `tianji_coins_balance` 字段
- 检查 `transactions` 表的 `status` 字段

### Q5: 生产环境可以使用 Mock 支付吗？

**A**: **不可以**。Mock 支付功能在生产环境会被强制禁用。

**安全机制**：
- `isMockMode()` 方法会检查 `import.meta.env.PROD`
- 生产环境调用 Mock 方法会直接返回错误
- 前端调试面板仅在开发环境显示

---

## 🛠️ 技术细节

### Mock 模式启用条件

```typescript
// 启用条件（满足任一即可）：
1. import.meta.env.DEV === true（Vite 开发模式）
2. VITE_ENABLE_MOCK_PAYMENT === 'true'（环境变量）

// 禁用条件：
- import.meta.env.PROD === true（生产环境强制禁用）
```

### Mock 支付流程

1. **创建订单** - 调用 `PaymentService.createPaymentOrder()`
2. **生成 Mock 二维码** - 返回 SVG 格式的 Mock 二维码
3. **模拟支付成功** - 调用 `PaymentService.mockPaymentSuccess()`
4. **处理回调** - 复用 `handleCallback()` 逻辑
5. **发放天机币** - 调用 `grantCoinsAfterPayment()`
6. **更新订单状态** - 更新为 'paid'

### 幂等性保证

Mock 支付复用了真实的 `handleCallback()` 逻辑，确保：
- 重复调用不会重复加币
- 订单状态正确更新
- 业务逻辑完整测试

---

## 📝 测试用例

### 测试用例 1：基础流程

1. 打开支付弹窗
2. 选择充值包（新人礼 ¥1.00 / 20币）
3. 选择支付方式（微信）
4. 点击"确认支付"
5. 在开发者调试面板点击"模拟支付成功"
6. **验证**：
   - ✅ 余额增加 20 币
   - ✅ 订单状态更新为 'paid'
   - ✅ 显示成功提示

### 测试用例 2：幂等性测试

1. 创建订单（订单ID: order-123）
2. Mock 支付成功（第一次）
3. 检查余额增加
4. Mock 支付成功（第二次，相同订单ID）
5. **验证**：
   - ✅ 第一次 Mock 支付成功，余额增加
   - ✅ 第二次 Mock 支付成功，返回 `alreadyProcessed: true`
   - ✅ 余额不重复增加

### 测试用例 3：失败场景

1. 创建订单
2. Mock 支付失败
3. **验证**：
   - ✅ 订单状态更新为 'failed'
   - ✅ 余额不应增加
   - ✅ 显示失败提示

### 测试用例 4：取消场景

1. 创建订单
2. Mock 支付取消
3. **验证**：
   - ✅ 订单状态更新为 'cancelled'
   - ✅ 余额不应增加
   - ✅ 弹窗自动关闭

---

## 🔒 安全注意事项

1. **生产环境禁用** - Mock 支付功能在生产环境会被强制禁用
2. **环境变量检查** - 确保环境变量正确配置
3. **日志记录** - Mock 支付操作会记录详细日志，便于调试
4. **数据验证** - Mock 支付会验证订单状态，确保数据一致性

---

## 📚 相关文档

- [虚拟支付网关方案](./251227-虚拟支付网关方案.md)
- [PaymentService 源码](../src/services/payment/PaymentService.ts)
- [PaymentModal 组件](../src/components/v5/PaymentModal.vue)

---

**文档版本**: v1.0  
**最后更新**: 2025-01-27  
**维护者**: 开发团队

