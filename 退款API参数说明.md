# é€€æ¬¾APIå‚æ•°è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`POST /api/payment/refund-logs` API æ”¯æŒä¸¤ç§é€€æ¬¾åœºæ™¯ï¼Œæ ¹æ®è¯·æ±‚å‚æ•°è‡ªåŠ¨è¯†åˆ«åœºæ™¯ç±»å‹ã€‚

---

## ğŸ”„ åœºæ™¯1ï¼šè®¢å•é€€æ¬¾

**ç”¨é€”**ï¼šç”¨æˆ·è´­ä¹°è®¢å•åç”³è¯·é€€æ¬¾

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "orderId": "uuid",              // è®¢å•IDï¼ˆå¿…å¡«ï¼Œå­—ç¬¦ä¸²ï¼‰
  "refundAmount": 100,            // é€€æ¬¾é‡‘é¢ï¼ˆå¿…å¡«ï¼Œæ•°å­—ï¼Œäººæ°‘å¸ï¼Œå•ä½ï¼šå…ƒï¼Œå¿…é¡»å¤§äº0ï¼‰
  "refundCoins": 1000,            // é€€æ¬¾å¤©æœºå¸æ•°é‡ï¼ˆå¿…å¡«ï¼Œæ•°å­—ï¼Œä¸èƒ½ä¸ºè´Ÿæ•°ï¼‰
  "refundReason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"  // é€€æ¬¾åŸå› ï¼ˆå¯é€‰ï¼Œå­—ç¬¦ä¸²ï¼‰
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. éªŒè¯è®¢å•æ˜¯å¦å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
2. éªŒè¯è®¢å•çŠ¶æ€ä¸º `completed`
3. åˆ›å»ºé€€æ¬¾æ—¥å¿—ï¼ŒçŠ¶æ€ä¸º `pending`
4. éœ€è¦åç»­å¤„ç†æµç¨‹å®Œæˆé€€æ¬¾

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "è®¢å•é€€æ¬¾æ—¥å¿—åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "order_id": "uuid",
    "original_request_id": null,
    "refund_amount": 100,
    "refund_coins": 1000,
    "refund_reason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾",
    "status": "pending",
    "processed_at": null,
    "created_at": "2025-01-30T12:00:00Z"
  }
}
```

---

## ğŸ¤– åœºæ™¯2ï¼šAIæœåŠ¡å¤±è´¥è‡ªåŠ¨é€€æ¬¾

**ç”¨é€”**ï¼šAIæœåŠ¡è°ƒç”¨å¤±è´¥æ—¶è‡ªåŠ¨é€€è¿˜å¤©æœºå¸

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "amount": 100,                          // é€€æ¬¾å¤©æœºå¸æ•°é‡ï¼ˆå¿…å¡«ï¼Œæ•°å­—ï¼Œå¿…é¡»å¤§äº0ï¼‰
  "reason": "AIæœåŠ¡è°ƒç”¨å¤±è´¥",              // é€€æ¬¾åŸå› ï¼ˆå¿…å¡«ï¼Œå­—ç¬¦ä¸²ï¼‰
  "original_deduction": 100,              // åŸå§‹æ‰£è´¹é‡‘é¢ï¼ˆå¯é€‰ï¼Œæ•°å­—ï¼Œç”¨äºè®°å½•ï¼‰
  "original_request_id": "uuid"           // åŸå§‹è¯·æ±‚ID/äº¤æ˜“IDï¼ˆå¿…å¡«ï¼Œå­—ç¬¦ä¸²ï¼‰
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. éªŒè¯å‚æ•°æœ‰æ•ˆæ€§
2. åˆ›å»ºé€€æ¬¾æ—¥å¿—ï¼ŒçŠ¶æ€ä¸º `pending`
3. **è‡ªåŠ¨é€€è¿˜å¤©æœºå¸åˆ°ç”¨æˆ·è´¦æˆ·**ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
4. è®°å½•é€€æ¬¾æ—¥å¿—ç”¨äºå®¡è®¡

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "AIæœåŠ¡é€€æ¬¾æ—¥å¿—åˆ›å»ºæˆåŠŸï¼Œå¤©æœºå¸å·²é€€è¿˜",
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "order_id": null,
    "original_request_id": "uuid",
    "refund_amount": null,
    "refund_coins": 100,
    "refund_reason": "AIæœåŠ¡è°ƒç”¨å¤±è´¥",
    "status": "pending",
    "processed_at": null,
    "created_at": "2025-01-30T12:00:00Z"
  }
}
```

---

## ğŸ” åœºæ™¯è¯†åˆ«é€»è¾‘

API æ ¹æ®è¯·æ±‚å‚æ•°è‡ªåŠ¨è¯†åˆ«åœºæ™¯ï¼š

1. **å¦‚æœåŒ…å« `orderId`** â†’ è®¢å•é€€æ¬¾åœºæ™¯
   - éœ€è¦ï¼š`orderId`, `refundAmount`, `refundCoins`
   - å¯é€‰ï¼š`refundReason`

2. **å¦‚æœåŒ…å« `original_request_id`** â†’ AIæœåŠ¡é€€æ¬¾åœºæ™¯
   - éœ€è¦ï¼š`amount`, `reason`, `original_request_id`
   - å¯é€‰ï¼š`original_deduction`

3. **å¦‚æœä¸¤è€…éƒ½ä¸åŒ…å«** â†’ è¿”å›å‚æ•°é”™è¯¯

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### è®¢å•é€€æ¬¾åœºæ™¯
- âœ… åªæœ‰çŠ¶æ€ä¸º `completed` çš„è®¢å•æ‰èƒ½é€€æ¬¾
- âœ… è®¢å•å¿…é¡»å±äºå½“å‰ç”¨æˆ·
- âœ… é€€æ¬¾æ—¥å¿—åˆ›å»ºåéœ€è¦åç»­å¤„ç†æµç¨‹å®Œæˆé€€æ¬¾
- âœ… ä¸ä¼šç«‹å³é€€è¿˜å¤©æœºå¸ï¼ˆéœ€è¦ç®¡ç†å‘˜å®¡æ ¸ï¼‰

### AIæœåŠ¡é€€æ¬¾åœºæ™¯
- âœ… åˆ›å»ºé€€æ¬¾æ—¥å¿—å**ç«‹å³é€€è¿˜å¤©æœºå¸**
- âœ… éœ€è¦æä¾›åŸå§‹æ‰£è´¹æ—¶çš„äº¤æ˜“IDï¼ˆ`original_request_id`ï¼‰
- âœ… é€‚ç”¨äºAIæœåŠ¡è°ƒç”¨å¤±è´¥ã€è¶…æ—¶ç­‰åœºæ™¯
- âœ… é€€æ¬¾åŸå› ï¼ˆ`reason`ï¼‰å¿…é¡»æä¾›

---

## ğŸ“Š æ•°æ®åº“å­—æ®µæ˜ å°„

| åœºæ™¯ | order_id | original_request_id | refund_amount | refund_coins | refund_reason |
|------|----------|---------------------|---------------|--------------|---------------|
| è®¢å•é€€æ¬¾ | âœ… æœ‰å€¼ | âŒ null | âœ… æœ‰å€¼ | âœ… æœ‰å€¼ | âœ… æœ‰å€¼ |
| AIæœåŠ¡é€€æ¬¾ | âŒ null | âœ… æœ‰å€¼ | âŒ null | âœ… æœ‰å€¼ | âœ… æœ‰å€¼ |

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•è®¢å•é€€æ¬¾
```bash
curl -X POST "http://localhost:3000/api/payment/refund-logs" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "completed_order_id",
    "refundAmount": 100,
    "refundCoins": 1000,
    "refundReason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"
  }'
```

### æµ‹è¯•AIæœåŠ¡é€€æ¬¾
```bash
curl -X POST "http://localhost:3000/api/payment/refund-logs" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 100,
    "reason": "AIæœåŠ¡è°ƒç”¨å¤±è´¥",
    "original_deduction": 100,
    "original_request_id": "transaction_id_from_deduction"
  }'
```

---

## ğŸ”„ æ•°æ®åº“è¿ç§»

å¦‚æœæ•°æ®åº“è¡¨è¿˜æ²¡æœ‰ `original_request_id` å­—æ®µï¼Œéœ€è¦æ‰§è¡Œè¿ç§»è„šæœ¬ï¼š

```bash
psql -U <username> -d <database> -f scripts/migration-create-payment-tables.sql
```

è¿ç§»è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ·»åŠ  `original_request_id` å­—æ®µ
- ä¿®æ”¹ `order_id` å’Œ `refund_amount` ä¸ºå¯ç©º
- æ·»åŠ çº¦æŸç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªé€€æ¬¾æ¥æº

---

**æœ€åæ›´æ–°**ï¼š2025å¹´1æœˆ30æ—¥
