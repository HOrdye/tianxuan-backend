// ============================================================================
// 订阅/会员系统类型定义
// 文件位置：src/services/subscription.service.ts
// ============================================================================

/**
 * 会员等级类型
 * - free: 免费用户（探索者）
 * - basic: 基础会员（开悟者）
 * - premium: 高级会员（天命师）
 * - vip: VIP会员（玄机大师）
 */
export type Tier = 'free' | 'basic' | 'premium' | 'vip';

/**
 * 订阅状态类型
 * - active: 活跃状态（订阅中）
 * - expired: 已过期
 * - cancelled: 已取消
 * - pending: 待支付
 */
export type SubscriptionStatus = 'active' | 'expired' | 'cancelled' | 'pending';

/**
 * 订阅信息接口
 * 对应数据库 subscriptions 表
 */
export interface Subscription {
  id: string;                    // 订阅ID
  user_id: string;               // 用户ID
  tier: Tier;                    // 会员等级
  status: SubscriptionStatus;    // 订阅状态
  started_at: Date;              // 订阅开始时间
  expires_at: Date | null;       // 订阅过期时间（null表示永久）
  cancelled_at: Date | null;      // 取消时间（可选，如果数据库表没有此字段则为 null）
  auto_renew: boolean;            // 是否自动续费
  created_at: Date;               // 创建时间
  updated_at: Date;               // 更新时间
}

/**
 * 订阅状态查询结果接口
 * 用于 GET /api/subscription/status 接口返回
 */
export interface SubscriptionStatusResult {
  tier: Tier;                     // 当前会员等级
  status: SubscriptionStatus;     // 订阅状态
  expiresAt: Date | null;         // 过期时间（注意：这里是 camelCase）
  features: Record<string, any>;   // 功能权限配置
  isPremium: boolean;              // 是否为高级会员（premium 或 vip）
}

/**
 * 功能权限检查结果接口
 * 用于 GET /api/subscription/permission/:feature 接口返回
 */
export interface FeatureCheckResult {
  allowed: boolean;                // 是否允许使用
  reason?: string;                // 不允许的原因（可选）
  upgradeTier?: Tier;             // 建议升级的等级（可选）
}

/**
 * 使用次数查询结果接口
 * 用于 GET /api/subscription/usage/:feature 接口返回
 */
export interface UsageResult {
  usage: number;                   // 今日已使用次数
  limit: number;                  // 每日限制次数（0表示无限）
  remaining: number;              // 剩余次数（-1表示无限）
}

/**
 * 创建订阅请求参数
 * 用于 POST /api/subscription/create 接口
 */
export interface CreateSubscriptionRequest {
  tier: Tier;                     // 会员等级（不能是 'free'）
  isYearly: boolean;               // 是否年付
  paymentMethod?: string;          // 支付方式（可选，如 'alipay', 'wechat'）
}

/**
 * 创建订阅响应结果
 * 用于 POST /api/subscription/create 接口返回
 */
export interface CreateSubscriptionResult {
  success: boolean;                // 是否成功
  orderId: string;                // 订单ID
  payUrl?: string;                // 支付链接（可选）
  message?: string;               // 消息（可选）
}

/**
 * 检查订阅状态响应结果
 * 用于 GET /api/subscription/check-status 接口返回
 */
export interface CheckSubscriptionStatusResult {
  success: boolean;               // 是否成功
  tier: Tier;                      // 会员等级
  status: SubscriptionStatus;     // 订阅状态
}

/**
 * 取消订阅响应结果
 * 用于 POST /api/subscription/cancel 接口返回
 */
export interface CancelSubscriptionResult {
  success: boolean;               // 是否成功
  message?: string;               // 消息（可选）
}

/**
 * 检查过期订阅响应结果
 * 用于 POST /api/subscription/check-expired 接口返回
 */
export interface CheckExpiredSubscriptionResult {
  expired: boolean;               // 是否过期
  newTier: Tier;                  // 新的会员等级（如果过期则为 'free'）
}

/**
 * 记录功能使用请求参数
 * 用于 POST /api/subscription/record-usage 接口
 */
export interface RecordUsageRequest {
  feature: string;                 // 功能名称（如 'yijing', 'ziwei', 'bazi' 等）
  metadata?: any;                  // 元数据（可选）
}

/**
 * 记录功能使用响应结果
 * 用于 POST /api/subscription/record-usage 接口返回
 */
export interface RecordUsageResult {
  success: boolean;               // 是否成功
  message?: string;               // 消息（可选）
}
功能权限配置结构
/**
 * 四级会员体系功能权限配置
 * 每个等级的功能权限结构
 */
export interface TierFeatures {
  [featureName: string]: {
    available: boolean;            // 是否可用
    dailyLimit?: number;           // 每日限制次数（0表示无限，undefined表示不可用）
    basicChart?: boolean;          // 基础命盘（仅用于 ziwei）
    advancedChart?: boolean;       // 高级命盘（仅用于 ziwei）
    timeAssets?: boolean;          // 时空资产（仅用于 astrology）
    cache?: boolean;               // 缓存功能（仅用于 astrology）
  };
}

// 示例：premium 等级的配置
const premiumFeatures: TierFeatures = {
  yijing: {
    available: true,
    dailyLimit: 0,  // 0表示无限
  },
  ziwei: {
    available: true,
    basicChart: true,
    advancedChart: true,
    dailyLimit: 0,
  },
  bazi: {
    available: true,
    dailyLimit: 0,
  },
  qimen: {
    available: true,
    dailyLimit: 5,
  },
  liuyao: {
    available: true,
    dailyLimit: 5,
  },
  astrology: {
    available: true,
    timeAssets: true,
    cache: true,
  },
};