# ä½™é¢è®¾ç½®é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç®¡ç†å‘˜ä»åå°ä¿®æ”¹è´¦æˆ·å¤©æœºå¸ä¸º 1000ï¼Œä½†å‰ç«¯æ˜¾ç¤ºæ€»ä½™é¢ä¸º 1949ï¼ˆ1000 + 949ï¼‰ã€‚

**æ•°æ®åº“ç»“æœ**ï¼š
```
tianji_coins_balance: 1000
daily_coins_grant: 949
activity_coins_grant: 0
total_balance: 1949
```

**åŸå› **ï¼šç®¡ç†å‘˜é¡µé¢å¯èƒ½ä½¿ç”¨äº†æ—§çš„"è°ƒæ•´ä½™é¢"æ¥å£ï¼Œåªä¿®æ”¹äº†å‚¨å€¼ä½™é¢ï¼Œæ²¡æœ‰æ¸…é›¶èµ é€ä½™é¢ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ–°çš„"è®¾ç½®ä½™é¢"æ¥å£ï¼ˆæ¨èï¼‰

ç®¡ç†å‘˜é¡µé¢åº”è¯¥ä½¿ç”¨æ–°çš„**è®¾ç½®ä½™é¢**æ¥å£ï¼š`PUT /api/admin/users/:userId/coins/set`

**æ¥å£ç‰¹ç‚¹**ï¼š
- âœ… ç›´æ¥è®¾ç½®ä½™é¢ä¸ºæŒ‡å®šå€¼
- âœ… **é»˜è®¤è‡ªåŠ¨æ¸…é›¶èµ é€ä½™é¢**ï¼ˆå¦‚æœåªè®¾ç½®å‚¨å€¼ä½™é¢ï¼Œä¸ä¼ é€’ `clearGrants`ï¼‰
- âœ… æ”¯æŒç²¾ç¡®æ§åˆ¶æ‰€æœ‰ä½™é¢å­—æ®µ

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
PUT /api/admin/users/{userId}/coins/set
Headers: Authorization: Bearer <admin_token>
Body: {
  "tianjiCoinsBalance": 1000
}
```

**ç»“æœ**ï¼š
- å‚¨å€¼ä½™é¢è®¾ç½®ä¸º 1000
- èµ é€ä½™é¢è‡ªåŠ¨æ¸…é›¶ï¼ˆ`daily_coins_grant = 0`, `activity_coins_grant = 0`ï¼‰
- æ€»ä½™é¢ = 1000 âœ…

### æ–¹æ¡ˆ2ï¼šæ˜¾å¼æ¸…é›¶èµ é€ä½™é¢

å¦‚æœå¿…é¡»ä¿ç•™èµ é€ä½™é¢ï¼Œå¯ä»¥æ˜¾å¼è®¾ç½® `clearGrants: false`ï¼š

```json
PUT /api/admin/users/{userId}/coins/set
Body: {
  "tianjiCoinsBalance": 1000,
  "clearGrants": false
}
```

**ç»“æœ**ï¼š
- å‚¨å€¼ä½™é¢è®¾ç½®ä¸º 1000
- èµ é€ä½™é¢ä¿æŒä¸å˜
- æ€»ä½™é¢ = 1000 + èµ é€ä½™é¢

## ğŸ”§ ä»£ç ä¿®å¤

### 1. ä¿®æ”¹é»˜è®¤è¡Œä¸º

**æ–‡ä»¶**: `src/services/coins.service.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- `clearGrants` å‚æ•°æ”¹ä¸ºå¯é€‰ï¼ˆ`clearGrants?: boolean`ï¼‰
- å¦‚æœåªè®¾ç½®äº†å‚¨å€¼ä½™é¢ï¼Œæœªè®¾ç½® `clearGrants` å’Œèµ é€ä½™é¢å­—æ®µï¼Œ**é»˜è®¤è‡ªåŠ¨æ¸…é›¶èµ é€ä½™é¢**
- è¿™æ ·ç®¡ç†å‘˜è®¾ç½®ä½™é¢æ—¶ï¼Œæ€»ä½™é¢å°±ç­‰äºè®¾ç½®çš„å‚¨å€¼ä½™é¢

**é€»è¾‘**ï¼š
```typescript
// å¦‚æœåªè®¾ç½®äº†å‚¨å€¼ä½™é¢ï¼Œæ²¡æœ‰æ˜¾å¼è®¾ç½® clearGrantsï¼Œé»˜è®¤æ¸…é›¶èµ é€ä½™é¢
const shouldClearGrants = clearGrants !== undefined 
  ? clearGrants 
  : (dailyCoinsGrant === undefined && activityCoinsGrant === undefined);
```

### 2. ä¿®å¤æ§åˆ¶å™¨é€»è¾‘

**æ–‡ä»¶**: `src/controllers/admin.controller.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- ä¿®å¤ `finalClearGrants || false` çš„é€»è¾‘é—®é¢˜
- å¦‚æœ `clearGrants` æœªæä¾›ï¼Œä¼ é€’ `undefined` ç»™æœåŠ¡å±‚ï¼Œè®©æœåŠ¡å±‚è‡ªåŠ¨åˆ¤æ–­

## ğŸ“‹ æ¥å£å¯¹æ¯”

### è°ƒæ•´ä½™é¢æ¥å£ï¼ˆæ—§ï¼‰

**æ¥å£**: `PUT /api/admin/users/:userId/coins`

**åŠŸèƒ½**: åœ¨ç°æœ‰ä½™é¢åŸºç¡€ä¸Šå¢åŠ æˆ–å‡å°‘

**å‚æ•°**:
```json
{
  "adjustmentAmount": 100  // è°ƒæ•´é‡‘é¢ï¼ˆæ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰
}
```

**é—®é¢˜**: 
- âŒ åªè°ƒæ•´å‚¨å€¼ä½™é¢
- âŒ ä¸ä¼šæ¸…é›¶èµ é€ä½™é¢
- âŒ å¯¼è‡´æ€»ä½™é¢ = è®¾ç½®çš„ä½™é¢ + èµ é€ä½™é¢

### è®¾ç½®ä½™é¢æ¥å£ï¼ˆæ–°ï¼‰

**æ¥å£**: `PUT /api/admin/users/:userId/coins/set`

**åŠŸèƒ½**: ç›´æ¥è®¾ç½®ä½™é¢ä¸ºæŒ‡å®šå€¼

**å‚æ•°**:
```json
{
  "tianjiCoinsBalance": 1000  // å‚¨å€¼ä½™é¢ï¼ˆå¿…å¡«ï¼‰
  // clearGrants æœªæä¾›æ—¶ï¼Œè‡ªåŠ¨æ¸…é›¶èµ é€ä½™é¢
}
```

**ä¼˜åŠ¿**:
- âœ… ç›´æ¥è®¾ç½®ä½™é¢ä¸ºæŒ‡å®šå€¼
- âœ… é»˜è®¤è‡ªåŠ¨æ¸…é›¶èµ é€ä½™é¢
- âœ… æ€»ä½™é¢ = è®¾ç½®çš„å‚¨å€¼ä½™é¢

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•è®¾ç½®ä½™é¢æ¥å£ï¼ˆè‡ªåŠ¨æ¸…é›¶èµ é€ä½™é¢ï¼‰

```bash
PUT /api/admin/users/{userId}/coins/set
Body: {
  "tianjiCoinsBalance": 1000
}
```

**é¢„æœŸç»“æœ**ï¼š
- æ•°æ®åº“ï¼š`tianji_coins_balance = 1000`, `daily_coins_grant = 0`, `activity_coins_grant = 0`
- å‰ç«¯æ˜¾ç¤ºï¼šæ€»ä½™é¢ = 1000 âœ…

### 2. éªŒè¯æ•°æ®åº“

```sql
SELECT 
  tianji_coins_balance,
  daily_coins_grant,
  activity_coins_grant,
  (tianji_coins_balance + daily_coins_grant + activity_coins_grant) AS total_balance
FROM profiles
WHERE id = 'ç”¨æˆ·ID';
```

**é¢„æœŸç»“æœ**ï¼š
```
tianji_coins_balance: 1000
daily_coins_grant: 0
activity_coins_grant: 0
total_balance: 1000
```

### 3. éªŒè¯å‰ç«¯æ˜¾ç¤º

åˆ·æ–°å‰ç«¯é¡µé¢ï¼Œæ£€æŸ¥ï¼š
- é¡¶ç«¯å¯¼èˆªæ æ˜¾ç¤ºï¼š1000 âœ…
- ç”¨æˆ·ä¸ªäººé¡µé¢æ˜¾ç¤ºï¼šæ€»ä½™é¢ = 1000 âœ…

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç®¡ç†å‘˜é¡µé¢éœ€è¦æ›´æ–°**ï¼šå¦‚æœç®¡ç†å‘˜é¡µé¢ä½¿ç”¨çš„æ˜¯æ—§çš„"è°ƒæ•´ä½™é¢"æ¥å£ï¼Œéœ€è¦æ”¹ä¸ºä½¿ç”¨æ–°çš„"è®¾ç½®ä½™é¢"æ¥å£
2. **é»˜è®¤è¡Œä¸º**ï¼šå¦‚æœåªè®¾ç½®å‚¨å€¼ä½™é¢ï¼Œä¸ä¼ é€’ `clearGrants`ï¼Œæ¥å£ä¼šè‡ªåŠ¨æ¸…é›¶èµ é€ä½™é¢
3. **ä¿ç•™èµ é€ä½™é¢**ï¼šå¦‚æœéœ€è¦ä¿ç•™èµ é€ä½™é¢ï¼Œéœ€è¦æ˜¾å¼è®¾ç½® `clearGrants: false`

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `src/services/coins.service.ts` - ä½™é¢è®¾ç½®æœåŠ¡å®ç°
- `src/services/admin.service.ts` - ç®¡ç†å‘˜æœåŠ¡åŒ…è£…
- `src/controllers/admin.controller.ts` - ç®¡ç†å‘˜æ§åˆ¶å™¨
- `src/routes/admin.routes.ts` - ç®¡ç†å‘˜è·¯ç”±é…ç½®
- `ä½™é¢è®¾ç½®APIè¯´æ˜.md` - API ä½¿ç”¨æ–‡æ¡£

## ğŸ”— ç›¸å…³æ¥å£

- `PUT /api/admin/users/:userId/coins` - è°ƒæ•´ä½™é¢æ¥å£ï¼ˆæ—§ï¼‰
- `PUT /api/admin/users/:userId/coins/set` - è®¾ç½®ä½™é¢æ¥å£ï¼ˆæ–°ï¼Œæ¨èï¼‰
- `GET /api/coins/balance` - æŸ¥è¯¢ä½™é¢æ¥å£
