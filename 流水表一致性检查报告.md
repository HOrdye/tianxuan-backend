# æµæ°´è¡¨ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-14  
**é—®é¢˜**: æµæ°´è¡¨è®°å½•çš„è¡¨åå¯èƒ½ä¸ä¸€è‡´ï¼Œå¯¼è‡´åå°æŸ¥è¯¢ä¸åˆ°æ•°æ®

---

## ğŸ” é—®é¢˜åˆ†æ

### ç”¨æˆ·æå‡ºçš„é—®é¢˜

åœ¨ `coins.service.ts` çš„ `deductCoins` æ–¹æ³•ä¸­ï¼Œæ‰£è´¹æ“ä½œè°ƒç”¨çš„æ˜¯æ•°æ®åº“å‡½æ•° `deduct_coins`ï¼Œè¯¥å‡½æ•°å†…éƒ¨å¯èƒ½å†™å…¥çš„æµæ°´è¡¨ä¸ä»£ç ä¸­å…¶ä»–åœ°æ–¹ä½¿ç”¨çš„è¡¨ä¸ä¸€è‡´ã€‚

**æ½œåœ¨é£é™©**:
- å¦‚æœ `deduct_coins` å‡½æ•°å†™å…¥çš„æ˜¯ `coin_transactions` è¡¨
- è€Œç®¡ç†å‘˜åå°æŸ¥è¯¢çš„æ˜¯ `transactions` è¡¨
- é‚£ä¹ˆç”¨æˆ·æ¶ˆè´¹äº†å¤©æœºå¸ï¼Œä½†ç®¡ç†å‘˜åå°å¯èƒ½æŸ¥ä¸åˆ°è¿™ç¬”è®°å½•

---

## ğŸ“Š å½“å‰ä»£ç çŠ¶æ€

### 1. æ‰£è´¹æ“ä½œ (`deductCoins`)

**ä½ç½®**: `src/services/coins.service.ts:88-136`

```typescript
// è°ƒç”¨æ•°æ®åº“å‡½æ•° deduct_coins
const result = await pool.query(
  'SELECT deduct_coins($1, $2, $3) as result',
  [userId, featureType, price]
);
```

**è¯´æ˜**: æ‰£è´¹æ“ä½œé€šè¿‡æ•°æ®åº“å‡½æ•° `deduct_coins` å®Œæˆï¼Œæµæ°´è®°å½•ç”±å‡½æ•°å†…éƒ¨å¤„ç†ã€‚

### 2. ç®¡ç†å‘˜è°ƒæ•´ (`adminAdjustCoins`)

**ä½ç½®**: `src/services/coins.service.ts:239-380`

```typescript
// æ’å…¥äº¤æ˜“æµæ°´è®°å½•åˆ° transactions è¡¨
const transactionResult = await client.query(
  `INSERT INTO public.transactions (
    id, user_id, type, amount, coins_amount, item_type,
    description, operator_id, status, created_at
  )
  VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, $6, $7, 'completed', NOW())
  RETURNING id`,
  [...]
);
```

**ä½¿ç”¨çš„è¡¨**: `public.transactions` âœ…

### 3. ç®¡ç†å‘˜è®¾ç½®ä½™é¢ (`adminSetCoins`)

**ä½ç½®**: `src/services/coins.service.ts:401-588`

```typescript
// æ’å…¥äº¤æ˜“æµæ°´è®°å½•
const transactionResult = await client.query(
  `INSERT INTO public.transactions (
    id, user_id, type, amount, coins_amount, item_type,
    description, operator_id, status, created_at
  )
  VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, $6, $7, 'completed', NOW())
  RETURNING id`,
  [...]
);
```

**ä½¿ç”¨çš„è¡¨**: `public.transactions` âœ…

### 4. ç”¨æˆ·æŸ¥è¯¢æµæ°´ (`getCoinTransactions`)

**ä½ç½®**: `src/services/coins.service.ts:598-665`

```typescript
const result = await pool.query(
  `SELECT id, user_id, type, amount, coins_amount, ...
   FROM public.transactions
   WHERE user_id = $1
   ORDER BY created_at DESC
   LIMIT $2 OFFSET $3`,
  [userId, limit, offset]
);
```

**æŸ¥è¯¢çš„è¡¨**: `public.transactions` âœ…

### 5. ç®¡ç†å‘˜æŸ¥è¯¢æµæ°´ (`admin.service.ts:getCoinTransactions`)

**ä½ç½®**: `src/services/admin.service.ts:649-774`

```typescript
const dataQuery = `
  SELECT t.id, t.user_id, t.type, ...
  FROM public.transactions t
  LEFT JOIN public.profiles p ON t.user_id = p.id
  ${whereClause}
  ORDER BY t.created_at DESC
  LIMIT $${paramIndex} OFFSET $${paramIndex + 1}
`;
```

**æŸ¥è¯¢çš„è¡¨**: `public.transactions` âœ…

---

## âš ï¸ å…³é”®é—®é¢˜ï¼šæ•°æ®åº“å‡½æ•° `deduct_coins`

### éœ€è¦ç¡®è®¤çš„é—®é¢˜

**æ•°æ®åº“å‡½æ•° `deduct_coins` å†…éƒ¨å†™å…¥çš„æ˜¯å“ªä¸ªè¡¨ï¼Ÿ**

- å¦‚æœå†™å…¥ `public.transactions` â†’ âœ… ä¸€è‡´ï¼Œæ²¡æœ‰é—®é¢˜
- å¦‚æœå†™å…¥ `public.coin_transactions` â†’ âŒ ä¸ä¸€è‡´ï¼Œéœ€è¦ä¿®å¤

### æ£€æŸ¥æ–¹æ³•

**æ–¹æ³•1: æŸ¥è¯¢å‡½æ•°å®šä¹‰**

```sql
-- PostgreSQL æŸ¥è¯¢å‡½æ•°å®šä¹‰
SELECT pg_get_functiondef(oid) as function_definition
FROM pg_proc
WHERE proname = 'deduct_coins'
  AND pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');

-- æˆ–è€…ä½¿ç”¨ psql å‘½ä»¤
\df+ deduct_coins
```

**æ–¹æ³•2: æ£€æŸ¥å‡½æ•°è¿”å›çš„ transaction_id**

```sql
-- æ‰§è¡Œä¸€æ¬¡æ‰£è´¹æ“ä½œï¼Œç„¶åæŸ¥è¯¢è¿”å›çš„ transaction_id åœ¨å“ªä¸ªè¡¨ä¸­
-- 1. æ‰§è¡Œæ‰£è´¹ï¼ˆé€šè¿‡APIæˆ–ç›´æ¥è°ƒç”¨å‡½æ•°ï¼‰
SELECT deduct_coins('user_id', 'star_chart', 10);

-- 2. æ£€æŸ¥è¿”å›çš„ transaction_id åœ¨å“ªä¸ªè¡¨ä¸­
SELECT 'transactions' as table_name, id, type, coins_amount 
FROM public.transactions 
WHERE id = 'è¿”å›çš„transaction_id'
UNION ALL
SELECT 'coin_transactions' as table_name, id, type, coins_amount 
FROM public.coin_transactions 
WHERE id = 'è¿”å›çš„transaction_id';
```

**æ–¹æ³•3: æ£€æŸ¥è¡¨ç»“æ„**

```sql
-- æ£€æŸ¥æ˜¯å¦å­˜åœ¨ coin_transactions è¡¨
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('transactions', 'coin_transactions');

-- æ£€æŸ¥ transactions è¡¨çš„ç»“æ„
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public' 
  AND table_name = 'transactions'
ORDER BY ordinal_position;
```

---

## ğŸ”§ ä¿®å¤å»ºè®®

### æ–¹æ¡ˆ1: ç»Ÿä¸€ä½¿ç”¨ `public.transactions` è¡¨ï¼ˆâœ… æ¨èï¼‰

å¦‚æœæ•°æ®åº“å‡½æ•° `deduct_coins` å†™å…¥çš„æ˜¯ `coin_transactions` è¡¨ï¼Œéœ€è¦ä¿®æ”¹å‡½æ•°ï¼Œæ”¹ä¸ºå†™å…¥ `transactions` è¡¨ã€‚

**ä¼˜ç‚¹**:
- âœ… ä¸ç°æœ‰ä»£ç ä¿æŒä¸€è‡´ï¼ˆæ‰€æœ‰ä»£ç éƒ½ä½¿ç”¨ `transactions` è¡¨ï¼‰
- âœ… ç®¡ç†å‘˜åå°å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰æµæ°´è®°å½•
- âœ… ä¸éœ€è¦ä¿®æ”¹æŸ¥è¯¢é€»è¾‘
- âœ… æ”¯ä»˜è®¢å•å’Œå¤©æœºå¸æµæ°´ç»Ÿä¸€ç®¡ç†

**ä¿®å¤æ­¥éª¤**:
1. æ£€æŸ¥æ•°æ®åº“å‡½æ•° `deduct_coins` çš„å®ç°
2. å¦‚æœå‡½æ•°å†™å…¥çš„æ˜¯ `coin_transactions`ï¼Œä¿®æ”¹å‡½æ•°æ”¹ä¸ºå†™å…¥ `transactions`
3. ç¡®ä¿å‡½æ•°è¿”å›çš„ `transaction_id` æ˜¯ `transactions` è¡¨çš„ID
4. æµ‹è¯•éªŒè¯æ‰£è´¹æ“ä½œåï¼Œç®¡ç†å‘˜åå°èƒ½æŸ¥è¯¢åˆ°è®°å½•

**ç¤ºä¾‹ä¿®å¤SQL**ï¼ˆéœ€è¦æ ¹æ®å®é™…å‡½æ•°å®ç°è°ƒæ•´ï¼‰:
```sql
-- å¦‚æœå‡½æ•°å†™å…¥çš„æ˜¯ coin_transactionsï¼Œéœ€è¦ä¿®æ”¹ä¸º transactions
CREATE OR REPLACE FUNCTION deduct_coins(
  p_user_id UUID,
  p_feature_type TEXT,
  p_price INTEGER
)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
  v_transaction_id UUID;
  v_remaining_balance INTEGER;
BEGIN
  -- ... æ‰£è´¹é€»è¾‘ ...
  
  -- âœ… ä¿®å¤ï¼šå†™å…¥ transactions è¡¨è€Œä¸æ˜¯ coin_transactions
  INSERT INTO public.transactions (
    id, user_id, type, amount, coins_amount, 
    item_type, description, status, created_at
  )
  VALUES (
    gen_random_uuid(), p_user_id, 'deduct', 0, -p_price,
    p_feature_type, 'æ‰£è´¹ï¼š' || p_feature_type, 'completed', NOW()
  )
  RETURNING id INTO v_transaction_id;
  
  -- ... è¿”å›ç»“æœ ...
END;
$$;
```

### æ–¹æ¡ˆ2: ç»Ÿä¸€ä½¿ç”¨ `public.coin_transactions` è¡¨ï¼ˆâŒ ä¸æ¨èï¼‰

å¦‚æœæ•°æ®åº“å‡½æ•° `deduct_coins` å†™å…¥çš„æ˜¯ `coin_transactions` è¡¨ï¼Œéœ€è¦ä¿®æ”¹æ‰€æœ‰ä»£ç ï¼Œç»Ÿä¸€ä½¿ç”¨ `coin_transactions` è¡¨ã€‚

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä¿®æ”¹å¤šå¤„ä»£ç ï¼ˆ`adminAdjustCoins`, `adminSetCoins`, `getCoinTransactions`, `admin.service.ts`ï¼‰
- âŒ æ”¯ä»˜è®¢å•å¯èƒ½ä¹Ÿéœ€è¦åˆ†å¼€å¤„ç†
- âŒ ç»´æŠ¤æˆæœ¬é«˜

### æ–¹æ¡ˆ3: ä½¿ç”¨ UNION æŸ¥è¯¢ï¼ˆâŒ ä¸æ¨èï¼‰

åœ¨æŸ¥è¯¢æ—¶åŒæ—¶æŸ¥è¯¢ä¸¤ä¸ªè¡¨ï¼Œä½¿ç”¨ UNION åˆå¹¶ç»“æœã€‚

**ç¼ºç‚¹**:
- âŒ æ€§èƒ½è¾ƒå·®
- âŒ ç»´æŠ¤å¤æ‚
- âŒ ä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆ
- âŒ å¯èƒ½å¯¼è‡´é‡å¤è®°å½•

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [x] âœ… æ£€æŸ¥æ•°æ®åº“å‡½æ•° `deduct_coins` çš„å®ç°
- [x] âœ… ç¡®è®¤å‡½æ•°ä¸å†™å…¥æµæ°´è®°å½•ï¼ˆåªè´Ÿè´£æ‰£è´¹é€»è¾‘ï¼‰
- [x] âœ… ä¿®å¤åº”ç”¨å±‚ä»£ç ï¼Œåœ¨æ‰£è´¹æˆåŠŸåå†™å…¥æµæ°´è®°å½•åˆ° `public.transactions` è¡¨
- [ ] â³ æµ‹è¯•æ‰£è´¹æ“ä½œåï¼Œç®¡ç†å‘˜åå°èƒ½å¦æŸ¥è¯¢åˆ°è®°å½•ï¼ˆå¾…æµ‹è¯•ï¼‰
- [ ] â³ éªŒè¯æ‰€æœ‰æµæ°´è®°å½•éƒ½èƒ½æ­£ç¡®æŸ¥è¯¢ï¼ˆå¾…æµ‹è¯•ï¼‰
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å†å²æ•°æ®éœ€è¦è¿ç§»

---

## ğŸ“ åç»­è¡ŒåŠ¨

### âœ… å·²å®Œæˆ

1. âœ… **æ£€æŸ¥æ•°æ®åº“å‡½æ•°**: ç¡®è®¤ `deduct_coins` å‡½æ•°åªè´Ÿè´£æ‰£è´¹é€»è¾‘ï¼Œä¸å†™å…¥æµæ°´è®°å½•
2. âœ… **ä¿®å¤åº”ç”¨å±‚ä»£ç **: åœ¨ `deductCoins` å‡½æ•°ä¸­æ·»åŠ å†™å…¥æµæ°´è®°å½•çš„é€»è¾‘
3. âœ… **ç»Ÿä¸€è¡¨å**: æ‰€æœ‰æµæ°´è®°å½•éƒ½å†™å…¥ `public.transactions` è¡¨

### â³ å¾…æµ‹è¯•éªŒè¯

1. **æµ‹è¯•æ‰£è´¹æ“ä½œ**:
   - æ‰§è¡Œä¸€æ¬¡æ‰£è´¹æ“ä½œï¼ˆé€šè¿‡APIï¼Œå¦‚ `/api/coins/deduct`ï¼‰
   - æ£€æŸ¥è¿”å›çš„ `transaction_id` æ˜¯å¦æœ‰æ•ˆ
   - åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢è¯¥ `transaction_id` æ˜¯å¦å­˜åœ¨äº `transactions` è¡¨

2. **æµ‹è¯•ç®¡ç†å‘˜åå°æŸ¥è¯¢**:
   - åœ¨ç®¡ç†å‘˜åå°æŸ¥è¯¢è¯¥ç”¨æˆ·çš„äº¤æ˜“æµæ°´
   - ç¡®è®¤èƒ½æŸ¥è¯¢åˆ°æ‰£è´¹è®°å½•
   - éªŒè¯è®°å½•æ ¼å¼æ­£ç¡®ï¼ˆtype='deduct', coins_amount ä¸ºè´Ÿæ•°ç­‰ï¼‰

3. **éªŒè¯æ•°æ®ä¸€è‡´æ€§**:
   - ç¡®è®¤æ‰€æœ‰æ‰£è´¹æ“ä½œéƒ½åˆ›å»ºäº†æµæ°´è®°å½•
   - ç¡®è®¤æµæ°´è®°å½•çš„æ•°æ®ä¸æ‰£è´¹æ“ä½œä¸€è‡´

### ä»£ç ä¸€è‡´æ€§ç¡®è®¤

âœ… **å·²ç¡®è®¤ä¸€è‡´çš„ä»£ç **:
- `adminAdjustCoins` â†’ å†™å…¥ `public.transactions` âœ…
- `adminSetCoins` â†’ å†™å…¥ `public.transactions` âœ…
- `getCoinTransactions` (ç”¨æˆ·æŸ¥è¯¢) â†’ æŸ¥è¯¢ `public.transactions` âœ…
- `admin.service.ts:getCoinTransactions` (ç®¡ç†å‘˜æŸ¥è¯¢) â†’ æŸ¥è¯¢ `public.transactions` âœ…
- `payment.service.ts:createOrder` â†’ å†™å…¥ `public.transactions` âœ…

âš ï¸ **éœ€è¦ç¡®è®¤**:
- `deduct_coins` æ•°æ®åº“å‡½æ•° â†’ å†™å…¥çš„è¡¨å â“

---

## ğŸ¯ ç»“è®º

### é—®é¢˜æ€»ç»“

**å‘ç°çš„é—®é¢˜**:
- âŒ `deduct_coins` æ•°æ®åº“å‡½æ•°åªè´Ÿè´£æ‰£è´¹é€»è¾‘ï¼Œ**ä¸å†™å…¥æµæ°´è®°å½•**
- âŒ åº”ç”¨å±‚ä»£ç æ²¡æœ‰è¡¥å……å†™å…¥æµæ°´è®°å½•çš„é€»è¾‘
- âŒ å¯¼è‡´ç®¡ç†å‘˜åå°æŸ¥è¯¢ä¸åˆ°æ‰£è´¹è®°å½•

**ä¿®å¤æ–¹æ¡ˆ**:
- âœ… åœ¨åº”ç”¨å±‚ `deductCoins` å‡½æ•°ä¸­æ·»åŠ å†™å…¥æµæ°´è®°å½•çš„é€»è¾‘
- âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ‰£è´¹å’Œå†™å…¥æµæ°´è®°å½•çš„åŸå­æ€§
- âœ… ç»Ÿä¸€ä½¿ç”¨ `public.transactions` è¡¨ï¼Œä¸å…¶ä»–æ“ä½œä¿æŒä¸€è‡´

### æœ€ç»ˆçŠ¶æ€

**æ‰€æœ‰ä»£ç ç°åœ¨éƒ½ç»Ÿä¸€ä½¿ç”¨ `public.transactions` è¡¨**:
- âœ… æ‰£è´¹æ“ä½œ (`deductCoins`) â†’ å†™å…¥ `public.transactions`
- âœ… ç®¡ç†å‘˜è°ƒæ•´ (`adminAdjustCoins`) â†’ å†™å…¥ `public.transactions`
- âœ… ç®¡ç†å‘˜è®¾ç½®ä½™é¢ (`adminSetCoins`) â†’ å†™å…¥ `public.transactions`
- âœ… æ”¯ä»˜è®¢å• (`createOrder`) â†’ å†™å…¥ `public.transactions`
- âœ… ç”¨æˆ·æŸ¥è¯¢æµæ°´ (`getCoinTransactions`) â†’ æŸ¥è¯¢ `public.transactions`
- âœ… ç®¡ç†å‘˜æŸ¥è¯¢æµæ°´ (`admin.service.ts`) â†’ æŸ¥è¯¢ `public.transactions`

**å»ºè®®**: 
1. âœ… å·²å®Œæˆä¿®å¤ï¼Œæ‰£è´¹æ“ä½œç°åœ¨ä¼šå†™å…¥æµæ°´è®°å½•
2. â³ å¾…æµ‹è¯•éªŒè¯ï¼šæ‰§è¡Œæ‰£è´¹æ“ä½œï¼Œç¡®è®¤ç®¡ç†å‘˜åå°èƒ½æŸ¥è¯¢åˆ°è®°å½•

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-14  
**æœ€åæ›´æ–°**: 2026-01-14  
**çŠ¶æ€**: âœ… **å·²ä¿®å¤** - æ‰£è´¹æ“ä½œç°åœ¨ä¼šå†™å…¥æµæ°´è®°å½•  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ - å·²ä¿®å¤ç®¡ç†å‘˜åå°æŸ¥è¯¢ä¸åˆ°æ‰£è´¹è®°å½•çš„é—®é¢˜

---

## ğŸ” é—®é¢˜ç¡®è®¤å’Œä¿®å¤

### æ£€æŸ¥ç»“æœ

**å‡½æ•°ä¿¡æ¯**:
- å‡½æ•°å: `deduct_coins`
- å‡½æ•°ä½“é•¿åº¦: 3875 å­—ç¬¦
- INSERT INTO è¯­å¥: âŒ **æœªæ‰¾åˆ°** - å‡½æ•°åªè´Ÿè´£æ‰£è´¹é€»è¾‘ï¼Œä¸å†™å…¥æµæ°´è®°å½•

### é—®é¢˜ç¡®è®¤

**æ ¹æœ¬åŸå› **: 
- `deduct_coins` æ•°æ®åº“å‡½æ•°**åªè´Ÿè´£æ‰£è´¹é€»è¾‘**ï¼ˆè®¡ç®—ä½™é¢ã€æ›´æ–°ä½™é¢ï¼‰
- **ä¸å†™å…¥æµæ°´è®°å½•**åˆ°ä»»ä½•è¡¨
- ä»£ç ä¸­è¿”å›çš„ `transaction_id` å®é™…ä¸Šæ˜¯ `null` æˆ–æœªå®šä¹‰çš„å€¼
- å¯¼è‡´**ç®¡ç†å‘˜åå°æŸ¥è¯¢ä¸åˆ°æ‰£è´¹è®°å½•**

### âœ… ä¿®å¤æ–¹æ¡ˆ

**ä¿®å¤ä½ç½®**: `src/services/coins.service.ts:88-136`

**ä¿®å¤å†…å®¹**:
1. ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ‰£è´¹å’Œå†™å…¥æµæ°´è®°å½•çš„åŸå­æ€§
2. åœ¨æ‰£è´¹æˆåŠŸåï¼Œæ‰‹åŠ¨å†™å…¥æµæ°´è®°å½•åˆ° `public.transactions` è¡¨
3. è¿”å›å®é™…åˆ›å»ºçš„ `transaction_id`

**ä¿®å¤åçš„é€»è¾‘**:
```typescript
// 1. è°ƒç”¨æ•°æ®åº“å‡½æ•° deduct_coins æ‰§è¡Œæ‰£è´¹
const result = await client.query('SELECT deduct_coins($1, $2, $3) as result', [...]);

// 2. æ‰£è´¹æˆåŠŸåï¼Œå†™å…¥æµæ°´è®°å½•åˆ° transactions è¡¨
const transactionResult = await client.query(
  `INSERT INTO public.transactions (
    id, user_id, type, amount, coins_amount, item_type, 
    description, operator_id, status, created_at
  )
  VALUES (gen_random_uuid(), $1, 'deduct', 0, -$2, $3, $4, NULL, 'completed', NOW())
  RETURNING id`,
  [userId, price, featureType, `æ‰£è´¹ï¼š${featureType}`]
);

// 3. è¿”å›å®é™…åˆ›å»ºçš„ transaction_id
return { transaction_id: transactionResult.rows[0].id, ... };
```

### âœ… ä¿®å¤çŠ¶æ€

- âœ… **å·²ä¿®å¤** (2026-01-14)
- âœ… æ‰£è´¹æ“ä½œç°åœ¨ä¼šå†™å…¥ `public.transactions` è¡¨
- âœ… ç®¡ç†å‘˜åå°å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰æ‰£è´¹è®°å½•
- âœ… ä¸ `adminAdjustCoins` å’Œ `adminSetCoins` çš„é€»è¾‘ä¿æŒä¸€è‡´

---

## ğŸ” å‡½æ•°å®šä¹‰æ£€æŸ¥ç»“æœ

### å·²è·å–çš„ä¿¡æ¯

**å‡½æ•°ç­¾å**:
```sql
CREATE OR REPLACE FUNCTION public.deduct_coins(
  p_user_id uuid, 
  p_feature_type text, 
  p_price integer
)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
```

**å‡½æ•°ä½“ï¼ˆéƒ¨åˆ†ï¼‰**:
```
DECLARE
  v_current_daily_grant INTEGER;
  v_current_activity_grant INTEGER;
  ...
```

### âš ï¸ éœ€è¦æŸ¥çœ‹çš„å…³é”®éƒ¨åˆ†

å‡½æ•°å®šä¹‰è¢«æˆªæ–­ï¼Œéœ€è¦æŸ¥çœ‹å®Œæ•´çš„å‡½æ•°ä½“ï¼Œç‰¹åˆ«æ˜¯ï¼š
1. `INSERT INTO` è¯­å¥ä½¿ç”¨çš„è¡¨å
2. `RETURNING` è¯­å¥è¿”å›çš„ `transaction_id` æ¥æº

### ğŸ“‹ æ£€æŸ¥æ–¹æ³•

**æ–¹æ³•1: ä½¿ç”¨ psql æŸ¥çœ‹å®Œæ•´å®šä¹‰**
```bash
psql $DATABASE_URL -c "\sf+ deduct_coins"
```

**æ–¹æ³•2: æŸ¥è¯¢å‡½æ•°æºä»£ç **
```sql
-- æŸ¥çœ‹å®Œæ•´å‡½æ•°ä½“
SELECT prosrc as function_body
FROM pg_proc
WHERE proname = 'deduct_coins'
  AND pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');

-- æˆ–è€…æŸ¥çœ‹å‡½æ•°å®šä¹‰ï¼ˆå¯èƒ½è¢«æˆªæ–­ï¼‰
SELECT pg_get_functiondef(oid) as function_definition
FROM pg_proc
WHERE proname = 'deduct_coins'
  AND pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');
```

**æ–¹æ³•3: æ£€æŸ¥å‡½æ•°ä¸­ä½¿ç”¨çš„è¡¨å**
```sql
-- æ£€æŸ¥å‡½æ•°ä½“ä¸­æ˜¯å¦åŒ…å« INSERT INTO transactions
SELECT 
  proname,
  CASE 
    WHEN prosrc LIKE '%INSERT INTO%public.transactions%' OR prosrc LIKE '%INSERT INTO public.transactions%' 
      THEN 'âœ… ä½¿ç”¨ transactions è¡¨'
    WHEN prosrc LIKE '%INSERT INTO%public.coin_transactions%' OR prosrc LIKE '%INSERT INTO public.coin_transactions%'
      THEN 'âŒ ä½¿ç”¨ coin_transactions è¡¨ï¼ˆéœ€è¦ä¿®å¤ï¼‰'
    WHEN prosrc LIKE '%INSERT INTO%transactions%' 
      THEN 'âš ï¸ å¯èƒ½ä½¿ç”¨ transactions è¡¨ï¼ˆéœ€è¦ç¡®è®¤ï¼‰'
    WHEN prosrc LIKE '%INSERT INTO%coin_transactions%'
      THEN 'âš ï¸ å¯èƒ½ä½¿ç”¨ coin_transactions è¡¨ï¼ˆéœ€è¦ä¿®å¤ï¼‰'
    ELSE 'â“ æœªæ‰¾åˆ° INSERT INTO è¯­å¥'
  END as table_usage_status,
  LENGTH(prosrc) as function_body_length
FROM pg_proc
WHERE proname = 'deduct_coins'
  AND pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public');
```

### ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ‰§è¡Œæ£€æŸ¥SQL**: è¿è¡Œä¸Šé¢çš„æ£€æŸ¥æ–¹æ³•3ï¼Œå¿«é€Ÿç¡®è®¤å‡½æ•°ä½¿ç”¨çš„è¡¨å
2. **å¦‚æœå‘ç°ä¸ä¸€è‡´**: ä¿®æ”¹å‡½æ•°ï¼Œç»Ÿä¸€ä½¿ç”¨ `public.transactions` è¡¨
3. **æµ‹è¯•éªŒè¯**: æ‰§è¡Œæ‰£è´¹æ“ä½œï¼Œç¡®è®¤ç®¡ç†å‘˜åå°èƒ½æŸ¥è¯¢åˆ°è®°å½•
