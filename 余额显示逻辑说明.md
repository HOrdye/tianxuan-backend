# ä½™é¢æ˜¾ç¤ºé€»è¾‘è¯´æ˜

## ğŸ“‹ ä½™é¢åˆ†ç±»

æ ¹æ®æ–°çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä½™é¢åˆ†ä¸ºä¸¤ç±»ï¼š

### 1. å¢å¸ï¼ˆBonus Coinsï¼‰
- **æ¥æº**ï¼šæ¯æ—¥ç­¾åˆ°æ‰€å¾—
- **å­—æ®µ**ï¼š`daily_coins_grant`
- **æœ‰æ•ˆæœŸ**ï¼š30å¤©ï¼ˆ`daily_coins_grant_expires_at`ï¼‰
- **ç‰¹ç‚¹**ï¼šæœ‰æœ‰æ•ˆæœŸé™åˆ¶

### 2. å¤©æœºå¸ï¼ˆTianji Coinsï¼‰
- **ç»„æˆ**ï¼šæ´»åŠ¨èµ é€ä½™é¢ + å……å€¼ä½™é¢
- **å­—æ®µ**ï¼š`activity_coins_grant` + `tianji_coins_balance`
- **æœ‰æ•ˆæœŸ**ï¼šæ— é™åˆ¶ï¼ˆå……å€¼ä½™é¢æ°¸ä¹…æœ‰æ•ˆï¼‰
- **ç‰¹ç‚¹**ï¼šä¸å……å€¼ä½™é¢åœ¨ä½¿ç”¨æ—¶æ— åŒºåˆ«

## ğŸ”¢ ä½™é¢è®¡ç®—å…¬å¼

```typescript
// å¢å¸ = æ¯æ—¥ç­¾åˆ°ä½™é¢
bonus_coins = daily_coins_grant

// å¤©æœºå¸ = æ´»åŠ¨èµ é€ä½™é¢ + å……å€¼ä½™é¢
tianji_coins = activity_coins_grant + tianji_coins_balance

// æ€»ä½™é¢ = å¢å¸ + å¤©æœºå¸
total_balance = bonus_coins + tianji_coins
```

## ğŸ“Š API å“åº”æ ¼å¼

### GET /api/coins/balance

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    // åŸå§‹å­—æ®µï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
    "tianji_coins_balance": 2500,
    "daily_coins_grant": 949,
    "activity_coins_grant": 0,
    "daily_coins_grant_expires_at": "2025-02-14T00:00:00Z",
    "activity_coins_grant_expires_at": null,
    
    // æ–°å¢è®¡ç®—å­—æ®µï¼ˆæ¨èä½¿ç”¨ï¼‰
    "bonus_coins": 949,        // å¢å¸ï¼ˆæ¯æ—¥ç­¾åˆ°ï¼‰
    "tianji_coins": 2500,      // å¤©æœºå¸ï¼ˆæ´»åŠ¨èµ é€ + å……å€¼ä½™é¢ï¼‰
    "total_balance": 3449      // æ€»ä½™é¢
  }
}
```

## ğŸ”§ ç®¡ç†å‘˜è®¾ç½®ä½™é¢é€»è¾‘

### PUT /api/admin/users/:userId/coins/set

**é»˜è®¤è¡Œä¸º**ï¼š
- è®¾ç½®å‚¨å€¼ä½™é¢ï¼ˆ`tianjiCoinsBalance`ï¼‰æ—¶ï¼Œ**é»˜è®¤æ¸…é›¶æ´»åŠ¨èµ é€ä½™é¢**ï¼ˆ`activity_coins_grant`ï¼‰
- **ä¿ç•™æ¯æ—¥ç­¾åˆ°ä½™é¢**ï¼ˆ`daily_coins_grant`ï¼‰ï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·é€šè¿‡ç­¾åˆ°è·å¾—çš„

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "tianjiCoinsBalance": 2500
}
```

**ç»“æœ**ï¼š
- `tianji_coins_balance` = 2500 âœ…
- `activity_coins_grant` = 0 âœ…ï¼ˆå·²æ¸…é›¶ï¼‰
- `daily_coins_grant` = 949ï¼ˆä¿æŒä¸å˜ï¼‰
- `bonus_coins` = 949
- `tianji_coins` = 2500
- `total_balance` = 3449

### é€‰é¡¹1ï¼šæ¸…é›¶æ‰€æœ‰èµ é€ä½™é¢

```json
{
  "tianjiCoinsBalance": 2500,
  "clearGrants": true
}
```

**ç»“æœ**ï¼š
- `tianji_coins_balance` = 2500
- `activity_coins_grant` = 0
- `daily_coins_grant` = 0ï¼ˆä¹Ÿè¢«æ¸…é›¶ï¼‰
- `bonus_coins` = 0
- `tianji_coins` = 2500
- `total_balance` = 2500

### é€‰é¡¹2ï¼šç²¾ç¡®è®¾ç½®æ‰€æœ‰ä½™é¢å­—æ®µ

```json
{
  "tianjiCoinsBalance": 2500,
  "dailyCoinsGrant": 0,
  "activityCoinsGrant": 0
}
```

**ç»“æœ**ï¼š
- `tianji_coins_balance` = 2500
- `activity_coins_grant` = 0
- `daily_coins_grant` = 0
- `bonus_coins` = 0
- `tianji_coins` = 2500
- `total_balance` = 2500

## ğŸ¯ å‰ç«¯æ˜¾ç¤ºå»ºè®®

### ç”¨æˆ·ç•Œé¢æ˜¾ç¤º

```
å¢å¸: 949ï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
å¤©æœºå¸: 2,500
æ€»ä½™é¢: 3,449
```

### æ•°æ®ç»“æ„

```typescript
interface BalanceDisplay {
  bonus_coins: number;      // å¢å¸ï¼ˆæ¯æ—¥ç­¾åˆ°ï¼‰
  tianji_coins: number;     // å¤©æœºå¸ï¼ˆæ´»åŠ¨èµ é€ + å……å€¼ä½™é¢ï¼‰
  total_balance: number;    // æ€»ä½™é¢
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¢å¸æœ‰æ•ˆæœŸ**ï¼š`daily_coins_grant` æœ‰30å¤©æœ‰æ•ˆæœŸï¼Œè¿‡æœŸåè‡ªåŠ¨æ¸…é›¶
2. **å¤©æœºå¸ç»„æˆ**ï¼šå¤©æœºå¸ = æ´»åŠ¨èµ é€ä½™é¢ + å……å€¼ä½™é¢ï¼Œä¸¤è€…åœ¨ä½¿ç”¨æ—¶æ— åŒºåˆ«
3. **è®¾ç½®ä½™é¢é»˜è®¤è¡Œä¸º**ï¼šè®¾ç½®å‚¨å€¼ä½™é¢æ—¶ï¼Œé»˜è®¤æ¸…é›¶æ´»åŠ¨èµ é€ä½™é¢ï¼Œä¿ç•™æ¯æ—¥ç­¾åˆ°ä½™é¢
4. **å…¼å®¹æ€§**ï¼šAPI åŒæ—¶è¿”å›åŸå§‹å­—æ®µå’Œè®¡ç®—å­—æ®µï¼Œå‰ç«¯å¯ä»¥é€‰æ‹©ä½¿ç”¨

## ğŸ”„ æ‰£è´¹é€»è¾‘

æ‰£è´¹æ—¶ï¼Œä¼˜å…ˆæ‰£é™¤ï¼š
1. å¢å¸ï¼ˆ`daily_coins_grant`ï¼‰- æœ‰æœ‰æ•ˆæœŸï¼Œä¼˜å…ˆä½¿ç”¨
2. å¤©æœºå¸ï¼ˆ`activity_coins_grant` + `tianji_coins_balance`ï¼‰- æ— æœ‰æ•ˆæœŸé™åˆ¶

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `src/services/coins.service.ts` - ä½™é¢æœåŠ¡å®ç°
- `src/controllers/coins.controller.ts` - ä½™é¢æ§åˆ¶å™¨
- `src/routes/coins.routes.ts` - ä½™é¢è·¯ç”±é…ç½®
