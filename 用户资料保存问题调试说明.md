# 用户资料保存问题调试说明

**创建时间**: 2026年1月10日  
**问题**: 用户更新资料后，数据没有真正保存到数据库

---

## 🔍 问题现象

1. 前端点击保存后，控制台显示成功
2. 但退出并重新进入编辑时，所有信息都没有保存
3. 进入紫微斗数生成命盘界面，也没有同步相关个人信息

---

## 🐛 已添加的调试日志

为了诊断问题，我已经在以下位置添加了详细的调试日志：

### 1. 控制器层 (`src/controllers/user.controller.ts`)

- `[updateProfile Controller] 接收到的请求数据` - 记录前端发送的原始数据
- `[updateProfile Controller] 用户ID` - 记录要更新的用户ID
- `[updateProfile Controller] 返回给前端的数据` - 记录返回给前端的数据

### 2. 服务层 (`src/services/user.service.ts`)

- `[updateProfile] 接收到的原始数据` - 记录接收到的原始数据
- `[updateProfile] 提取 user_metadata 中的字段` - 记录从 user_metadata 中提取的字段
- `[updateProfile] 处理后的数据` - 记录处理后的数据（提取 user_metadata 后）
- `[updateProfile] 要更新的字段` - 记录要执行的 SQL 更新字段
- `[updateProfile] 更新值` - 记录要更新的值
- `[updateProfile] 数据库更新后的数据` - 记录从数据库返回的更新后数据

---

## 📋 调试步骤

### 步骤 1：查看后端日志

当用户点击保存时，查看后端控制台输出，应该能看到以下日志序列：

```
[updateProfile Controller] 接收到的请求数据: { ... }
[updateProfile Controller] 用户ID: xxx
[updateProfile] 接收到的原始数据: { ... }
[updateProfile] 提取 user_metadata 中的字段: { ... }
[updateProfile] 处理后的数据: { ... }
[updateProfile] 要更新的字段: [ 'birthday = $1', 'updated_at = NOW()' ]
[updateProfile] 更新值: [ '1989-12-11' ]
[updateProfile] 数据库更新后的数据: { birthday: '1989-12-11', ... }
[updateProfile Controller] 返回给前端的数据: { ... }
```

### 步骤 2：检查关键点

#### 检查点 1：数据是否正确接收

查看 `[updateProfile Controller] 接收到的请求数据`，确认：
- 是否包含 `user_metadata` 对象？
- `user_metadata` 中是否包含 `birthday` 字段？
- `birthday` 的值是什么格式？

#### 检查点 2：数据是否正确提取

查看 `[updateProfile] 提取 user_metadata 中的字段`，确认：
- `birthday` 字段是否被正确提取？
- 提取后的值是什么？

#### 检查点 3：数据是否正确处理

查看 `[updateProfile] 处理后的数据`，确认：
- `birthday` 字段是否在顶层？
- 值是否正确？

#### 检查点 4：SQL 是否正确执行

查看 `[updateProfile] 要更新的字段` 和 `[updateProfile] 更新值`，确认：
- `birthday` 是否在更新字段列表中？
- 值是否正确？

#### 检查点 5：数据库是否正确保存

查看 `[updateProfile] 数据库更新后的数据`，确认：
- `birthday` 字段的值是什么？
- 是否与预期一致？

---

## 🔧 可能的问题和解决方案

### 问题 1：user_metadata 没有被提取

**现象**: `[updateProfile] 处理后的数据` 中没有 `birthday` 字段

**可能原因**:
- 前端发送的数据格式不正确
- `user_metadata` 对象为空或格式错误

**解决方案**:
- 检查前端发送的数据格式
- 确认 `user_metadata` 是一个对象，且包含 `birthday` 字段

### 问题 2：字段被跳过

**现象**: `[updateProfile] 要更新的字段` 中没有 `birthday`

**可能原因**:
- 字段名不在白名单中（但 `birthday` 应该在白名单中）
- 字段值被判断为 `undefined`（但 `null` 应该被保留）

**解决方案**:
- 检查字段名是否正确
- 确认值不是 `undefined`

### 问题 3：数据库更新失败

**现象**: `[updateProfile] 数据库更新后的数据` 中 `birthday` 仍然是旧值或 `null`

**可能原因**:
- SQL 执行失败但没有抛出错误
- 数据库约束问题
- 数据类型不匹配

**解决方案**:
- 检查数据库日志
- 确认 `birthday` 字段的数据类型（应该是 `DATE` 或 `TEXT`）
- 检查是否有数据库约束阻止更新

### 问题 4：返回数据格式问题

**现象**: `[updateProfile Controller] 返回给前端的数据` 中 `user_metadata.birthday` 缺失

**可能原因**:
- `formatProfileForFrontend` 函数有问题
- 数据库返回的数据格式不正确

**解决方案**:
- 检查 `formatProfileForFrontend` 函数
- 确认数据库返回的数据包含 `birthday` 字段

---

## 🧪 测试建议

### 测试 1：直接测试 API

使用 curl 或 Postman 直接测试 API：

```bash
PUT /api/user/profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "user_metadata": {
    "birthday": "1989-12-11"
  }
}
```

观察后端日志，确认数据流是否正确。

### 测试 2：检查数据库

直接查询数据库，确认数据是否保存：

```sql
SELECT id, username, birthday, gender, bio, location, updated_at
FROM public.profiles
WHERE id = '25115bfa-2b35-4dca-8aba-9c5abef2ef72';
```

### 测试 3：检查前端发送的数据

在前端代码中添加日志，确认发送的数据格式：

```typescript
console.log('发送的数据:', JSON.stringify(updateData, null, 2));
```

---

## 📝 下一步行动

1. **运行测试**：让用户再次尝试保存，查看后端日志
2. **收集日志**：将完整的后端日志发送给我
3. **检查数据库**：直接查询数据库，确认数据是否保存
4. **分析问题**：根据日志和数据库状态，确定问题所在

---

## 🔍 常见问题排查

### Q: 为什么日志中没有看到某些步骤？

A: 可能是：
- 代码执行到某个步骤时出错，但没有被捕获
- 某些条件判断导致代码跳过了某些步骤
- 日志级别设置问题

### Q: 数据格式应该是什么？

A: 
- 前端发送：`{ user_metadata: { birthday: "1989-12-11" } }`
- 后端处理：提取为 `{ birthday: "1989-12-11" }`
- 数据库存储：`birthday` 字段（DATE 或 TEXT 类型）
- 后端返回：`{ user_metadata: { birthday: "1989-12-11" } }`

### Q: 日期格式应该是什么？

A:
- 前端发送：`"1989-12-11"` (YYYY-MM-DD 格式)
- 数据库存储：PostgreSQL 的 DATE 类型会自动处理
- 后端返回：可能是 ISO 格式 `"1989-12-11T00:00:00.000Z"` 或 `"1989-12-11"`

---

**维护者**: 开发团队  
**最后更新**: 2026年1月10日
