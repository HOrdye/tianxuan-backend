# è¿åŠ¿ç”ŸæˆæœåŠ¡ä¿®å¤æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ11æ—¥  
**é—®é¢˜**: å‰ç«¯ `ZiweiFusionService` ä»ä½¿ç”¨ Supabaseï¼Œå¯¼è‡´è¿åŠ¿ç”Ÿæˆå¤±è´¥  
**çŠ¶æ€**: âœ… **åç«¯å·²å®ç°** - Fortune æ¨¡å—åç«¯ API å·²å®Œæˆå¼€å‘

---

## âœ… åç«¯å®ç°çŠ¶æ€

### Fortune æ¨¡å—ï¼ˆè¿åŠ¿ç¼“å­˜ï¼‰- å·²å®Œæˆ

**æ•°æ®åº“è¡¨**ï¼š
- âœ… `daily_fortune_caches` è¡¨å·²åˆ›å»ºï¼ˆSQL è¿ç§»æ–‡ä»¶ï¼š`scripts/migration-create-daily-fortune-caches-table.sql`ï¼‰

**åç«¯ API**ï¼š
- âœ… `GET /api/fortune/cache` - è·å–æ¯æ—¥è¿åŠ¿ç¼“å­˜
- âœ… `POST /api/fortune/cache` - ä¿å­˜æ¯æ—¥è¿åŠ¿ç¼“å­˜
- âœ… `DELETE /api/fortune/cache` - åˆ é™¤æ¯æ—¥è¿åŠ¿ç¼“å­˜

**å®ç°æ–‡ä»¶**ï¼š
- âœ… `src/services/fortune.service.ts` - æœåŠ¡å±‚
- âœ… `src/controllers/fortune.controller.ts` - æ§åˆ¶å™¨å±‚
- âœ… `src/routes/fortune.routes.ts` - è·¯ç”±å±‚
- âœ… `src/app.ts` - å·²æ³¨å†Œè·¯ç”±

**æ•°æ®åº“è¿ç§»**ï¼š
```bash
# æ‰§è¡Œ SQL è¿ç§»æ–‡ä»¶åˆ›å»ºè¡¨
psql -U your_user -d your_database -f scripts/migration-create-daily-fortune-caches-table.sql
```

---

---

## ğŸ“Š é—®é¢˜åˆ†æè¯„ä¼°

### âœ… ä¼˜ç‚¹ï¼ˆå½“å‰é˜²å¾¡æ€§ç¼–ç¨‹æ–¹æ¡ˆï¼‰

1. **é˜²æ­¢ç™½å±**ï¼šå¤šå±‚é™çº§æœºåˆ¶ï¼ˆAI â†’ è§„åˆ™å¼•æ“ â†’ ç¡¬ç¼–ç é»˜è®¤å€¼ï¼‰ç¡®ä¿ç”¨æˆ·æ€»èƒ½çœ‹åˆ°ç»“æœé¡µé¢
2. **å®¹é”™æ€§å¼º**ï¼šä¸‰å±‚é™çº§ä¿è¯äº†ç³»ç»Ÿçš„å¥å£®æ€§
3. **ç”¨æˆ·ä½“éªŒ**ï¼šå³ä½¿æ ¸å¿ƒæœåŠ¡å¤±è´¥ï¼Œç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°åŸºç¡€è¿åŠ¿

### âŒ ç¼ºç‚¹ï¼ˆéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼‰

1. **æ©è€³ç›—é“ƒ**ï¼šå¦‚æœæ ¸å¿ƒé—®é¢˜ï¼ˆAIæ¥å£ã€ç´«å¾®æ•°æ®è·å–ï¼‰æ²¡è§£å†³ï¼Œç”¨æˆ·æ°¸è¿œåªèƒ½çœ‹åˆ°é»˜è®¤è¿åŠ¿ï¼Œäº§å“å¤±å»æ ¸å¿ƒä»·å€¼
2. **è°ƒè¯•å›°éš¾**ï¼šé”™è¯¯è¢«é™é»˜åæ‰ï¼Œå¼€å‘è€…éš¾ä»¥å‘ç°ç”Ÿäº§ç¯å¢ƒçš„çœŸå®æ•…éšœç‡
3. **æ•°æ®æºæ–­è£‚**ï¼š`ZiweiFusionService` ä»åœ¨ä½¿ç”¨æ—§çš„ Supabase å®¢æˆ·ç«¯ï¼Œå¯¼è‡´ 406/401 é”™è¯¯

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. æ•°æ®æºæ–­è£‚é—®é¢˜

**é—®é¢˜ä½ç½®**ï¼šå‰ç«¯ `ZiweiFusionService` æˆ– `fusionService.ts`

**é—®é¢˜è¡¨ç°**ï¼š
- è°ƒç”¨ `ZiweiFusionService.getFusionData(userId)` æ—¶å¤±è´¥
- é”™è¯¯æ—¥å¿—ï¼š`vdxxpsjdiswztipauhwb...supabase.co... 406 (Not Acceptable)`
- å¯¼è‡´ `generateFortune()` å‡½æ•°å´©æºƒï¼Œè§¦å‘é™çº§é€»è¾‘

**æ ¹æœ¬åŸå› **ï¼š
- `ZiweiFusionService` ä»åœ¨ä½¿ç”¨æ—§çš„ Supabase Client ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
- æœªè¿ç§»åˆ°ä½¿ç”¨åç«¯ API (`/api/astrology/archives`)

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ­¥éª¤ 1ï¼šä¿®å¤ ZiweiFusionServiceï¼ˆæ²»æœ¬ï¼‰

**ç›®æ ‡**ï¼šå°† `ZiweiFusionService` ä» Supabase è¿ç§»åˆ°åç«¯ API

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼šå‰ç«¯ `src/features/ziwei/services/fusionService.ts`ï¼ˆæˆ–ç±»ä¼¼è·¯å¾„ï¼‰

**ä¿®å¤ä»£ç ç¤ºä¾‹**ï¼š

```typescript
// âŒ æ—§ä»£ç ï¼ˆä½¿ç”¨ Supabaseï¼‰
import { supabase } from '@/lib/supabase';

export const ZiweiFusionService = {
  async getFusionData(userId: string) {
    const { data, error } = await supabase
      .from('ziwei_chart_archives')
      .select('*')
      .eq('user_id', userId)
      .eq('relationship_type', 'self')
      .order('created_at', { ascending: false })
      .limit(1)
      .single();
    
    if (error) throw error;
    return data;
  }
};
```

```typescript
// âœ… æ–°ä»£ç ï¼ˆä½¿ç”¨åç«¯ APIï¼‰
import { astrologyApi } from '@/api/modules/astrology';

export const ZiweiFusionService = {
  async getFusionData(userId: string) {
    try {
      // âš ï¸ é‡è¦ï¼šåˆ—è¡¨æ¥å£åªè¿”å›æ‘˜è¦ï¼ˆä¸åŒ…å«å®Œæ•´å‘½ç›˜æ•°æ®ï¼‰
      // éœ€è¦å…ˆè·å–åˆ—è¡¨ï¼Œå†è·å–è¯¦æƒ…
      const res = await astrologyApi.getArchives({
        relationshipType: 'self',  // åªè·å–è‡ªå·±çš„å‘½ç›˜
        limit: 1,
        offset: 0
      });
      
      if (res.success && res.data.archives && res.data.archives.length > 0) {
        // è·å–æœ€æ–°çš„å­˜æ¡£æ‘˜è¦
        const archiveSummary = res.data.archives[0];
        
        // âš ï¸ åˆ—è¡¨æ¥å£è¿”å›çš„æ˜¯ ChartArchiveSummaryï¼Œä¸åŒ…å«å®Œæ•´ chart
        // éœ€è¦è°ƒç”¨å•ä¸ªå­˜æ¡£æ¥å£è·å–å®Œæ•´å‘½ç›˜æ•°æ®
        const detailRes = await astrologyApi.getArchiveById(archiveSummary.id);
        
        if (detailRes.success && detailRes.data) {
          // âœ… è¿”å›å®Œæ•´æ•°æ®ï¼ˆåŒ…å« chart å­—æ®µï¼‰
          return detailRes.data;
        }
      }
      
      // æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£
      return null;
    } catch (error: any) {
      console.error('âŒ [ZiweiFusionService] è·å–å‘½ç›˜æ•°æ®å¤±è´¥:', {
        userId,
        error: error.message,
        stack: error.stack
      });
      throw error;
    }
  }
};
```

**âš ï¸ API å“åº”æ ¼å¼è¯´æ˜**ï¼š

1. **GET /api/astrology/archives** è¿”å›æ‘˜è¦åˆ—è¡¨ï¼š
   ```typescript
   {
     success: true,
     data: {
       archives: ChartArchiveSummary[]  // ä¸åŒ…å«å®Œæ•´ chartï¼Œåªæœ‰ birthInfo
     }
   }
   ```

2. **GET /api/astrology/archives/:archiveId** è¿”å›å®Œæ•´æ•°æ®ï¼š
   ```typescript
   {
     success: true,
     data: ChartArchive  // åŒ…å«å®Œæ•´ chart å­—æ®µ
   }
   ```

**åç«¯ API ç«¯ç‚¹ç¡®è®¤**ï¼š

âœ… **å·²å®ç°çš„åç«¯ API**ï¼š

1. **GET /api/astrology/archives**
   - æŸ¥è¯¢å‚æ•°ï¼š`relationshipType`, `keyword`, `limit`, `offset`
   - è¿”å›ï¼šå­˜æ¡£æ‘˜è¦åˆ—è¡¨ï¼ˆä¸åŒ…å«å®Œæ•´å‘½ç›˜æ•°æ®ï¼‰
   - è·¯ç”±ï¼š`src/routes/astrology.routes.ts:285`
   - æ§åˆ¶å™¨ï¼š`src/controllers/astrology.controller.ts:663`
   - æœåŠ¡ï¼š`src/services/astrology.service.ts:963`

2. **GET /api/astrology/archives/:archiveId**
   - è¿”å›ï¼šå•ä¸ªå­˜æ¡£å®Œæ•´æ•°æ®ï¼ˆåŒ…å«å®Œæ•´å‘½ç›˜ï¼‰
   - è·¯ç”±ï¼š`src/routes/astrology.routes.ts:311`
   - æ§åˆ¶å™¨ï¼š`src/controllers/astrology.controller.ts:850`
   - æœåŠ¡ï¼š`src/services/astrology.service.ts:1366`

**å‰ç«¯ API å®¢æˆ·ç«¯ç¤ºä¾‹**ï¼ˆéœ€è¦åœ¨å‰ç«¯å®ç°ï¼‰ï¼š

```typescript
// src/api/modules/astrology.ts
import { apiClient } from '@/api/client';

/**
 * å‘½ç›˜å­˜æ¡£æ‘˜è¦ï¼ˆåˆ—è¡¨æ¥å£è¿”å›ï¼‰
 */
export interface ChartArchiveSummary {
  id: string;
  userId: string;
  name: string;
  relationshipType: string;
  customLabel?: string;
  birthInfo: any;  // åªåŒ…å«å‡ºç”Ÿä¿¡æ¯
  notes?: string;
  tags?: string[];
  createdAt: string;
  updatedAt: string;
}

/**
 * å‘½ç›˜å­˜æ¡£å®Œæ•´æ•°æ®ï¼ˆè¯¦æƒ…æ¥å£è¿”å›ï¼‰
 */
export interface ChartArchive {
  id: string;
  userId: string;
  chart: any;  // å®Œæ•´å‘½ç›˜æ•°æ®
  name: string;
  relationshipType: string;
  customLabel?: string;
  notes?: string;
  tags?: string[];
  createdAt: string;
  updatedAt: string;
}

export const astrologyApi = {
  /**
   * è·å–å‘½ç›˜å­˜æ¡£åˆ—è¡¨ï¼ˆè¿”å›æ‘˜è¦ï¼Œä¸åŒ…å«å®Œæ•´å‘½ç›˜æ•°æ®ï¼‰
   * 
   * @param params æŸ¥è¯¢å‚æ•°
   * @returns Promise<{ success: boolean, data: { archives: ChartArchiveSummary[] } }>
   */
  async getArchives(params?: {
    relationshipType?: 'self' | 'lover' | 'child' | 'parent' | 'bestie' | 'sibling' | 'friend' | 'colleague' | 'celebrity' | 'custom';
    keyword?: string;
    limit?: number;
    offset?: number;
  }): Promise<{
    success: boolean;
    data: {
      archives: ChartArchiveSummary[];
    };
    error?: string;
    message?: string;
  }> {
    const queryParams = new URLSearchParams();
    if (params?.relationshipType) queryParams.append('relationshipType', params.relationshipType);
    if (params?.keyword) queryParams.append('keyword', params.keyword);
    if (params?.limit) queryParams.append('limit', String(params.limit));
    if (params?.offset) queryParams.append('offset', String(params.offset));
    
    const url = `/api/astrology/archives${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
    return apiClient.get(url);
  },
  
  /**
   * è·å–å•ä¸ªå‘½ç›˜å­˜æ¡£ï¼ˆè¿”å›å®Œæ•´æ•°æ®ï¼ŒåŒ…å«å®Œæ•´å‘½ç›˜ï¼‰
   * 
   * @param archiveId å­˜æ¡£ID
   * @returns Promise<{ success: boolean, data: ChartArchive }>
   */
  async getArchiveById(archiveId: string): Promise<{
    success: boolean;
    data: ChartArchive;
    error?: string;
    message?: string;
  }> {
    return apiClient.get(`/api/astrology/archives/${archiveId}`);
  }
};
```

---

### æ­¥éª¤ 2ï¼šä¼˜åŒ– useFortune.tsï¼ˆæ›´èªæ˜çš„é™çº§ï¼‰

**ç›®æ ‡**ï¼šåŒºåˆ†é”™è¯¯ç±»å‹ï¼Œä¿ç•™é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•ï¼ŒåŒæ—¶æä¾›é™çº§æ ‡è®°

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼šå‰ç«¯ `src/features/fortune/composables/useFortune.ts`

**ä¿®å¤ä»£ç ç¤ºä¾‹**ï¼š

```typescript
// src/features/fortune/composables/useFortune.ts

interface FortuneResult {
  id: string;
  date: string;
  summary: string;
  score: number;
  level: string;
  luckyElements: {
    color: string;
    number: number;
    direction: string;
  };
  content: {
    overall: string;
    career: string;
    // ... å…¶ä»–å­—æ®µ
  };
  // âœ… æ–°å¢ï¼šé™çº§æ ‡è®°
  isFallback?: boolean;
  // âœ… æ–°å¢ï¼šé”™è¯¯ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
  errorMessage?: string;
}

const generate = async (personalData: PersonalizedFortuneData, useAI: boolean = true) => {
  loading.value = true;
  error.value = null; // æ¸…ç©ºæ—§é”™è¯¯
  
  try {
    const result = await generateFortune(personalData, useAI);
    
    if (result) {
      // âœ… æˆåŠŸè·¯å¾„ï¼šæ¸…é™¤é™çº§æ ‡è®°
      result.isFallback = false;
      fortune.value = result;
    } else {
      throw new Error('ç”Ÿæˆç»“æœä¸ºç©º');
    }
  } catch (err: any) {
    console.error('âŒ è¿åŠ¿ç”Ÿæˆå¼‚å¸¸ (è¯¦ç»†å †æ ˆ):', {
      error: err.message,
      stack: err.stack,
      userId: personalData.userId,
      useAI
    });
    
    // âœ… é™çº§ç­–ç•¥ï¼šä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
    const fallbackFortune = createFallbackFortune(personalData);
    fallbackFortune.isFallback = true; // æ ‡è®°ä¸ºé™çº§æ•°æ®
    
    // âœ… å…³é”®æ”¹è¿›ï¼šè®°å½•é”™è¯¯åŸå› ï¼ˆä»…å¼€å‘ç¯å¢ƒæ˜¾ç¤ºï¼‰
    if (import.meta.env.DEV) {
      fallbackFortune.errorMessage = `[å¼€å‘è°ƒè¯•] åŸç”Ÿç”Ÿæˆå¤±è´¥: ${err.message}`;
      error.value = `[å¼€å‘è°ƒè¯•] åŸç”Ÿç”Ÿæˆå¤±è´¥: ${err.message}`;
    }
    
    // âš ï¸ ç”Ÿäº§ç¯å¢ƒï¼šé™é»˜é™çº§ï¼Œä½†è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
    // TODO: é›†æˆé”™è¯¯ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Sentryï¼‰
    // if (import.meta.env.PROD) {
    //   reportErrorToMonitoring({
    //     type: 'fortune_generation_failed',
    //     error: err.message,
    //     userId: personalData.userId
    //   });
    // }
    
    fortune.value = fallbackFortune;
  } finally {
    loading.value = false;
  }
};

/**
 * åˆ›å»ºé™çº§è¿åŠ¿æ•°æ®
 */
function createFallbackFortune(data: PersonalizedFortuneData): FortuneResult {
  return {
    id: `fallback_${Date.now()}`,
    date: new Date().toISOString(),
    summary: 'å¿ƒå¹³æ°”å’Œï¼Œé™å¾…èŠ±å¼€',
    score: 75,
    level: 'good',
    luckyElements: {
      color: 'ç™½è‰²',
      number: 5,
      direction: 'ä¸­'
    },
    content: {
      overall: 'ä»Šæ—¥è¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆè°ƒæ•´èº«å¿ƒã€‚',
      career: 'å·¥ä½œæŒ‰éƒ¨å°±ç­å³å¯ã€‚',
      wealth: 'è´¢è¿ç¨³å®šï¼Œä¸å®œå¤§é¢æŠ•èµ„ã€‚',
      love: 'æ„Ÿæƒ…è¿åŠ¿å¹³ç¨³ï¼Œä¿æŒæ²Ÿé€šã€‚',
      health: 'æ³¨æ„ä¼‘æ¯ï¼Œä¿æŒè§„å¾‹ä½œæ¯ã€‚'
    },
    isFallback: true // æ ‡è®°ä¸ºé™çº§æ•°æ®
  };
}
```

---

### æ­¥éª¤ 3ï¼šå‰ç«¯ UI é€‚é…ï¼ˆFortunePage.vueï¼‰

**ç›®æ ‡**ï¼šåœ¨ UI ä¸­æ˜¾ç¤ºé™çº§çŠ¶æ€ï¼Œç»™ç”¨æˆ·å¾®å¦™çš„æç¤º

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼šå‰ç«¯ `src/features/fortune/pages/FortunePage.vue`ï¼ˆæˆ–ç±»ä¼¼è·¯å¾„ï¼‰

**ä¿®å¤ä»£ç ç¤ºä¾‹**ï¼š

```vue
<template>
  <div class="fortune-page">
    <!-- è¿åŠ¿å¤´éƒ¨ -->
    <div class="fortune-header">
      <h1>ä»Šæ—¥è¿åŠ¿</h1>
      
      <!-- âœ… æ˜¾ç¤ºç”Ÿæˆæ–¹å¼æ ‡è®° -->
      <div class="generation-badge">
        <span v-if="!fortune?.isFallback" class="ai-badge">
          ğŸ¤– AI æ·±åº¦è§£æ
        </span>
        <span v-else class="fallback-badge">
          ğŸ”® åŸºç¡€è¿åŠ¿
        </span>
      </div>
    </div>
    
    <!-- è¿åŠ¿å†…å®¹ -->
    <div v-if="fortune" class="fortune-content">
      <!-- é™çº§æç¤ºï¼ˆå¯é€‰ï¼Œä¸å“åˆ°ç”¨æˆ·ï¼‰ -->
      <div v-if="fortune.isFallback" class="fallback-notice">
        <p>AI æœåŠ¡æš‚æ—¶ä¼‘æ¯ä¸­ï¼Œä¸ºæ‚¨å±•ç¤ºåŸºç¡€è¿åŠ¿</p>
      </div>
      
      <!-- è¿åŠ¿è¯¦æƒ… -->
      <div class="fortune-details">
        <div class="summary">{{ fortune.summary }}</div>
        <div class="score">è¿åŠ¿è¯„åˆ†ï¼š{{ fortune.score }}</div>
        <!-- ... å…¶ä»–è¿åŠ¿å†…å®¹ ... -->
      </div>
    </div>
    
    <!-- å¼€å‘ç¯å¢ƒé”™è¯¯æ˜¾ç¤º -->
    <div v-if="error && isDev" class="debug-error-box">
      <h3>å¼€å‘è°ƒè¯•ä¿¡æ¯</h3>
      <pre>{{ error }}</pre>
    </div>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading">
      æ­£åœ¨ç”Ÿæˆè¿åŠ¿...
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useFortune } from '../composables/useFortune';

const { fortune, loading, error } = useFortune();
const isDev = computed(() => import.meta.env.DEV);
</script>

<style scoped>
.ai-badge {
  display: inline-block;
  padding: 4px 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.fallback-badge {
  display: inline-block;
  padding: 4px 12px;
  background: #f0f0f0;
  color: #666;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.fallback-notice {
  padding: 12px;
  background: #fff9e6;
  border-left: 3px solid #ffc107;
  border-radius: 4px;
  margin-bottom: 16px;
  font-size: 14px;
  color: #856404;
}

.debug-error-box {
  margin-top: 20px;
  padding: 16px;
  background: #fee;
  border: 1px solid #fcc;
  border-radius: 4px;
}

.debug-error-box pre {
  margin: 0;
  font-size: 12px;
  color: #c33;
  white-space: pre-wrap;
  word-break: break-all;
}
</style>
```

---

## ğŸ“‹ ä¿®å¤æ£€æŸ¥æ¸…å•

### åç«¯ API éªŒè¯

- [x] `GET /api/astrology/archives` å·²å®ç°
- [x] `GET /api/astrology/archives/:archiveId` å·²å®ç°
- [x] API è¿”å›æ ¼å¼ç¬¦åˆå‰ç«¯æœŸæœ›
- [x] è®¤è¯ä¸­é—´ä»¶å·²æ­£ç¡®é…ç½®

### å‰ç«¯ä¿®å¤ä»»åŠ¡

- [ ] åˆ›å»ºæˆ–æ›´æ–° `src/api/modules/astrology.ts` API å®¢æˆ·ç«¯
- [ ] ä¿®æ”¹ `ZiweiFusionService` ä½¿ç”¨åç«¯ API æ›¿ä»£ Supabase
- [ ] æ›´æ–° `useFortune.ts` æ·»åŠ é™çº§æ ‡è®°å’Œé”™è¯¯å¤„ç†
- [ ] æ›´æ–° `FortunePage.vue` æ˜¾ç¤ºé™çº§çŠ¶æ€
- [ ] æµ‹è¯•æ­£å¸¸æµç¨‹ï¼ˆæœ‰å‘½ç›˜æ•°æ®ï¼‰
- [ ] æµ‹è¯•é™çº§æµç¨‹ï¼ˆæ— å‘½ç›˜æ•°æ®æˆ– API å¤±è´¥ï¼‰
- [ ] éªŒè¯å¼€å‘ç¯å¢ƒé”™è¯¯æ˜¾ç¤º
- [ ] éªŒè¯ç”Ÿäº§ç¯å¢ƒé™é»˜é™çº§

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

1. **ä¿®å¤ ZiweiFusionService**ï¼šè¿ç§»åˆ°åç«¯ APIï¼Œæ‰“é€šæ•°æ®æº
2. **éªŒè¯åç«¯ API**ï¼šç¡®ä¿ `/api/astrology/archives` æ­£å¸¸å·¥ä½œ

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰

3. **ä¼˜åŒ–é”™è¯¯å¤„ç†**ï¼šæ·»åŠ é™çº§æ ‡è®°ï¼ŒåŒºåˆ†é”™è¯¯ç±»å‹
4. **UI é€‚é…**ï¼šæ˜¾ç¤ºé™çº§çŠ¶æ€ï¼Œç»™ç”¨æˆ·æç¤º

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

5. **é”™è¯¯ç›‘æ§**ï¼šé›†æˆ Sentry æˆ–å…¶ä»–ç›‘æ§ç³»ç»Ÿ
6. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜å‘½ç›˜æ•°æ®ï¼Œå‡å°‘ API è°ƒç”¨

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•åœºæ™¯ 1ï¼šæ­£å¸¸æµç¨‹ï¼ˆæœ‰å‘½ç›˜æ•°æ®ï¼‰

1. ç”¨æˆ·å·²åˆ›å»ºå‘½ç›˜å­˜æ¡£ï¼ˆrelationshipType = 'self'ï¼‰
2. è®¿é—®è¿åŠ¿é¡µé¢
3. **æœŸå¾…ç»“æœ**ï¼š
   - æˆåŠŸè°ƒç”¨ `ZiweiFusionService.getFusionData()`
   - æˆåŠŸç”Ÿæˆ AI è¿åŠ¿
   - æ˜¾ç¤º "ğŸ¤– AI æ·±åº¦è§£æ" æ ‡è®°
   - ä¸æ˜¾ç¤ºé™çº§æç¤º

### æµ‹è¯•åœºæ™¯ 2ï¼šé™çº§æµç¨‹ï¼ˆæ— å‘½ç›˜æ•°æ®ï¼‰

1. ç”¨æˆ·æœªåˆ›å»ºå‘½ç›˜å­˜æ¡£
2. è®¿é—®è¿åŠ¿é¡µé¢
3. **æœŸå¾…ç»“æœ**ï¼š
   - `ZiweiFusionService.getFusionData()` è¿”å› `null`
   - è§¦å‘é™çº§é€»è¾‘
   - æ˜¾ç¤º "ğŸ”® åŸºç¡€è¿åŠ¿" æ ‡è®°
   - æ˜¾ç¤ºé™çº§æç¤ºï¼š"AI æœåŠ¡æš‚æ—¶ä¼‘æ¯ä¸­ï¼Œä¸ºæ‚¨å±•ç¤ºåŸºç¡€è¿åŠ¿"
   - ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### æµ‹è¯•åœºæ™¯ 3ï¼šAPI å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰

1. æ¨¡æ‹Ÿåç«¯ API è¿”å› 500 é”™è¯¯
2. è®¿é—®è¿åŠ¿é¡µé¢
3. **æœŸå¾…ç»“æœ**ï¼š
   - æ•è·é”™è¯¯
   - è§¦å‘é™çº§é€»è¾‘
   - æ˜¾ç¤ºåŸºç¡€è¿åŠ¿
   - å¼€å‘ç¯å¢ƒæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
   - ç”Ÿäº§ç¯å¢ƒé™é»˜é™çº§

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‘½ç›˜å­˜æ¡£APIå®ç°ç¡®è®¤.md](./å‘½ç›˜å­˜æ¡£APIå®ç°ç¡®è®¤.md)
- [ç´«å¾®æ–—æ•°APIå¼€å‘è§„èŒƒ.md](./ç´«å¾®æ–—æ•°APIå¼€å‘è§„èŒƒ.md)
- [åç«¯APIå¼€å‘æç¤ºè¯-ä»»åŠ¡ç³»ç»Ÿ.md](./åç«¯APIå¼€å‘æç¤ºè¯-ä»»åŠ¡ç³»ç»Ÿ.md)

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ç­–ç•¥**ï¼šåœ¨ `ZiweiFusionService` ä¸­æ·»åŠ ç¼“å­˜ï¼Œé¿å…é¢‘ç¹è°ƒç”¨ API
2. **é‡è¯•æœºåˆ¶**ï¼šç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯• 1-2 æ¬¡
3. **ç›‘æ§å‘Šè­¦**ï¼šé™çº§ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦
4. **ç”¨æˆ·ä½“éªŒ**ï¼šé™çº§æ—¶æä¾›"ç¨åé‡è¯•"æŒ‰é’®

---

## ğŸ“‹ åç«¯å®ç°è¯¦æƒ…ï¼ˆFortune æ¨¡å—ï¼‰

### âœ… å·²å®ç°çš„åç«¯ API

#### 1. GET /api/fortune/cache - è·å–æ¯æ—¥è¿åŠ¿ç¼“å­˜

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
GET /api/fortune/cache?date=2025-01-11&profileId=self
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `date` (å¯é€‰): è¿åŠ¿æ—¥æœŸï¼Œæ ¼å¼ `YYYY-MM-DD`ï¼Œé»˜è®¤ä»Šå¤©
- `profileId` (å¯é€‰): æ¡£æ¡ˆIDï¼Œé»˜è®¤ `'self'`

**å“åº”æ ¼å¼ï¼ˆæˆåŠŸï¼‰**ï¼š
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "profile_id": "self",
    "fortune_date": "2025-01-11",
    "data": {
      "id": "fortune_123",
      "date": "2025-01-11",
      "summary": "ä»Šæ—¥è¿åŠ¿å¹³ç¨³",
      "score": 75,
      "level": "good",
      "content": { ... }
    },
    "created_at": "2025-01-11T12:00:00Z",
    "updated_at": "2025-01-11T12:00:00Z"
  }
}
```

**å“åº”æ ¼å¼ï¼ˆæœªæ‰¾åˆ°ï¼‰**ï¼š
```json
{
  "success": false,
  "error": "è¿åŠ¿ç¼“å­˜ä¸å­˜åœ¨"
}
```

#### 2. POST /api/fortune/cache - ä¿å­˜æ¯æ—¥è¿åŠ¿ç¼“å­˜

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
POST /api/fortune/cache
Authorization: Bearer <token>
Content-Type: application/json

{
  "date": "2025-01-11",
  "profileId": "self",
  "data": {
    "id": "fortune_123",
    "date": "2025-01-11",
    "summary": "ä»Šæ—¥è¿åŠ¿å¹³ç¨³",
    "score": 75,
    "level": "good",
    "content": {
      "overall": "ä»Šæ—¥è¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆè°ƒæ•´èº«å¿ƒã€‚",
      "career": "å·¥ä½œæŒ‰éƒ¨å°±ç­å³å¯ã€‚",
      "wealth": "è´¢è¿ç¨³å®šï¼Œä¸å®œå¤§é¢æŠ•èµ„ã€‚",
      "love": "æ„Ÿæƒ…è¿åŠ¿å¹³ç¨³ï¼Œä¿æŒæ²Ÿé€šã€‚",
      "health": "æ³¨æ„ä¼‘æ¯ï¼Œä¿æŒè§„å¾‹ä½œæ¯ã€‚"
    }
  }
}
```

**è¯·æ±‚ä½“å‚æ•°**ï¼š
- `date` (å¯é€‰): è¿åŠ¿æ—¥æœŸï¼Œæ ¼å¼ `YYYY-MM-DD`ï¼Œé»˜è®¤ä»Šå¤©
- `profileId` (å¯é€‰): æ¡£æ¡ˆIDï¼Œé»˜è®¤ `'self'`
- `data` (å¿…å¡«): å®Œæ•´çš„è¿åŠ¿æ•°æ®ï¼ˆJSON å¯¹è±¡ï¼‰

**å“åº”æ ¼å¼**ï¼š
```json
{
  "success": true,
  "message": "è¿åŠ¿ç¼“å­˜ä¿å­˜æˆåŠŸ",
  "data": {
    "cache_id": "uuid"
  }
}
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ UPSERT æ“ä½œï¼Œå¦‚æœå·²å­˜åœ¨ç›¸åŒ `user_id`ã€`profile_id`ã€`fortune_date` çš„è®°å½•ï¼Œä¼šæ›´æ–°æ•°æ®
- è‡ªåŠ¨å¤„ç† JSON åºåˆ—åŒ–

#### 3. DELETE /api/fortune/cache - åˆ é™¤æ¯æ—¥è¿åŠ¿ç¼“å­˜

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
DELETE /api/fortune/cache?date=2025-01-11&profileId=self
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `date` (å¯é€‰): è¿åŠ¿æ—¥æœŸï¼Œæ ¼å¼ `YYYY-MM-DD`
- `profileId` (å¯é€‰): æ¡£æ¡ˆID

**è¯´æ˜**ï¼š
- å¦‚æœéƒ½ä¸æä¾›ï¼Œåˆ™åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰è¿åŠ¿ç¼“å­˜
- å¦‚æœåªæä¾› `date`ï¼Œåˆ™åˆ é™¤è¯¥æ—¥æœŸçš„æ‰€æœ‰ç¼“å­˜
- å¦‚æœåªæä¾› `profileId`ï¼Œåˆ™åˆ é™¤è¯¥æ¡£æ¡ˆçš„æ‰€æœ‰ç¼“å­˜
- å¦‚æœéƒ½æä¾›ï¼Œåˆ™åˆ é™¤è¯¥ç”¨æˆ·ã€è¯¥æ¡£æ¡ˆã€è¯¥æ—¥æœŸçš„ç¼“å­˜

**å“åº”æ ¼å¼**ï¼š
```json
{
  "success": true,
  "message": "æˆåŠŸåˆ é™¤ 1 æ¡ç¼“å­˜è®°å½•",
  "data": {
    "deleted_count": 1
  }
}
```

---

### ğŸ”§ æ•°æ®åº“è¡¨ç»“æ„

#### daily_fortune_caches è¡¨

```sql
CREATE TABLE public.daily_fortune_caches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    profile_id TEXT NOT NULL,
    fortune_date DATE NOT NULL,
    data JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, profile_id, fortune_date)
);
```

**å­—æ®µè¯´æ˜**ï¼š
- `id`: ç¼“å­˜è®°å½•IDï¼ˆUUIDï¼‰
- `user_id`: ç”¨æˆ·IDï¼ˆUUIDï¼‰
- `profile_id`: æ¡£æ¡ˆIDï¼ˆTEXTï¼Œå¯èƒ½æ˜¯ UUID æˆ–ç‰¹æ®Šå€¼å¦‚ 'self'ï¼‰
- `fortune_date`: è¿åŠ¿æ—¥æœŸï¼ˆDATEï¼Œæ ¼å¼ YYYY-MM-DDï¼‰
- `data`: å®Œæ•´çš„è¿åŠ¿æ•°æ®ï¼ˆJSONBï¼‰
- `created_at`: åˆ›å»ºæ—¶é—´
- `updated_at`: æ›´æ–°æ—¶é—´

**å”¯ä¸€çº¦æŸ**ï¼š
- `(user_id, profile_id, fortune_date)` - åŒä¸€ä¸ªç”¨æˆ·ã€åŒä¸€ä¸ªæ¡£æ¡ˆã€åŒä¸€å¤©åªèƒ½æœ‰ä¸€æ¡ç¼“å­˜

**ç´¢å¼•**ï¼š
- `user_id` ç´¢å¼•
- `profile_id` ç´¢å¼•
- `fortune_date` ç´¢å¼•
- `(user_id, profile_id, fortune_date)` å¤åˆç´¢å¼•

**æ•°æ®åº“è¿ç§»**ï¼š
```bash
# æ‰§è¡Œ SQL è¿ç§»æ–‡ä»¶åˆ›å»ºè¡¨
psql -U your_user -d your_database -f scripts/migration-create-daily-fortune-caches-table.sql
```

---

### ğŸ“ å‰ç«¯ API å®¢æˆ·ç«¯ç¤ºä¾‹

**å‰ç«¯éœ€è¦å®ç°çš„ API å®¢æˆ·ç«¯**ï¼ˆå‚è€ƒï¼‰ï¼š

```typescript
// src/api/modules/fortune.ts
import { apiClient } from '@/api/client';

export interface DailyFortuneCache {
  id: string;
  user_id: string;
  profile_id: string;
  fortune_date: string; // YYYY-MM-DD
  data: any; // å®Œæ•´çš„è¿åŠ¿æ•°æ®
  created_at: string;
  updated_at: string;
}

export const fortuneApi = {
  /**
   * è·å–æ¯æ—¥è¿åŠ¿ç¼“å­˜
   */
  async getCache(params?: {
    date?: string; // YYYY-MM-DD
    profileId?: string;
  }): Promise<{
    success: boolean;
    data?: DailyFortuneCache;
    error?: string;
  }> {
    const queryParams = new URLSearchParams();
    if (params?.date) queryParams.append('date', params.date);
    if (params?.profileId) queryParams.append('profileId', params.profileId);
    
    const url = `/api/fortune/cache${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
    return apiClient.get(url);
  },
  
  /**
   * ä¿å­˜æ¯æ—¥è¿åŠ¿ç¼“å­˜
   */
  async saveCache(data: {
    date?: string; // YYYY-MM-DD
    profileId?: string;
    data: any; // å®Œæ•´çš„è¿åŠ¿æ•°æ®
  }): Promise<{
    success: boolean;
    data?: { cache_id: string };
    error?: string;
    message?: string;
  }> {
    return apiClient.post('/api/fortune/cache', data);
  },
  
  /**
   * åˆ é™¤æ¯æ—¥è¿åŠ¿ç¼“å­˜
   */
  async deleteCache(params?: {
    date?: string; // YYYY-MM-DD
    profileId?: string;
  }): Promise<{
    success: boolean;
    data?: { deleted_count: number };
    error?: string;
    message?: string;
  }> {
    const queryParams = new URLSearchParams();
    if (params?.date) queryParams.append('date', params.date);
    if (params?.profileId) queryParams.append('profileId', params.profileId);
    
    const url = `/api/fortune/cache${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
    return apiClient.delete(url);
  }
};
```

---

**åç«¯å®ç°çŠ¶æ€**: âœ… **å·²å®Œæˆ** - Fortune æ¨¡å—åç«¯ API å·²å…¨éƒ¨å®ç°  
**å‰ç«¯ä¿®å¤çŠ¶æ€**: ğŸ“‹ **å¾…ä¿®å¤** - å‰ç«¯éœ€è¦è¿ç§»åˆ°ä½¿ç”¨åç«¯ API
