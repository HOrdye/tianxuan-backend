# æ”¯ä»˜ç³»ç»Ÿ API æµ‹è¯•ç»“æœæŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: 2025å¹´1æœˆ30æ—¥  
**API ç‰ˆæœ¬**: v1.0  
**æµ‹è¯•çŠ¶æ€**: âœ… **å…¨éƒ¨é€šè¿‡**

---

## ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»

| æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| 1. åˆ›å»ºæ”¯ä»˜è®¢å• | âœ… **é€šè¿‡** | item_type æ­£ç¡®è®¾ç½®ä¸º 'coin_pack' |
| 2. Mock æ”¯ä»˜æˆåŠŸ | âœ… **é€šè¿‡** | è®¢å•çŠ¶æ€æ›´æ–°ï¼Œä½™é¢å¢åŠ  |
| 3. æŸ¥è¯¢è®¢å•åˆ—è¡¨ | âœ… **é€šè¿‡** | è¿”å›è®¢å•åˆ—è¡¨ï¼Œæ”¯æŒçŠ¶æ€è¿‡æ»¤ |
| 4. æŸ¥è¯¢å•ä¸ªè®¢å•è¯¦æƒ… | âœ… **é€šè¿‡** | è¿”å›è®¢å•è¯¦æƒ… |
| 5. å¹‚ç­‰æ€§æµ‹è¯• | âœ… **é€šè¿‡** | é‡å¤è°ƒç”¨ä¸ä¼šé‡å¤å‘æ”¾ |
| 6. å‚æ•°éªŒè¯ | âœ… **é€šè¿‡** | è´Ÿæ•°é‡‘é¢è¢«æ­£ç¡®æ‹’ç» |
| 7. æŸ¥è¯¢ä¸å­˜åœ¨çš„è®¢å• | âœ… **é€šè¿‡** | æ­£ç¡®è¿”å› 404 |
| 8. æœªè®¤è¯è¯·æ±‚ | âœ… **é€šè¿‡** | æ­£ç¡®è¿”å› 401 |

**æ€»è®¡**: 8/8 æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼ˆ100%ï¼‰

---

## âœ… æµ‹è¯•è¯¦æƒ…

### æµ‹è¯• 1: åˆ›å»ºæ”¯ä»˜è®¢å• âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯åˆ›å»ºæ”¯ä»˜è®¢å•åŠŸèƒ½ï¼Œç¡®è®¤ item_type æ­£ç¡®è®¾ç½®ä¸º 'coin_pack'

**è¯·æ±‚**:
```bash
POST http://localhost:3000/api/payment/orders
Authorization: Bearer <TOKEN>
Content-Type: application/json

{
  "amount": 100,
  "coinsAmount": 1000,
  "packType": "coins_pack_1",
  "paymentProvider": "alipay",
  "description": "è´­ä¹°1000å¤©æœºå¸"
}
```

**å®é™…å“åº”** (200 OK):
```json
{
  "success": true,
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "order_id": "c3aa49f6-6d1a-49de-8128-3817b3862de4"
  }
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… `success` ä¸º `true`
- âœ… è¿”å› `order_id`
- âœ… è®¢å•çŠ¶æ€ä¸º `pending`
- âœ… è®¢å•ç±»å‹ä¸º `purchase`
- âœ… `item_type` æ­£ç¡®è®¾ç½®ä¸º `coin_pack`

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 2: Mock æ”¯ä»˜æˆåŠŸ âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ Mock æ”¯ä»˜æˆåŠŸåŠŸèƒ½

**è¯·æ±‚**:
```bash
POST http://localhost:3000/api/payment/mock/success
Authorization: Bearer <TOKEN>
Content-Type: application/json

{
  "orderId": "c3aa49f6-6d1a-49de-8128-3817b3862de4"
}
```

**å®é™…å“åº”** (200 OK):
```json
{
  "success": true,
  "message": "æ”¯ä»˜æˆåŠŸï¼Œå¤©æœºå¸å·²åˆ°è´¦",
  "data": {
    "order_id": "c3aa49f6-6d1a-49de-8128-3817b3862de4",
    "new_balance": 1000,
    "provider_transaction_id": "MOCK_1767836291330_b4y92s"
  }
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… `success` ä¸º `true`
- âœ… è®¢å•çŠ¶æ€æ›´æ–°ä¸º `completed`
- âœ… `paid_at` å­—æ®µå·²è®¾ç½®
- âœ… ç”¨æˆ·å¤©æœºå¸ä½™é¢å¢åŠ  1000

**ä½™é¢éªŒè¯**:
```json
{
  "success": true,
  "data": {
    "tianji_coins_balance": 1000,
    "daily_coins_grant": 15,
    "activity_coins_grant": 0
  }
}
```

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 3: æŸ¥è¯¢è®¢å•åˆ—è¡¨ âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯æŸ¥è¯¢è®¢å•åˆ—è¡¨åŠŸèƒ½

**è¯·æ±‚**:
```bash
GET http://localhost:3000/api/payment/orders?limit=5
Authorization: Bearer <TOKEN>
```

**å®é™…å“åº”** (200 OK):
```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": "c3aa49f6-6d1a-49de-8128-3817b3862de4",
        "user_id": "a402cd28-fd8a-432f-b3ed-267ca0faad82",
        "type": "purchase",
        "amount": "100.00",
        "coins_amount": 1000,
        "item_type": "coin_pack",
        "pack_type": "coins_pack_1",
        "description": "è´­ä¹°1000å¤©æœºå¸",
        "status": "completed",
        "paid_at": "2026-01-08T01:38:11.331Z",
        "payment_provider": "alipay",
        "is_first_purchase": true,
        "created_at": "2026-01-08T01:38:08.870Z"
      }
    ],
    "limit": 5,
    "offset": 0,
    "count": 2
  }
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… `success` ä¸º `true`
- âœ… è¿”å›è®¢å•åˆ—è¡¨
- âœ… è®¢å•ä¿¡æ¯æ­£ç¡®ï¼ˆitem_type ä¸º 'coin_pack'ï¼‰
- âœ… æ”¯æŒåˆ†é¡µå‚æ•°

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 4: æŸ¥è¯¢å•ä¸ªè®¢å•è¯¦æƒ… âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯æŸ¥è¯¢å•ä¸ªè®¢å•è¯¦æƒ…åŠŸèƒ½

**è¯·æ±‚**:
```bash
GET http://localhost:3000/api/payment/orders/c3aa49f6-6d1a-49de-8128-3817b3862de4
Authorization: Bearer <TOKEN>
```

**å®é™…å“åº”** (200 OK):
```json
{
  "success": true,
  "data": {
    "id": "c3aa49f6-6d1a-49de-8128-3817b3862de4",
    "user_id": "a402cd28-fd8a-432f-b3ed-267ca0faad82",
    "type": "purchase",
    "amount": "100.00",
    "coins_amount": 1000,
    "item_type": "coin_pack",
    "pack_type": "coins_pack_1",
    "description": "è´­ä¹°1000å¤©æœºå¸",
    "status": "completed",
    "paid_at": "2026-01-08T01:38:11.331Z",
    "payment_provider": "alipay",
    "is_first_purchase": true,
    "created_at": "2026-01-08T01:38:08.870Z"
  }
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… `success` ä¸º `true`
- âœ… è¿”å›è®¢å•è¯¦æƒ…
- âœ… è®¢å•ä¿¡æ¯æ­£ç¡®

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 5: å¹‚ç­‰æ€§æµ‹è¯• âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯é˜²æ­¢é‡å¤å¤„ç†æ”¯ä»˜å›è°ƒçš„åŠŸèƒ½

**è¯·æ±‚**ï¼ˆä½¿ç”¨å·²å®Œæˆçš„è®¢å•IDï¼‰:
```bash
POST http://localhost:3000/api/payment/mock/success
Authorization: Bearer <TOKEN>
Content-Type: application/json

{
  "orderId": "c3aa49f6-6d1a-49de-8128-3817b3862de4"
}
```

**å®é™…å“åº”** (200 OK):
```json
{
  "success": true,
  "message": "è®¢å•å·²å¤„ç†è¿‡",
  "data": {
    "order_id": "c3aa49f6-6d1a-49de-8128-3817b3862de4",
    "new_balance": 1000
  }
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  200
- âœ… `success` ä¸º `true`
- âœ… æ¶ˆæ¯æç¤º"è®¢å•å·²å¤„ç†è¿‡"
- âœ… ä½™é¢æ²¡æœ‰é‡å¤å¢åŠ ï¼ˆä»ç„¶æ˜¯ 1000ï¼‰

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 6: å‚æ•°éªŒè¯ âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯å‚æ•°éªŒè¯åŠŸèƒ½

**è¯·æ±‚**:
```bash
POST http://localhost:3000/api/payment/orders
Authorization: Bearer <TOKEN>
Content-Type: application/json

{
  "amount": -100,
  "coinsAmount": 1000
}
```

**å®é™…å“åº”** (400 Bad Request):
```json
{
  "success": false,
  "error": "å‚æ•°é”™è¯¯",
  "message": "æ”¯ä»˜é‡‘é¢ (amount) å¿…é¡»æä¾›ä¸”å¤§äº0"
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  400
- âœ… `success` ä¸º `false`
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 7: æŸ¥è¯¢ä¸å­˜åœ¨çš„è®¢å• âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯æŸ¥è¯¢ä¸å­˜åœ¨è®¢å•çš„é”™è¯¯å¤„ç†

**è¯·æ±‚**:
```bash
GET http://localhost:3000/api/payment/orders/00000000-0000-0000-0000-000000000000
Authorization: Bearer <TOKEN>
```

**å®é™…å“åº”** (404 Not Found):
```json
{
  "success": false,
  "error": "è®¢å•ä¸å­˜åœ¨"
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  404
- âœ… `success` ä¸º `false`
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

### æµ‹è¯• 8: æœªè®¤è¯è¯·æ±‚ âœ…

**æµ‹è¯•ç›®æ ‡**: éªŒè¯è®¤è¯ä¿æŠ¤åŠŸèƒ½

**è¯·æ±‚**ï¼ˆä¸æä¾› Tokenï¼‰:
```bash
POST http://localhost:3000/api/payment/orders
Content-Type: application/json

{
  "amount": 100,
  "coinsAmount": 1000
}
```

**å®é™…å“åº”** (401 Unauthorized):
```json
{
  "error": "æœªæä¾›è®¤è¯ä»¤ç‰Œ",
  "message": "è¯·åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  Authorization: Bearer <token>"
}
```

**éªŒè¯ç»“æœ**:
- âœ… è¿”å›çŠ¶æ€ç  401
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®
- âœ… å®‰å…¨æœºåˆ¶æ­£å¸¸å·¥ä½œ

**çŠ¶æ€**: âœ… **é€šè¿‡**

---

## ğŸ”§ ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1: æ•°æ®åº“çº¦æŸé”™è¯¯ - item_type å­—æ®µ

**é—®é¢˜æè¿°**: 
- é”™è¯¯ä¿¡æ¯: `new row for relation "transactions" violates check constraint "transactions_item_type_check"`
- åŸå› : `item_type` å­—æ®µä½¿ç”¨äº†ä¸å…è®¸çš„å€¼

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… æŸ¥è¯¢äº†æ•°æ®åº“çº¦æŸå®šä¹‰
2. âœ… ç¡®è®¤å…è®¸çš„å€¼ï¼š`'subscription'`, `'coin_pack'`, `'admin_adjustment'`, `'refund'`, `'system_grant'`
3. âœ… å°† `item_type` è®¾ç½®ä¸º `'coin_pack'`ï¼ˆæœ€ç¬¦åˆ"å……å€¼"å«ä¹‰çš„åˆæ³•å€¼ï¼‰
4. âœ… æ›´æ–°äº†ä»£ç æ³¨é‡Šï¼Œè¯´æ˜æ•°æ®åº“çº¦æŸå®šä¹‰
5. âœ… é‡å¯æœåŠ¡å™¨ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç 

**ä¿®å¤æ–‡ä»¶**:
- `src/services/payment.service.ts` (ç¬¬ 117 è¡Œï¼Œç¬¬ 154 è¡Œ)

**éªŒè¯ç»“æœ**: âœ… ä¿®å¤æˆåŠŸï¼Œåˆ›å»ºè®¢å•åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“ åŠŸèƒ½éªŒè¯æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½

- [x] âœ… åˆ›å»ºæ”¯ä»˜è®¢å• - æ­£å¸¸å·¥ä½œ
- [x] âœ… Mock æ”¯ä»˜æˆåŠŸ - æ­£å¸¸å·¥ä½œ
- [x] âœ… æŸ¥è¯¢è®¢å•åˆ—è¡¨ - æ­£å¸¸å·¥ä½œ
- [x] âœ… æŸ¥è¯¢è®¢å•è¯¦æƒ… - æ­£å¸¸å·¥ä½œ
- [x] âœ… å¹‚ç­‰æ€§ä¿æŠ¤ - æ­£å¸¸å·¥ä½œ
- [x] âœ… å‚æ•°éªŒè¯ - æ­£å¸¸å·¥ä½œ
- [x] âœ… é”™è¯¯å¤„ç† - æ­£å¸¸å·¥ä½œ
- [x] âœ… è®¤è¯ä¿æŠ¤ - æ­£å¸¸å·¥ä½œ

### Mock æ”¯ä»˜ç³»ç»Ÿ

- [x] âœ… Mock æ”¯ä»˜æˆåŠŸæ¥å£ - æ­£å¸¸å·¥ä½œ
- [x] âœ… å¼€å‘ç¯å¢ƒå®‰å…¨æ£€æŸ¥ - æ­£å¸¸å·¥ä½œ
- [x] âœ… å¹‚ç­‰æ€§ä¿æŠ¤ - æ­£å¸¸å·¥ä½œ
- [x] âœ… ä½™é¢æ›´æ–° - æ­£å¸¸å·¥ä½œ

---

## ğŸ“‹ å®Œæ•´æµ‹è¯•æµç¨‹ç¤ºä¾‹

### æ­¥éª¤ 1: åˆ›å»ºè®¢å•

```bash
POST http://localhost:3000/api/payment/orders
Authorization: Bearer <TOKEN>
Content-Type: application/json

{
  "amount": 100,
  "coinsAmount": 1000,
  "packType": "coins_pack_1",
  "paymentProvider": "alipay",
  "description": "è´­ä¹°1000å¤©æœºå¸"
}
```

**å“åº”**: è¿”å› `order_id`

### æ­¥éª¤ 2: Mock æ”¯ä»˜æˆåŠŸ

```bash
POST http://localhost:3000/api/payment/mock/success
Authorization: Bearer <TOKEN>
Content-Type: application/json

{
  "orderId": "<ORDER_ID>"
}
```

**å“åº”**: è¿”å›æ”¯ä»˜æˆåŠŸä¿¡æ¯å’Œæ–°çš„ä½™é¢

### æ­¥éª¤ 3: éªŒè¯ç»“æœ

- âœ… è®¢å•çŠ¶æ€æ›´æ–°ä¸º `completed`
- âœ… ç”¨æˆ·å¤©æœºå¸ä½™é¢å¢åŠ 
- âœ… å¯ä»¥é€šè¿‡ `/api/coins/balance` æŸ¥è¯¢ä½™é¢

---

## âœ… éªŒæ”¶æ ‡å‡†

- âœ… ç”¨æˆ·å¯ä»¥åˆ›å»ºæ”¯ä»˜è®¢å•
- âœ… ç”¨æˆ·å¯ä»¥æŸ¥è¯¢è‡ªå·±çš„è®¢å•åˆ—è¡¨
- âœ… ç”¨æˆ·å¯ä»¥æŸ¥è¯¢å•ä¸ªè®¢å•è¯¦æƒ…
- âœ… Mock æ”¯ä»˜å¯ä»¥æ­£ç¡®å¤„ç†æˆåŠŸçŠ¶æ€
- âœ… æ”¯ä»˜æˆåŠŸåç”¨æˆ·å¤©æœºå¸ä½™é¢æ­£ç¡®å¢åŠ 
- âœ… å¹‚ç­‰æ€§ä¿æŠ¤æ­£å¸¸å·¥ä½œï¼ˆé‡å¤è°ƒç”¨ä¸ä¼šé‡å¤å‘æ”¾ï¼‰
- âœ… å‚æ•°éªŒè¯æ­£å¸¸å·¥ä½œ
- âœ… é”™è¯¯å¤„ç†æ­£ç¡®
- âœ… è®¤è¯ä¿æŠ¤æ­£å¸¸å·¥ä½œ
- âœ… `item_type` æ­£ç¡®è®¾ç½®ä¸º `'coin_pack'`

---

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

- **æ€»æµ‹è¯•ç”¨ä¾‹**: 8
- **é€šè¿‡æµ‹è¯•**: 8
- **å¤±è´¥æµ‹è¯•**: 0
- **é€šè¿‡ç‡**: 100%

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ30æ—¥  
**æµ‹è¯•çŠ¶æ€**: âœ… **å…¨éƒ¨é€šè¿‡ï¼ˆ8/8ï¼Œ100%ï¼‰**
