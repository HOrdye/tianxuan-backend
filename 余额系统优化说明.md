# 余额系统优化说明

## 🎯 优化目标

根据"数字藏经阁"的沉浸式体验和系统稳健性要求，对余额系统进行优化。

---

## 🛑 关键修复：移除默认清零逻辑

### 问题描述

**之前的逻辑**：设置充值余额时，默认清零活动赠送余额。

**风险场景**：
- 用户参加活动得了 50 币（活动余额）
- 管理员在后台手动帮他把充值余额修正为 100 币
- **结果**：那 50 个活动币没了！用户会炸毛 💥

### 修复方案

**新原则：解耦（Decoupling）**
- `setRechargeBalance` 只改充值余额，不碰其他字段
- 如果需要清零，必须是显式操作（`clearGrants: true`）
- 绝对不能作为副作用（Side Effect）发生

### 代码变更

```typescript
// ❌ 旧逻辑（已移除）
const shouldClearActivityGrant = shouldClearAllGrants || (activityCoinsGrant === undefined && clearGrants === undefined);

// ✅ 新逻辑
const shouldClearAllGrants = clearGrants === true;  // 必须显式设置为 true
const shouldClearActivityGrant = shouldClearAllGrants;  // 只在显式清零时生效
```

---

## 🎨 命名优化：藏经阁风格

### 命名变更

| 旧命名 | 新命名 | 说明 |
|--------|--------|------|
| 增币 (Bonus Coins) | 缘分币 / 散银 | 系统赠予的缘分，随时间消散（过期） |
| 天机币 (Tianji Coin) | 天机币 / 功德 / 灵石 | 保持不变或改为更符合世界观的词 |

### 前端文案建议

**不要写**：`30天有效期`

**要写**：`缘分将在 30 天后消散` ⏳

---

## 📊 数据结构优化

### API 响应格式

**GET /api/coins/balance**

```typescript
{
  "success": true,
  "data": {
    // 🎨 核心展示层（藏经阁风格）
    "total_balance": 3449,        // 总余额
    "permanent_balance": 2500,   // 永久余额（天机币：充值余额 + 活动赠送余额）
    "expiring_balance": 949,      // 限时缘分（缘分币：每日签到余额）
    
    // 📋 详情层（前端Hover显示）
    "details": {
      "recharge": 2500,           // 充值余额
      "activity": 0,              // 活动赠送余额
      "daily_grant": 949,         // 每日签到余额
      "next_expiration_date": "2025-02-14T00:00:00Z"  // 最近一笔过期时间
    },
    
    // 🔧 扣费优先级说明（便于调试）
    "deduction_priority": "优先扣除限时缘分（缘分币），再扣除永久余额（天机币）",
    
    // 原始字段（保留兼容性）
    "tianji_coins_balance": 2500,
    "daily_coins_grant": 949,
    "activity_coins_grant": 0,
    "daily_coins_grant_expires_at": "2025-02-14T00:00:00Z",
    "activity_coins_grant_expires_at": null
  }
}
```

---

## 🎨 前端显示体验优化

### 主副分离展示策略

**平时显示**（简洁）：
```
🪙 功德池：3,449
```

**点击/悬停展开**（详情）：
```
🪙 功德池：3,449

* 天机正币：2,500 (永久有效)
* 限时缘分：949 (2月14日消散) ⏳
```

### 设计原则

1. **平时只显示总余额**：用户来这里是为了解决问题，不是来算账的
2. **详情按需展开**：点击余额或鼠标悬停时才显示详情
3. **减少认知负担**：告诉用户"你有足够的钱"就够了，不要让他做数学题

---

## 🔧 管理员设置余额接口

### PUT /api/admin/users/:userId/coins/set

**默认行为**（已修复）：
- ✅ 只修改充值余额（`tianjiCoinsBalance`）
- ✅ 不修改其他字段（活动赠送余额、每日签到余额保持不变）
- ✅ 防止运营事故

**请求示例1：只修改充值余额**
```json
{
  "tianjiCoinsBalance": 2500
}
```

**结果**：
- `tianji_coins_balance` = 2500 ✅
- `activity_coins_grant` = 0（保持不变）✅
- `daily_coins_grant` = 949（保持不变）✅

**请求示例2：显式清零所有赠送余额**
```json
{
  "tianjiCoinsBalance": 2500,
  "clearGrants": true
}
```

**结果**：
- `tianji_coins_balance` = 2500
- `activity_coins_grant` = 0（已清零）
- `daily_coins_grant` = 0（已清零）

---

## 🔄 扣费逻辑（保持不变）

**扣费优先级**：
1. 优先扣除限时缘分（缘分币）- 有有效期，优先使用
2. 再扣除永久余额（天机币）- 无有效期限制

这是行业最佳实践（User First），能有效减少用户投诉。

---

## 📝 总结

### 修复内容

1. ✅ **移除默认清零逻辑**：防止运营事故
2. ✅ **优化数据结构**：增加 `permanent_balance`、`expiring_balance`、`details` 等字段
3. ✅ **优化命名**：改为更符合"藏经阁"风格的命名
4. ✅ **优化前端显示**：主副分离，平时只显示总余额

### 核心原则

- **解耦**：设置充值余额时，不碰其他字段
- **显式操作**：清零必须显式设置 `clearGrants: true`
- **用户体验**：减少认知负担，平时只显示总余额
- **系统稳健性**：防止运营事故，保护用户权益

---

## 📚 相关文件

- `src/services/coins.service.ts` - 余额服务实现
- `src/controllers/coins.controller.ts` - 余额控制器
- `src/routes/coins.routes.ts` - 余额路由配置
