# é€€æ¬¾æ¥å£å‚æ•°æ˜ å°„é—®é¢˜ - åç«¯ä¿®å¤æç¤º

## ğŸš¨ é—®é¢˜æè¿°

æµ‹è¯•é€€æ¬¾åŠŸèƒ½æ—¶ï¼Œæ‰€æœ‰é€€æ¬¾è¯·æ±‚éƒ½è¿”å›500é”™è¯¯ï¼š
```
null value in column "amount" of relation "refund_logs" violates not-null constraint
```

## ğŸ” é—®é¢˜åˆ†æ

### å‰ç«¯å‘é€çš„æ•°æ®æ ¼å¼

å‰ç«¯è°ƒç”¨ `paymentApi.createRefundLog()` æ—¶å‘é€çš„æ•°æ®ï¼š
```json
{
  "amount": 10,
  "reason": "æµ‹è¯•é€€æ¬¾ - ä»…æ¯æ—¥èµ é€ä½™é¢",
  "original_request_id": "test_refund_daily_1234567890",
  "deduction": {
    "daily_coins_grant": 10,
    "activity_coins_grant": 0,
    "tianji_coins_balance": 0
  }
}
```

### åç«¯æœŸæœ›çš„æ•°æ®æ ¼å¼

æ ¹æ®é”™è¯¯ä¿¡æ¯ï¼Œåç«¯æ¥å£æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

**æ¨¡å¼1: è®¢å•é€€æ¬¾**
```json
{
  "orderId": "uuid",
  "refundAmount": 100,
  "refundCoins": 1000,
  "refundReason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"
}
```

**æ¨¡å¼2: AIæœåŠ¡é€€æ¬¾**
```json
{
  "amount": 10,
  "reason": "æœåŠ¡å¤±è´¥é€€æ¬¾",
  "original_request_id": "request_id",
  "deduction": {
    "daily_coins_grant": 10,
    "activity_coins_grant": 0,
    "tianji_coins_balance": 0
  }
}
```

### é—®é¢˜æ ¹æº

åç«¯åœ¨å¤„ç† AI æœåŠ¡é€€æ¬¾æ¨¡å¼æ—¶ï¼Œ**æ²¡æœ‰æ­£ç¡®å°† `amount` å­—æ®µæ˜ å°„åˆ°æ•°æ®åº“çš„ `amount` å­—æ®µ**ï¼Œå¯¼è‡´æ’å…¥æ•°æ®åº“æ—¶ `amount` ä¸º nullã€‚

## ğŸ”§ åç«¯éœ€è¦ä¿®å¤çš„å†…å®¹

### 1. æ£€æŸ¥å‚æ•°æ˜ å°„é€»è¾‘

**ä½ç½®**ï¼š`backend/src/controllers/payment.controller.ts` æˆ– `backend/src/services/payment.service.ts`

**é—®é¢˜**ï¼šåœ¨å¤„ç† AI æœåŠ¡é€€æ¬¾æ—¶ï¼Œéœ€è¦ç¡®ä¿ï¼š
- `amount` å‚æ•°æ­£ç¡®ä¼ é€’åˆ°æ•°æ®åº“æ’å…¥æ“ä½œ
- æ•°æ®åº“å­—æ®µåæ˜¯ `amount`ï¼ˆä¸æ˜¯ `refundAmount`ï¼‰

### 2. æ£€æŸ¥æ•°æ®åº“æ’å…¥ä»£ç 

**ç¤ºä¾‹ä»£ç **ï¼ˆéœ€è¦æ£€æŸ¥ï¼‰ï¼š
```typescript
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå
await db.insert('refund_logs', {
  refund_amount: params.amount,  // é”™è¯¯ï¼šå­—æ®µåä¸åŒ¹é…
  // ...
});

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
await db.insert('refund_logs', {
  amount: params.amount,  // æ­£ç¡®ï¼šå­—æ®µååŒ¹é…
  reason: params.reason,
  original_request_id: params.original_request_id,
  original_deduction: params.deduction ? JSON.stringify(params.deduction) : null,
  // ...
});
```

### 3. æ£€æŸ¥å‚æ•°éªŒè¯é€»è¾‘

ç¡®ä¿å‚æ•°éªŒè¯é€»è¾‘æ­£ç¡®è¯†åˆ« AI æœåŠ¡é€€æ¬¾æ¨¡å¼ï¼š
```typescript
// æ£€æŸ¥æ˜¯å¦æœ‰ amount å‚æ•°ï¼ˆAIæœåŠ¡é€€æ¬¾æ¨¡å¼ï¼‰
if (params.amount) {
  // AIæœåŠ¡é€€æ¬¾æ¨¡å¼
  // éªŒè¯ amount > 0
  // éªŒè¯ reason å­˜åœ¨
  // æ’å…¥æ•°æ®åº“æ—¶ä½¿ç”¨ amount å­—æ®µ
} else if (params.orderId && params.refundAmount) {
  // è®¢å•é€€æ¬¾æ¨¡å¼
  // ...
}
```

## ğŸ“‹ æ•°æ®åº“è¡¨ç»“æ„å‚è€ƒ

æ ¹æ® `scripts/v5.1.7-add-refund-logs-migration.sql`ï¼š

```sql
CREATE TABLE IF NOT EXISTS public.refund_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  amount INTEGER NOT NULL CHECK (amount > 0),  -- âš ï¸ å­—æ®µåæ˜¯ amountï¼Œä¸æ˜¯ refund_amount
  reason TEXT NOT NULL CHECK (reason IN ('service_unavailable', 'user_cancelled', 'error', 'other')),
  original_deduction JSONB,
  original_request_id VARCHAR(255),
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT refund_logs_amount_positive CHECK (amount > 0)
);
```

**å…³é”®ç‚¹**ï¼š
- å­—æ®µåæ˜¯ `amount`ï¼ˆä¸æ˜¯ `refund_amount`ï¼‰
- `amount` å­—æ®µæ˜¯ `NOT NULL`ï¼Œå¿…é¡»æä¾›å€¼
- `amount` å¿…é¡»æ˜¯æ­£æ•´æ•°ï¼ˆCHECKçº¦æŸï¼‰

## âœ… ä¿®å¤æ£€æŸ¥æ¸…å•

- [ ] æ£€æŸ¥å‚æ•°æ˜ å°„ï¼šç¡®ä¿ `params.amount` æ­£ç¡®æ˜ å°„åˆ°æ•°æ®åº“ `amount` å­—æ®µ
- [ ] æ£€æŸ¥å­—æ®µåï¼šç¡®ä¿ä½¿ç”¨ `amount` è€Œä¸æ˜¯ `refundAmount` æˆ– `refund_amount`
- [ ] æ£€æŸ¥å‚æ•°éªŒè¯ï¼šç¡®ä¿ AI æœåŠ¡é€€æ¬¾æ¨¡å¼çš„å‚æ•°éªŒè¯æ­£ç¡®
- [ ] æµ‹è¯•ä¿®å¤ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ

## ğŸ§ª æµ‹è¯•éªŒè¯

ä¿®å¤åï¼Œä½¿ç”¨ä»¥ä¸‹æµ‹è¯•éªŒè¯ï¼š

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ
await refundTest.testRefundDailyGrantOnly();
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¿”å›æˆåŠŸå“åº”
- âœ… ä½™é¢æ­£ç¡®å¢åŠ 
- âœ… é€€æ¬¾æ—¥å¿—æ­£ç¡®è®°å½•

## ğŸ“ ç›¸å…³æ–‡ä»¶

- åç«¯æ§åˆ¶å™¨ï¼š`backend/src/controllers/payment.controller.ts`
- åç«¯æœåŠ¡ï¼š`backend/src/services/payment.service.ts`
- æ•°æ®åº“è¿ç§»ï¼š`scripts/v5.1.7-add-refund-logs-migration.sql`
- å‰ç«¯APIï¼š`src/api/modules/payment.ts`
- å‰ç«¯å·¥å…·ï¼š`src/utils/refundHelper.ts`
