# 退款功能测试问题分析

## 🚨 测试结果

**测试日期**: 2025-01-30
**测试环境**: 开发环境
**测试结果**: 5/7 测试失败

### 失败的测试

1. ❌ **测试1: 精确退款 - 仅每日赠送余额**
   - 错误: `null value in column "amount" of relation "refund_logs" violates not-null constraint`
   - 原因: 后端接口参数映射问题

2. ❌ **测试2: 精确退款 - 仅储值余额**
   - 错误: 同上
   - 原因: 后端接口参数映射问题

3. ❌ **测试3: 精确退款 - 混合扣费**
   - 错误: 同上
   - 原因: 后端接口参数映射问题

4. ❌ **测试4: 降级方案 - 无扣费明细**
   - 错误: 同上
   - 原因: 后端接口参数映射问题

5. ❌ **测试7: 错误处理**
   - 错误: `参数错误：必须提供订单退款参数（orderId, refundAmount, refundCoins）或AI服务退款参数（amount, reason, original_request_id）`
   - 原因: 后端参数验证逻辑问题

### 通过的测试

1. ✅ **测试5: 幂等性测试**
   - 结果: 通过（虽然退款失败，但幂等性逻辑正确）

2. ✅ **测试6: 边界情况 - 退款金额为0**
   - 结果: 通过（前端正确返回"无需退款"）

## 🔍 问题分析

### 问题1: amount 字段为 null

**错误信息**:
```
null value in column "amount" of relation "refund_logs" violates not-null constraint
```

**原因分析**:
- 前端发送的数据包含 `amount: 10`
- 后端接收到请求，但插入数据库时 `amount` 字段为 null
- 说明后端在参数映射时出现问题

**可能的原因**:
1. 后端参数验证逻辑错误，没有正确识别 AI 服务退款模式
2. 后端在插入数据库时，使用了错误的字段名（如 `refundAmount` 而不是 `amount`）
3. 后端参数解构时，`amount` 字段丢失

### 问题2: 参数验证错误

**错误信息**:
```
参数错误：必须提供订单退款参数（orderId, refundAmount, refundCoins）或AI服务退款参数（amount, reason, original_request_id）
```

**原因分析**:
- 前端发送了 `amount, reason, original_request_id` 和 `deduction`
- 后端参数验证逻辑可能没有正确识别这些参数

**可能的原因**:
1. 后端参数验证逻辑过于严格，要求所有参数都必须存在
2. 后端没有正确处理 `deduction` 字段（可能将其视为额外参数）

## 🔧 后端需要修复的内容

### 1. 修复参数映射问题

**位置**: `backend/src/controllers/payment.controller.ts` 或 `backend/src/services/payment.service.ts`

**需要检查**:
```typescript
// 检查参数接收
const { amount, reason, original_request_id, deduction } = req.body;

// 检查数据库插入
await db.insert('refund_logs', {
  amount: amount,  // ⚠️ 确保使用 amount 而不是 refundAmount
  reason: reason,
  original_request_id: original_request_id,
  original_deduction: deduction ? JSON.stringify(deduction) : null,
  user_id: userId,
  timestamp: new Date()
});
```

### 2. 修复参数验证逻辑

**需要检查**:
```typescript
// 参数验证逻辑
if (req.body.amount && req.body.reason) {
  // AI服务退款模式
  // 验证 amount > 0
  // 验证 reason 存在
  // deduction 是可选的
} else if (req.body.orderId && req.body.refundAmount) {
  // 订单退款模式
  // ...
} else {
  // 参数错误
  throw new Error('参数错误：必须提供订单退款参数或AI服务退款参数');
}
```

### 3. 检查数据库字段名

**需要确认**:
- 数据库表 `refund_logs` 的字段名是 `amount`（不是 `refund_amount`）
- 插入时使用的字段名与数据库字段名一致

## 📋 测试建议

### 修复后测试步骤

1. **修复后端代码**
   - 修复参数映射问题
   - 修复参数验证逻辑

2. **运行调试测试**
   ```javascript
   // 在浏览器控制台运行
   // 复制 test/refund-test-debug.js 的内容
   ```

3. **运行完整测试**
   ```javascript
   await refundTest.runAllTests();
   ```

4. **验证结果**
   - 所有测试应该通过
   - 余额应该正确增加
   - 退款日志应该正确记录

## 📝 相关文档

- `docs/退款接口参数映射问题-后端修复提示.md` - 详细的后端修复指南
- `test/refund-test-debug.js` - 调试测试脚本
- `test/refund-test.js` - 完整测试脚本
