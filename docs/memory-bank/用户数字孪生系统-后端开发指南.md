# ç”¨æˆ·æ•°å­—å­ªç”Ÿç³»ç»Ÿ - åç«¯å¼€å‘æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-31  
**ç›®æ ‡**ï¼šå‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œåç«¯å…ˆè¡Œ

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“ç»“æ„å˜æ›´](#æ•°æ®åº“ç»“æ„å˜æ›´)
2. [APIæ¥å£å®šä¹‰](#apiæ¥å£å®šä¹‰)
3. [ä¸šåŠ¡é€»è¾‘å®ç°](#ä¸šåŠ¡é€»è¾‘å®ç°)
4. [æ•°æ®åŒæ­¥æœºåˆ¶](#æ•°æ®åŒæ­¥æœºåˆ¶)
5. [å¥–åŠ±æœºåˆ¶](#å¥–åŠ±æœºåˆ¶)
6. [éšæ€§ä¿¡æ¯æå–](#éšæ€§ä¿¡æ¯æå–)

---

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„å˜æ›´

### 1. profiles è¡¨æ‰©å±•

#### 1.1 æ–°å¢å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

```sql
-- æ£€æŸ¥å¹¶æ·»åŠ  implicit_traits å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'profiles' AND column_name = 'implicit_traits'
    ) THEN
        ALTER TABLE profiles 
        ADD COLUMN implicit_traits JSONB DEFAULT '{}'::jsonb;
    END IF;
END $$;
```

#### 1.2 preferences JSONB å­—æ®µç»“æ„

**å½“å‰ç»“æ„**ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š
```json
{
  "userContext": {
    "mbti": "INTP",
    "currentStatus": "åˆšè¢«è£å‘˜ï¼Œæƒ³åˆ›ä¸š",
    "identity": "ç´«å¾®ä¸ƒæ€Â·åŒ–æ€ä¸ºæƒ"
  }
}
```

**æ‰©å±•åç»“æ„**ï¼ˆéœ€è¦æ”¯æŒï¼‰ï¼š
```json
{
  "userContext": {
    "mbti": "INTP",
    "currentStatus": "åˆšè¢«è£å‘˜ï¼Œæƒ³åˆ›ä¸š",
    "identity": "ç´«å¾®ä¸ƒæ€Â·åŒ–æ€ä¸ºæƒ",
    "profession": "ç‹¬ç«‹å¼€å‘è€…",
    "wishes": ["è´¢åŠ¡è‡ªç”±", "å®¶åº­å’Œç¦"],
    "energyLevel": "balanced"
  },
  "implicit_traits": {
    "inferred_roles": ["parent", "spouse"],
    "interest_tags": ["wealth", "career", "relationship"],
    "risk_tolerance": "medium",
    "interaction_style": "detailed",
    "last_active_topic": "career"
  }
}
```

**æ³¨æ„**ï¼š`implicit_traits` å¯ä»¥å­˜å‚¨åœ¨ `preferences.implicit_traits` æˆ–ç‹¬ç«‹çš„ `implicit_traits` å­—æ®µä¸­ï¼Œå»ºè®®ä½¿ç”¨ç‹¬ç«‹å­—æ®µä¾¿äºæŸ¥è¯¢å’Œç´¢å¼•ã€‚

---

## ğŸ”Œ APIæ¥å£å®šä¹‰

### 1. ç”¨æˆ·èµ„æ–™ç›¸å…³æ¥å£

#### 1.1 è·å–ç”¨æˆ·èµ„æ–™ï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ‰©å±•ï¼‰

**æ¥å£**ï¼š`GET /api/user/profile`

**å“åº”æ‰©å±•**ï¼š
```typescript
{
  success: boolean;
  data: {
    id: string;
    email: string;
    username: string;
    avatar_url?: string;
    // ... å…¶ä»–ç°æœ‰å­—æ®µ
    
    // æ–°å¢ï¼šæ‰©å±•çš„ preferences ç»“æ„
    preferences: {
      userContext?: {
        mbti?: string;
        currentStatus?: string;
        identity?: string;
        profession?: string;
        wishes?: string[];
        energyLevel?: 'strong' | 'weak' | 'balanced';
      };
      implicit_traits?: {
        inferred_roles?: string[];
        interest_tags?: string[];
        risk_tolerance?: 'low' | 'medium' | 'high';
        interaction_style?: 'concise' | 'detailed';
        last_active_topic?: string;
        family_structure?: {
          has_spouse?: boolean;
          has_children?: boolean;
          children_count?: number;
        };
        profession_hints?: string[];
      };
    };
    
    // æ–°å¢ï¼šèµ„æ–™å®Œæ•´åº¦ï¼ˆè®¡ç®—å­—æ®µï¼‰
    completeness?: number; // 0-100
  };
  message?: string;
}
```

#### 1.2 æ›´æ–°ç”¨æˆ·èµ„æ–™ï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ‰©å±•ï¼‰

**æ¥å£**ï¼š`PUT /api/user/profile`

**è¯·æ±‚ä½“æ‰©å±•**ï¼š
```typescript
{
  // ç°æœ‰å­—æ®µ...
  
  // æ–°å¢ï¼šæ”¯æŒæ›´æ–° userContext
  preferences?: {
    userContext?: {
      mbti?: string;
      currentStatus?: string;
      identity?: string;
      profession?: string;
      wishes?: string[];
      energyLevel?: 'strong' | 'weak' | 'balanced';
    };
  };
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. æ›´æ–° `profiles` è¡¨çš„ `preferences.userContext` å­—æ®µ
2. **è‡ªåŠ¨è§¦å‘**ï¼šå¦‚æœæ›´æ–°äº† `birth_date` æˆ– `birthday`ï¼Œè°ƒç”¨ `syncBirthdayToUserContext` é’©å­
3. **è‡ªåŠ¨è§¦å‘**ï¼šè®¡ç®—èµ„æ–™å®Œæ•´åº¦ï¼Œå¦‚æœè¾¾åˆ°å¥–åŠ±é˜ˆå€¼ï¼Œè°ƒç”¨å¥–åŠ±å‘æ”¾é€»è¾‘

---

### 2. å‘½ä¸»ååˆºç›¸å…³æ¥å£ï¼ˆæ–°å¢ï¼‰

#### 2.1 è·å–å‘½ä¸»ååˆº

**æ¥å£**ï¼š`GET /api/user/destiny-card`

**å“åº”**ï¼š
```typescript
{
  success: boolean;
  data: {
    mbti?: string;
    currentStatus?: string;
    identity?: string;
    profession?: string;
    wishes?: string[];
    energyLevel?: 'strong' | 'weak' | 'balanced';
    completeness: number; // 0-100
    lastUpdated: string; // ISO 8601
  };
  message?: string;
}
```

#### 2.2 æ›´æ–°å‘½ä¸»ååˆº

**æ¥å£**ï¼š`PUT /api/user/destiny-card`

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  mbti?: string;
  currentStatus?: string;
  identity?: string;
  profession?: string;
  wishes?: string[];
  energyLevel?: 'strong' | 'weak' | 'balanced';
}
```

**å“åº”**ï¼š
```typescript
{
  success: boolean;
  data: {
    // æ›´æ–°åçš„å®Œæ•´æ•°æ®
    mbti?: string;
    currentStatus?: string;
    identity?: string;
    profession?: string;
    wishes?: string[];
    energyLevel?: 'strong' | 'weak' | 'balanced';
    completeness: number;
    rewardGranted?: {
      coins: number;
      reason: string; // å¦‚ï¼š"å®Œå–„MBTIä¿¡æ¯"
    };
  };
  message?: string;
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. æ›´æ–° `profiles.preferences.userContext` å­—æ®µ
2. è®¡ç®—æ–°çš„å®Œæ•´åº¦
3. æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢å­—æ®µï¼ˆä¸æ—§æ•°æ®å¯¹æ¯”ï¼‰
4. å¦‚æœæœ‰æ–°å¢å­—æ®µï¼Œå‘æ”¾å¥–åŠ±ï¼ˆæ¯å­—æ®µ +5 å¤©æœºå¸ï¼‰
5. è¿”å›æ›´æ–°åçš„æ•°æ®å’Œå¥–åŠ±ä¿¡æ¯

---

### 3. èµ„æ–™å®Œæ•´åº¦æ¥å£ï¼ˆæ–°å¢ï¼‰

#### 3.1 è·å–èµ„æ–™å®Œæ•´åº¦

**æ¥å£**ï¼š`GET /api/user/completeness`

**å“åº”**ï¼š
```typescript
{
  success: boolean;
  data: {
    completeness: number; // 0-100
    breakdown: {
      birthData: { filled: boolean; score: number; maxScore: number; }; // 40åˆ†
      mbti: { filled: boolean; score: number; maxScore: number; }; // 10åˆ†
      profession: { filled: boolean; score: number; maxScore: number; }; // 10åˆ†
      currentStatus: { filled: boolean; score: number; maxScore: number; }; // 20åˆ†
      wishes: { filled: boolean; score: number; maxScore: number; }; // 20åˆ†
    };
    nextRewardThreshold?: number; // ä¸‹ä¸€ä¸ªå¥–åŠ±é˜ˆå€¼ï¼ˆå¦‚ï¼š30, 50, 70, 100ï¼‰
  };
  message?: string;
}
```

---

### 4. ç”Ÿè¾°ä¿¡æ¯åŒæ­¥æ¥å£ï¼ˆæ–°å¢ï¼‰

#### 4.1 åŒæ­¥ç”Ÿè¾°åˆ°ç”¨æˆ·ä¸Šä¸‹æ–‡

**æ¥å£**ï¼š`POST /api/user/sync-birthday-to-context`

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  birthDate: string; // ISO 8601 æ—¥æœŸå­—ç¬¦ä¸²
  birthTime?: string; // HH:mm æ ¼å¼
  birthLocation?: string;
  gender?: 'male' | 'female';
}
```

**å“åº”**ï¼š
```typescript
{
  success: boolean;
  data: {
    synced: boolean;
    userContextUpdated: boolean;
    identityGenerated?: string; // å¦‚æœç”Ÿæˆäº†å‘½æ ¼æ³•ç›¸
  };
  message?: string;
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. æ›´æ–° `profiles.birth_date` å­—æ®µ
2. åŒæ­¥åˆ° `profiles.preferences.userContext`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
3. å¦‚æœç”¨æˆ·æœ‰å‘½ç›˜æ•°æ®ï¼Œå°è¯•ç”Ÿæˆ `identity`ï¼ˆå‘½æ ¼æ³•ç›¸ï¼‰
4. æ›´æ–° `profiles.preferences.userContext.identity`

---

### 5. éšæ€§ä¿¡æ¯ç›¸å…³æ¥å£ï¼ˆæ–°å¢ï¼‰

#### 5.1 è·å–éšæ€§ä¿¡æ¯

**æ¥å£**ï¼š`GET /api/user/implicit-traits`

**å“åº”**ï¼š
```typescript
{
  success: boolean;
  data: {
    inferred_roles?: string[];
    interest_tags?: string[];
    risk_tolerance?: 'low' | 'medium' | 'high';
    interaction_style?: 'concise' | 'detailed';
    last_active_topic?: string;
    family_structure?: {
      has_spouse?: boolean;
      has_children?: boolean;
      children_count?: number;
    };
    profession_hints?: string[];
  };
  message?: string;
}
```

#### 5.2 æ›´æ–°éšæ€§ä¿¡æ¯ï¼ˆç³»ç»Ÿå†…éƒ¨è°ƒç”¨ï¼‰

**æ¥å£**ï¼š`POST /api/user/implicit-traits`ï¼ˆå†…éƒ¨æ¥å£ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™æˆ–ç³»ç»Ÿè°ƒç”¨ï¼‰

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  inferred_roles?: string[];
  interest_tags?: string[];
  risk_tolerance?: 'low' | 'medium' | 'high';
  interaction_style?: 'concise' | 'detailed';
  last_active_topic?: string;
  family_structure?: {
    has_spouse?: boolean;
    has_children?: boolean;
    children_count?: number;
  };
  profession_hints?: string[];
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. **æƒé™æ£€æŸ¥**ï¼šéªŒè¯è°ƒç”¨è€…æ˜¯å¦æœ‰æƒé™ï¼ˆç®¡ç†å‘˜æˆ–ç³»ç»Ÿè°ƒç”¨ï¼‰
2. **Tokené™åˆ¶**ï¼šæ£€æŸ¥éšæ€§ä¿¡æ¯å†…å®¹é•¿åº¦ï¼Œé˜²æ­¢Tokençˆ†ç‚¸ï¼ˆè§ä¸‹æ–¹Tokenç†”æ–­æœºåˆ¶ï¼‰
3. åˆå¹¶æ›´æ–°ï¼ˆä¸æ˜¯è¦†ç›–ï¼Œæ˜¯åˆå¹¶å»é‡ï¼‰
4. æ•°ç»„å­—æ®µï¼šåˆå¹¶å»é‡ï¼ˆå¦‚ `inferred_roles`ï¼‰
5. å¯¹è±¡å­—æ®µï¼šæ·±åº¦åˆå¹¶ï¼ˆå¦‚ `family_structure`ï¼‰
6. æ ‡é‡å­—æ®µï¼šç›´æ¥æ›´æ–°

**Tokenç†”æ–­æœºåˆ¶**ï¼š
```typescript
// é™åˆ¶éšæ€§ä¿¡æ¯çš„æ€»é•¿åº¦ï¼Œé˜²æ­¢Tokençˆ†ç‚¸
const MAX_IMPLICIT_TRAITS_TOKENS = 200; // æœ€å¤š200 tokens

function validateImplicitTraits(traits: ImplicitTraits): void {
  // ä¼°ç®—Tokenæ•°ï¼ˆç®€å•ä¼°ç®—ï¼š1 token â‰ˆ 4å­—ç¬¦ï¼‰
  const traitsStr = JSON.stringify(traits);
  const estimatedTokens = traitsStr.length / 4;
  
  if (estimatedTokens > MAX_IMPLICIT_TRAITS_TOKENS) {
    // æˆªæ–­æ•°ç»„å­—æ®µ
    if (traits.inferred_roles && traits.inferred_roles.length > 3) {
      traits.inferred_roles = traits.inferred_roles.slice(0, 3);
    }
    if (traits.interest_tags && traits.interest_tags.length > 5) {
      traits.interest_tags = traits.interest_tags.slice(0, 5);
    }
    if (traits.profession_hints && traits.profession_hints.length > 3) {
      traits.profession_hints = traits.profession_hints.slice(0, 3);
    }
    
    console.warn(`Implicit traits truncated to fit token limit`);
  }
}
```

#### 5.3 åˆ é™¤éšæ€§ä¿¡æ¯ï¼ˆç”¨æˆ·æ“ä½œï¼‰

**æ¥å£**ï¼š`DELETE /api/user/implicit-traits`

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  fields?: string[]; // è¦åˆ é™¤çš„å­—æ®µï¼Œå¦‚ ["inferred_roles", "interest_tags"]
  // å¦‚æœä¸æä¾›ï¼Œåˆ é™¤æ‰€æœ‰éšæ€§ä¿¡æ¯
}
```

---

## ğŸ”§ ä¸šåŠ¡é€»è¾‘å®ç°

### 1. èµ„æ–™å®Œæ•´åº¦è®¡ç®—

**è®¡ç®—è§„åˆ™**ï¼š
```typescript
function calculateCompleteness(userContext: UserContextData, birthData?: BirthData): number {
  let score = 0;
  
  // åŸºçŸ³å±‚ï¼ˆ40åˆ†ï¼‰
  if (birthData?.birthDate) {
    score += 40;
  }
  
  // æ˜¾æ€§å±‚ï¼ˆ60åˆ†ï¼‰
  if (userContext.mbti) {
    score += 10;
  }
  if (userContext.profession) {
    score += 10;
  }
  if (userContext.currentStatus) {
    score += 20;
  }
  if (userContext.wishes && userContext.wishes.length > 0) {
    score += 20;
  }
  
  return Math.min(score, 100);
}
```

### 2. å¥–åŠ±å‘æ”¾é€»è¾‘ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰

**è§¦å‘æ—¶æœº**ï¼š
1. ç”¨æˆ·æ›´æ–°å‘½ä¸»ååˆºæ—¶ï¼Œæ£€æµ‹åˆ°æ–°å¢å­—æ®µ
2. ç”¨æˆ·å®Œå–„èµ„æ–™è¾¾åˆ°ç‰¹å®šé˜ˆå€¼ï¼ˆ30, 50, 70, 100ï¼‰

**å¹‚ç­‰æ€§ä¿è¯**ï¼š
- ä½¿ç”¨ `completeness_rewards` è¡¨è®°å½•å·²å‘æ”¾çš„å¥–åŠ±
- é˜²æ­¢ç”¨æˆ·é‡å¤æäº¤èµ„æ–™åˆ·é‡‘å¸
- ä½¿ç”¨å”¯ä¸€çº¦æŸï¼š`UNIQUE(user_id, reward_type, reward_field, reward_threshold)`

**å¥–åŠ±è§„åˆ™**ï¼š
```typescript
interface RewardRule {
  field: string; // å­—æ®µåï¼Œå¦‚ "mbti", "profession"
  coins: number; // å¥–åŠ±å¤©æœºå¸æ•°é‡
  reason: string; // å¥–åŠ±åŸå› 
}

const REWARD_RULES: RewardRule[] = [
  { field: 'mbti', coins: 5, reason: 'å®Œå–„MBTIä¿¡æ¯' },
  { field: 'profession', coins: 5, reason: 'å®Œå–„èŒä¸šä¿¡æ¯' },
  { field: 'currentStatus', coins: 5, reason: 'å®Œå–„ç°çŠ¶æè¿°' },
  { field: 'wishes', coins: 5, reason: 'å®Œå–„æ„¿æ™¯ç›®æ ‡' },
];

// é˜ˆå€¼å¥–åŠ±
const THRESHOLD_REWARDS: { threshold: number; coins: number; reason: string }[] = [
  { threshold: 30, coins: 10, reason: 'èµ„æ–™å®Œæ•´åº¦è¾¾åˆ°30%' },
  { threshold: 50, coins: 20, reason: 'èµ„æ–™å®Œæ•´åº¦è¾¾åˆ°50%' },
  { threshold: 70, coins: 30, reason: 'èµ„æ–™å®Œæ•´åº¦è¾¾åˆ°70%' },
  { threshold: 100, coins: 50, reason: 'èµ„æ–™å®Œæ•´åº¦è¾¾åˆ°100%' },
];
```

**å®ç°é€»è¾‘**ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰ï¼š
```typescript
async function grantRewardForCompleteness(
  userId: string,
  oldCompleteness: number,
  newCompleteness: number,
  newFields: string[]
): Promise<RewardResult[]> {
  const rewards: RewardResult[] = [];
  
  // 1. å­—æ®µå¥–åŠ±ï¼ˆæ£€æŸ¥æ˜¯å¦å·²å‘æ”¾ï¼‰
  for (const field of newFields) {
    const rule = REWARD_RULES.find(r => r.field === field);
    if (rule) {
      // æ£€æŸ¥æ˜¯å¦å·²å‘æ”¾ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
      const alreadyGranted = await checkRewardGranted(
        userId, 
        'field_reward', 
        field
      );
      
      if (!alreadyGranted) {
        // å‘æ”¾å¥–åŠ±
        await grantCoins(userId, rule.coins, rule.reason);
        
        // è®°å½•å¥–åŠ±ï¼ˆé˜²æ­¢é‡å¤å‘æ”¾ï¼‰
        await recordReward({
          userId,
          rewardType: 'field_reward',
          rewardField: field,
          coins: rule.coins,
          reason: rule.reason
        });
        
        rewards.push({
          coins: rule.coins,
          reason: rule.reason,
          field: field
        });
      }
    }
  }
  
  // 2. é˜ˆå€¼å¥–åŠ±ï¼ˆæ£€æŸ¥æ˜¯å¦å·²å‘æ”¾ï¼‰
  for (const thresholdReward of THRESHOLD_REWARDS) {
    if (oldCompleteness < thresholdReward.threshold && 
        newCompleteness >= thresholdReward.threshold) {
      // æ£€æŸ¥æ˜¯å¦å·²å‘æ”¾ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
      const alreadyGranted = await checkRewardGranted(
        userId,
        'threshold_reward',
        null,
        thresholdReward.threshold
      );
      
      if (!alreadyGranted) {
        // å‘æ”¾å¥–åŠ±
        await grantCoins(userId, thresholdReward.coins, thresholdReward.reason);
        
        // è®°å½•å¥–åŠ±
        await recordReward({
          userId,
          rewardType: 'threshold_reward',
          rewardThreshold: thresholdReward.threshold,
          coins: thresholdReward.coins,
          reason: thresholdReward.reason
        });
        
        rewards.push({
          coins: thresholdReward.coins,
          reason: thresholdReward.reason
        });
      }
    }
  }
  
  return rewards;
}

/**
 * æ£€æŸ¥å¥–åŠ±æ˜¯å¦å·²å‘æ”¾ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
 */
async function checkRewardGranted(
  userId: string,
  rewardType: 'field_reward' | 'threshold_reward',
  rewardField?: string,
  rewardThreshold?: number
): Promise<boolean> {
  const existing = await db.query(
    `SELECT 1 FROM completeness_rewards 
     WHERE user_id = $1 
       AND reward_type = $2 
       AND ($3::text IS NULL OR reward_field = $3)
       AND ($4::int IS NULL OR reward_threshold = $4)
     LIMIT 1`,
    [userId, rewardType, rewardField || null, rewardThreshold || null]
  );
  
  return existing.length > 0;
}

/**
 * è®°å½•å¥–åŠ±ï¼ˆé˜²æ­¢é‡å¤å‘æ”¾ï¼‰
 */
async function recordReward(reward: {
  userId: string;
  rewardType: string;
  rewardField?: string;
  rewardThreshold?: number;
  coins: number;
  reason: string;
}): Promise<void> {
  try {
    await db.insert('completeness_rewards', {
      user_id: reward.userId,
      reward_type: reward.rewardType,
      reward_field: reward.rewardField || null,
      reward_threshold: reward.rewardThreshold || null,
      coins: reward.coins,
      reason: reward.reason
    });
  } catch (error: any) {
    // å¦‚æœæ˜¯å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜å·²å‘æ”¾è¿‡ï¼Œå¿½ç•¥é”™è¯¯
    if (error.code === '23505') { // PostgreSQL unique violation
      console.log(`Reward already granted: ${reward.reason}`);
      return;
    }
    throw error;
  }
}
```

### 3. ç”Ÿè¾°ä¿¡æ¯åŒæ­¥é’©å­

**å®ç°é€»è¾‘**ï¼š
```typescript
async function syncBirthdayToUserContext(
  userId: string,
  birthData: {
    birthDate: string;
    birthTime?: string;
    birthLocation?: string;
    gender?: 'male' | 'female';
  }
): Promise<SyncResult> {
  // 1. æ›´æ–° profiles.birth_date
  await updateProfile(userId, {
    birth_date: birthData.birthDate,
    gender: birthData.gender
  });
  
  // 2. è·å–å½“å‰ userContext
  const profile = await getProfile(userId);
  const userContext = profile.preferences?.userContext || {};
  
  // 3. å¦‚æœ userContext ä¸­æ²¡æœ‰ identityï¼Œå°è¯•ä»å‘½ç›˜ç”Ÿæˆ
  if (!userContext.identity) {
    // è°ƒç”¨å‘½ç›˜ç”ŸæˆæœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    // const chart = await generateChartFromBirthday(birthData);
    // if (chart) {
    //   userContext.identity = generateIdentityTag(chart);
    // }
  }
  
  // 4. æ›´æ–° preferences.userContext
  await updateProfile(userId, {
    preferences: {
      ...profile.preferences,
      userContext: {
        ...userContext,
        // ç¡®ä¿ç”Ÿè¾°ä¿¡æ¯åŒæ­¥
      }
    }
  });
  
  return {
    synced: true,
    userContextUpdated: true,
    identityGenerated: userContext.identity
  };
}
```

---

## ğŸ”„ æ•°æ®åŒæ­¥æœºåˆ¶

### 1. è‡ªåŠ¨åŒæ­¥è§¦å‘ç‚¹

**è§¦å‘æ—¶æœº**ï¼š
1. **æ›´æ–°ç”¨æˆ·èµ„æ–™æ—¶**ï¼šå¦‚æœæ›´æ–°äº† `birth_date` æˆ– `birthday`ï¼Œ**æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥**ï¼ˆä¸ä¾èµ–ä¸šåŠ¡ä»£ç ï¼‰
2. **æ›´æ–°å‘½ä¸»ååˆºæ—¶**ï¼šè‡ªåŠ¨è®¡ç®—å®Œæ•´åº¦ï¼Œè§¦å‘å¥–åŠ±æ£€æŸ¥

**å®ç°æ–¹å¼**ï¼š
- **ä»¥æ•°æ®åº“è§¦å‘å™¨ä¸ºå‡†**ï¼šä¸šåŠ¡ä»£ç ä¸­ä¸å†æ‰‹åŠ¨åŒå†™ `userContext` é‡Œçš„ç”Ÿæ—¥ï¼Œé¿å…å¹¶å‘å†™å…¥æ—¶çš„ç«æ€æ¡ä»¶
- æ—¶åŒºç»Ÿä¸€ï¼šç¡®ä¿ `birth_date` (Dateç±»å‹) å’Œ JSON ä¸­çš„å­—ç¬¦ä¸²æ ¼å¼æ—¥æœŸåœ¨æ—¶åŒºå¤„ç†ä¸Šä¸€è‡´ï¼Œç»Ÿä¸€å­˜å‚¨ä¸º UTC æˆ–æ˜ç¡®çš„ ISO8601 å­—ç¬¦ä¸²

**PostgreSQL è§¦å‘å™¨ç¤ºä¾‹**ï¼š
```sql
-- åˆ›å»ºå‡½æ•°ï¼šåŒæ­¥ç”Ÿè¾°åˆ° userContextï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
CREATE OR REPLACE FUNCTION sync_birthday_to_user_context()
RETURNS TRIGGER AS $$
DECLARE
    current_user_context JSONB;
    birth_date_str TEXT;
BEGIN
  -- å¦‚æœ birth_date å‘ç”Ÿå˜åŒ–
  IF NEW.birth_date IS DISTINCT FROM OLD.birth_date THEN
    -- è·å–ç°æœ‰çš„ userContext
    current_user_context := COALESCE(NEW.preferences->'userContext', '{}'::jsonb);
    
    -- ç»Ÿä¸€æ—¶åŒºå¤„ç†ï¼šè½¬æ¢ä¸º ISO8601 å­—ç¬¦ä¸²ï¼ˆUTCï¼‰
    birth_date_str := to_char(NEW.birth_date, 'YYYY-MM-DD');
    
    -- æ›´æ–° userContextï¼Œæ·»åŠ  birthDateï¼ˆå¦‚æœä¸å­˜åœ¨æˆ–éœ€è¦æ›´æ–°ï¼‰
    IF current_user_context->>'birthDate' IS NULL OR 
       current_user_context->>'birthDate' != birth_date_str THEN
      current_user_context := current_user_context || jsonb_build_object(
        'birthDate', birth_date_str
      );
      
      -- æ›´æ–° preferences
      NEW.preferences := COALESCE(NEW.preferences, '{}'::jsonb) || 
        jsonb_build_object('userContext', current_user_context);
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_sync_birthday_to_user_context
BEFORE UPDATE ON profiles
FOR EACH ROW
WHEN (NEW.birth_date IS DISTINCT FROM OLD.birth_date)
EXECUTE FUNCTION sync_birthday_to_user_context();
```

**ä¸šåŠ¡ä»£ç æ³¨æ„äº‹é¡¹**ï¼š
```typescript
// âŒ é”™è¯¯ï¼šä¸è¦æ‰‹åŠ¨åŒæ­¥ç”Ÿè¾°åˆ° userContext
async function updateProfile(userId: string, data: ProfileUpdateData) {
  // ä¸è¦è¿™æ ·åšï¼š
  // if (data.birth_date) {
  //   await syncBirthdayToUserContext(userId, data.birth_date);
  // }
  
  // âœ… æ­£ç¡®ï¼šç›´æ¥æ›´æ–° birth_dateï¼Œè®©è§¦å‘å™¨å¤„ç†
  await db.update('profiles', { birth_date: data.birth_date }, { id: userId });
  // è§¦å‘å™¨ä¼šè‡ªåŠ¨åŒæ­¥åˆ° userContext
}
```

---

## ğŸ’° å¥–åŠ±æœºåˆ¶

### 1. å¤©æœºå¸å‘æ”¾æ¥å£

**æ¥å£**ï¼š`POST /api/coins/grant`ï¼ˆå†…éƒ¨æ¥å£ï¼Œæˆ–å¤ç”¨ç°æœ‰æ¥å£ï¼‰

**è¯·æ±‚ä½“**ï¼š
```typescript
{
  userId: string;
  amount: number;
  reason: string; // å¦‚ï¼š"å®Œå–„MBTIä¿¡æ¯"
  type: 'completeness_reward' | 'field_reward' | 'threshold_reward';
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. è°ƒç”¨ç°æœ‰çš„å¤©æœºå¸å‘æ”¾æ¥å£
2. è®°å½•å¥–åŠ±æ—¥å¿—ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºå¥–åŠ±åŠ¨ç”»ï¼‰

---

## ğŸ¤– éšæ€§ä¿¡æ¯æå–

### 1. ä¿¡æ¯æå–æœåŠ¡ï¼ˆåå°ä»»åŠ¡ï¼‰

**è§¦å‘æ—¶æœº**ï¼š
- AIè§£è¯»å®Œæˆæ—¶ï¼ˆå¼‚æ­¥é˜Ÿåˆ—ï¼‰
- ç”¨æˆ·æäº¤é—®é¢˜æ—¶ï¼ˆå¼‚æ­¥é˜Ÿåˆ—ï¼‰

**æå–Prompt**ï¼š
```
ä½ æ˜¯ä¸€ä¸ªä¿¡æ¯æå–å‘˜ã€‚ä»è¿™æ®µç”¨æˆ·å¯¹è¯ä¸­æå–å…³é”®ç”»åƒæ ‡ç­¾ã€‚

ç”¨æˆ·é—®é¢˜ï¼š{userQuery}
AIåˆ†æï¼š{aiAnalysis}

è¯·æå–ä»¥ä¸‹ä¿¡æ¯ï¼ˆè¾“å‡ºJSONæ ¼å¼ï¼‰ï¼š
1. inferred_roles: æ¨æ–­çš„è§’è‰²ï¼ˆå¦‚ï¼šparent, spouse, student, employeeç­‰ï¼‰
2. interest_tags: å…³æ³¨ç‚¹æ ‡ç­¾ï¼ˆå¦‚ï¼šwealth, career, relationship, healthç­‰ï¼‰
3. family_structure: å®¶åº­ç»“æ„ï¼ˆhas_spouse, has_children, children_countç­‰ï¼‰
4. profession_hints: èŒä¸šçº¿ç´¢ï¼ˆä»é—®é¢˜ä¸­æ¨æ–­çš„èŒä¸šç›¸å…³å…³é”®è¯ï¼‰
5. risk_tolerance: é£é™©åå¥½ï¼ˆlow/medium/highï¼Œä»å†³ç­–ç±»å‹æ¨æ–­ï¼‰

æ³¨æ„ï¼š
- åªæå–æ˜ç¡®çš„ä¿¡æ¯ï¼Œä¸è¦è¿‡åº¦æ¨æ–­
- å¦‚æœä¿¡æ¯ä¸æ˜ç¡®ï¼Œå¯¹åº”å­—æ®µè®¾ä¸ºnull
- è¾“å‡ºæ ¼å¼ï¼š{"inferred_roles": [...], "interest_tags": [...], ...}
```

**å®ç°é€»è¾‘**ï¼š
```typescript
async function extractImplicitTraits(
  userId: string,
  userQuery: string,
  aiAnalysis: string
): Promise<ImplicitTraits> {
  // 1. è°ƒç”¨è½»é‡çº§LLMï¼ˆgpt-4o-miniï¼‰
  const prompt = buildExtractionPrompt(userQuery, aiAnalysis);
  const response = await callLLM('gpt-4o-mini', prompt);
  
  // 2. è§£æJSONå“åº”
  const extractedTraits = JSON.parse(response);
  
  // 3. åˆå¹¶åˆ°ç°æœ‰éšæ€§ä¿¡æ¯ï¼ˆä¸è¦†ç›–ï¼Œåˆå¹¶å»é‡ï¼‰
  await mergeImplicitTraits(userId, extractedTraits);
  
  return extractedTraits;
}

async function mergeImplicitTraits(
  userId: string,
  newTraits: Partial<ImplicitTraits>
): Promise<void> {
  // è·å–ç°æœ‰éšæ€§ä¿¡æ¯
  const profile = await getProfile(userId);
  const existingTraits = profile.implicit_traits || {};
  
  // åˆå¹¶æ•°ç»„å­—æ®µï¼ˆå»é‡ï¼‰
  const mergedTraits: ImplicitTraits = {
    ...existingTraits,
    inferred_roles: [
      ...(existingTraits.inferred_roles || []),
      ...(newTraits.inferred_roles || [])
    ].filter((v, i, a) => a.indexOf(v) === i), // å»é‡
    interest_tags: [
      ...(existingTraits.interest_tags || []),
      ...(newTraits.interest_tags || [])
    ].filter((v, i, a) => a.indexOf(v) === i), // å»é‡
    // æ ‡é‡å­—æ®µï¼šæ–°å€¼è¦†ç›–æ—§å€¼
    risk_tolerance: newTraits.risk_tolerance || existingTraits.risk_tolerance,
    interaction_style: newTraits.interaction_style || existingTraits.interaction_style,
    last_active_topic: newTraits.last_active_topic || existingTraits.last_active_topic,
    // å¯¹è±¡å­—æ®µï¼šæ·±åº¦åˆå¹¶
    family_structure: {
      ...existingTraits.family_structure,
      ...newTraits.family_structure
    },
    profession_hints: [
      ...(existingTraits.profession_hints || []),
      ...(newTraits.profession_hints || [])
    ].filter((v, i, a) => a.indexOf(v) === i)
  };
  
  // æ›´æ–°æ•°æ®åº“
  await updateProfile(userId, {
    implicit_traits: mergedTraits
  });
}
```

### 2. å¼‚æ­¥é˜Ÿåˆ—å¤„ç†

**å»ºè®®ä½¿ç”¨**ï¼š
- Redis Queueï¼ˆBull/BullMQï¼‰
- PostgreSQL LISTEN/NOTIFY
- æˆ–ç®€å•çš„åå°ä»»åŠ¡é˜Ÿåˆ—

**ä»»åŠ¡å®šä¹‰**ï¼š
```typescript
interface ExtractionTask {
  userId: string;
  userQuery: string;
  aiAnalysis: string;
  timestamp: string;
}

// æ·»åŠ åˆ°é˜Ÿåˆ—
async function enqueueExtractionTask(task: ExtractionTask): Promise<void> {
  await extractionQueue.add('extract-traits', task, {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 2000
    }
  });
}

// å¤„ç†é˜Ÿåˆ—ä»»åŠ¡
extractionQueue.process('extract-traits', async (job) => {
  const { userId, userQuery, aiAnalysis } = job.data;
  await extractImplicitTraits(userId, userQuery, aiAnalysis);
});
```

---

## ğŸ“Š æ•°æ®ç»“æ„å®šä¹‰

### TypeScript ç±»å‹å®šä¹‰ï¼ˆä¾›å‚è€ƒï¼‰

```typescript
// ç”¨æˆ·ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆæ˜¾æ€§å±‚ï¼‰
export interface UserContextData {
  mbti?: string;           // MBTIäººæ ¼ç±»å‹
  currentStatus?: string;  // å½“å‰ç°çŠ¶
  identity?: string;       // æ ¸å¿ƒèº«ä»½æ ‡ç­¾ï¼ˆå‘½æ ¼æ³•ç›¸ï¼‰
  profession?: string;     // èŒä¸š
  wishes?: string[];       // æ„¿æ™¯/ç›®æ ‡
  energyLevel?: 'strong' | 'weak' | 'balanced'; // èƒ½é‡çŠ¶æ€
}

// éšæ€§ç‰¹å¾ï¼ˆéšæ€§å±‚ï¼‰
export interface ImplicitTraits {
  inferred_roles?: string[];      // æ¨æ–­çš„è§’è‰²
  interest_tags?: string[];       // å…³æ³¨ç‚¹æ ‡ç­¾
  risk_tolerance?: 'low' | 'medium' | 'high'; // é£é™©åå¥½
  interaction_style?: 'concise' | 'detailed'; // äº¤äº’é£æ ¼
  last_active_topic?: string;     // æœ€è¿‘å…³æ³¨çš„è¯é¢˜
  family_structure?: {
    has_spouse?: boolean;
    has_children?: boolean;
    children_count?: number;
  };
  profession_hints?: string[];    // èŒä¸šçº¿ç´¢
}

// èµ„æ–™å®Œæ•´åº¦è¯¦æƒ…
export interface CompletenessBreakdown {
  birthData: { filled: boolean; score: number; maxScore: number; };
  mbti: { filled: boolean; score: number; maxScore: number; };
  profession: { filled: boolean; score: number; maxScore: number; };
  currentStatus: { filled: boolean; score: number; maxScore: number; };
  wishes: { filled: boolean; score: number; maxScore: number; };
}
```

---

## âœ… å¼€å‘æ£€æŸ¥æ¸…å•

### Phase 1: åŸºç¡€è®¾æ–½ + Swagger/OpenAPIï¼ˆæœ¬å‘¨ - P0ï¼‰

**æ•°æ®åº“å±‚**ï¼š
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆæ·»åŠ  `implicit_traits` å­—æ®µï¼‰
- [ ] åˆ›å»º GIN ç´¢å¼•ï¼ˆä¼˜åŒ–JSONBæŸ¥è¯¢ï¼‰
- [ ] åˆ›å»ºç”Ÿè¾°ä¿¡æ¯åŒæ­¥è§¦å‘å™¨
- [ ] åˆ›å»ºå®Œæ•´åº¦è®¡ç®—å‡½æ•°
- [ ] åˆ›å»ºå¥–åŠ±è®°å½•è¡¨ï¼ˆé˜²æ­¢é‡å¤å‘æ”¾ï¼‰
- [ ] éªŒè¯è§¦å‘å™¨æ­£å¸¸å·¥ä½œ

**APIå±‚**ï¼š
- [ ] æ‰©å±• `GET /api/user/profile` è¿”å›å®Œæ•´åº¦
- [ ] æ‰©å±• `PUT /api/user/profile` æ”¯æŒæ›´æ–° userContextï¼ˆæ·»åŠ å®‰å…¨è¿‡æ»¤ï¼‰
- [ ] å®ç° `POST /api/user/sync-birthday-to-context`ï¼ˆå¯é€‰ï¼Œä¸»è¦ä¾èµ–è§¦å‘å™¨ï¼‰
- [ ] **ç”Ÿæˆ Swagger/OpenAPI æ–‡æ¡£**ï¼ˆå‰åç«¯å¥‘çº¦ï¼‰

**ä¸šåŠ¡é€»è¾‘å±‚**ï¼š
- [ ] å®ç°èµ„æ–™å®Œæ•´åº¦è®¡ç®—å‡½æ•°ï¼ˆå¸¦å•å…ƒæµ‹è¯•ï¼‰
- [ ] å®ç°å¥–åŠ±å‘æ”¾é€»è¾‘ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
- [ ] å®ç°å­—æ®µå¯¹æ¯”é€»è¾‘ï¼ˆæ£€æµ‹æ–°å¢å­—æ®µï¼‰
- [ ] æ·»åŠ å®‰å…¨è¿‡æ»¤ï¼ˆç¦æ­¢ç”¨æˆ·æ›´æ–° `implicit_traits`ï¼‰

**æµ‹è¯•**ï¼š
- [ ] å•å…ƒæµ‹è¯•ï¼šå®Œæ•´åº¦è®¡ç®—ï¼ˆè¦†ç›–å„ç§è¾¹ç•Œæƒ…å†µï¼‰
- [ ] å•å…ƒæµ‹è¯•ï¼šå¥–åŠ±å‘æ”¾ï¼ˆå¹‚ç­‰æ€§æµ‹è¯•ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼šç”Ÿè¾°ä¿¡æ¯åŒæ­¥è§¦å‘å™¨
- [ ] Mockæµ‹è¯•ï¼šä½¿ç”¨Mockæ•°æ®æµ‹è¯•API

### Phase 2: å‘½ä¸»ååˆºæ¥å£ + å“åº”å¢å¼ºï¼ˆä¸‹å‘¨ - P1ï¼‰

**APIå±‚**ï¼š
- [ ] å®ç° `GET /api/user/destiny-card`
- [ ] å®ç° `PUT /api/user/destiny-card`ï¼ˆå“åº”ä½“å¢å¼ºï¼ŒåŒ…å« `events` å­—æ®µï¼‰
- [ ] å®ç° `GET /api/user/completeness`
- [ ] **æ›´æ–° Swagger/OpenAPI æ–‡æ¡£**

**ä¸šåŠ¡é€»è¾‘å±‚**ï¼š
- [ ] å®Œå–„å¥–åŠ±å‘æ”¾é€»è¾‘ï¼ˆè¿”å› `events` æ•°ç»„ï¼‰
- [ ] å®ç°å­—æ®µå¯¹æ¯”é€»è¾‘ï¼ˆæ£€æµ‹æ–°å¢å­—æ®µï¼‰
- [ ] å®ç°å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤å‘æ”¾ï¼‰

**æµ‹è¯•**ï¼š
- [ ] å•å…ƒæµ‹è¯•ï¼šå­—æ®µå¯¹æ¯”é€»è¾‘
- [ ] é›†æˆæµ‹è¯•ï¼šå¥–åŠ±å‘æ”¾æµç¨‹
- [ ] Mockæµ‹è¯•ï¼šå“åº”ä½“æ ¼å¼éªŒè¯

### Phase 3: éšæ€§ä¿¡æ¯ + AIé›†æˆï¼ˆä¸‹ä¸‹å‘¨ - P2ï¼‰

**APIå±‚**ï¼š
- [ ] å®ç° `GET /api/user/implicit-traits`ï¼ˆè€ƒè™‘å‰ç«¯è„±æ•ï¼‰
- [ ] å®ç° `POST /api/user/implicit-traits`ï¼ˆå†…éƒ¨æ¥å£ï¼Œæƒé™æ§åˆ¶ï¼‰
- [ ] å®ç° `DELETE /api/user/implicit-traits`
- [ ] **æ›´æ–° Swagger/OpenAPI æ–‡æ¡£**

**ä¸šåŠ¡é€»è¾‘å±‚**ï¼š
- [ ] å®ç°éšæ€§ä¿¡æ¯æå–æœåŠ¡ï¼ˆè½»é‡çº§LLMè°ƒç”¨ï¼‰
- [ ] å®ç°ä¿¡æ¯åˆå¹¶é€»è¾‘ï¼ˆåˆå¹¶å»é‡ï¼‰
- [ ] å®ç°Tokenç†”æ–­æœºåˆ¶ï¼ˆé™åˆ¶éšæ€§ä¿¡æ¯é•¿åº¦ï¼‰
- [ ] **ä¼˜å…ˆå®ç° ContextBuilder**ï¼šå°†æ•°æ®åº“JSONæ•°æ®æ ¼å¼åŒ–ä¸ºLLMæ˜“è¯»çš„String

**é˜Ÿåˆ—å±‚**ï¼š
- [ ] å®ç°å¼‚æ­¥æå–ä»»åŠ¡é˜Ÿåˆ—ï¼ˆRedis Queueæˆ–PostgreSQL LISTEN/NOTIFYï¼‰
- [ ] å®ç°ä»»åŠ¡é‡è¯•æœºåˆ¶
- [ ] å®ç°ä»»åŠ¡ç›‘æ§å’Œå‘Šè­¦

**æµ‹è¯•**ï¼š
- [ ] å•å…ƒæµ‹è¯•ï¼šä¿¡æ¯åˆå¹¶é€»è¾‘
- [ ] å•å…ƒæµ‹è¯•ï¼šTokenç†”æ–­æœºåˆ¶
- [ ] é›†æˆæµ‹è¯•ï¼šå¼‚æ­¥æå–ä»»åŠ¡é˜Ÿåˆ—
- [ ] æ€§èƒ½æµ‹è¯•ï¼šTokenæ¶ˆè€—ç›‘æ§

---

## ğŸ›¡ï¸ å®‰å…¨æ€§å¢å¼º

### 1. æƒé™æ§åˆ¶

**éšå¼ä¿¡æ¯æ›´æ–°æƒé™**ï¼š
```typescript
// æ£€æŸ¥è°ƒç”¨è€…æƒé™
async function checkImplicitTraitsPermission(userId: string, callerId: string): Promise<boolean> {
  // 1. ç³»ç»Ÿè°ƒç”¨ï¼ˆä½¿ç”¨system_tokenï¼‰
  if (callerId === 'system') {
    return true;
  }
  
  // 2. ç®¡ç†å‘˜æƒé™
  const caller = await getProfile(callerId);
  if (caller.role === 'admin') {
    return true;
  }
  
  // 3. ç”¨æˆ·è‡ªå·±ä¸èƒ½æ›´æ–°éšæ€§ä¿¡æ¯
  return false;
}
```

### 2. å‰ç«¯è„±æ•

**GETæ¥å£å“åº”è¿‡æ»¤**ï¼š
```typescript
// æ ¹æ®ç”¨æˆ·è®¾ç½®å†³å®šæ˜¯å¦è¿”å›å…¨éƒ¨éšæ€§ä¿¡æ¯
async function getImplicitTraits(userId: string, includeSensitive: boolean = false) {
  const traits = await loadImplicitTraits(userId);
  
  if (!includeSensitive) {
    // åªè¿”å›ç”¨æˆ·å¯è§çš„å­—æ®µ
    return {
      interest_tags: traits.interest_tags,
      risk_tolerance: traits.risk_tolerance,
      interaction_style: traits.interaction_style
      // ä¸è¿”å›ï¼šinferred_roles, family_structure, profession_hints
    };
  }
  
  return traits;
}
```

### 3. Tokenç†”æ–­

**é™åˆ¶éšæ€§ä¿¡æ¯é•¿åº¦**ï¼š
```typescript
// åœ¨æ›´æ–°éšæ€§ä¿¡æ¯æ—¶ï¼Œæ£€æŸ¥å¹¶é™åˆ¶é•¿åº¦
const MAX_IMPLICIT_TRAITS_TOKENS = 200; // æœ€å¤š200 tokens

function truncateImplicitTraits(traits: ImplicitTraits): ImplicitTraits {
  const truncated = { ...traits };
  
  // é™åˆ¶æ•°ç»„é•¿åº¦
  if (truncated.inferred_roles && truncated.inferred_roles.length > 3) {
    truncated.inferred_roles = truncated.inferred_roles.slice(0, 3);
  }
  if (truncated.interest_tags && truncated.interest_tags.length > 5) {
    truncated.interest_tags = truncated.interest_tags.slice(0, 5);
  }
  if (truncated.profession_hints && truncated.profession_hints.length > 3) {
    truncated.profession_hints = truncated.profession_hints.slice(0, 3);
  }
  
  return truncated;
}
```

---

## ğŸ”§ ContextBuilder å®ç°ï¼ˆä¼˜å…ˆå¼€å‘ï¼‰

**è¿™æ˜¯æ•°å­—å­ªç”Ÿçš„æ ¸å¿ƒä»·å€¼ï¼Œä¼˜å…ˆå®ç°**ï¼š

```typescript
// src/services/context/ContextBuilder.ts
export class ContextBuilder {
  /**
   * æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡å­—ç¬¦ä¸²ï¼ˆç”¨äºAI Promptï¼‰
   * @param userId ç”¨æˆ·ID
   * @param depth æ³¨å…¥æ·±åº¦
   * @param maxTokens Tokené™åˆ¶
   */
  static async build(
    userId: string,
    depth: 'basic' | 'standard' | 'deep' = 'standard',
    maxTokens: number = 200
  ): Promise<string> {
    // 1. åŠ è½½ç”¨æˆ·æ•°æ®
    const profile = await getProfile(userId);
    const userContext = profile.preferences?.userContext || {};
    const implicitTraits = profile.implicit_traits || {};
    
    // 2. ä½¿ç”¨ ContextCompressor å‹ç¼©
    const compressed = ContextCompressor.compress(
      userContext,
      depth === 'deep' ? implicitTraits : undefined,
      maxTokens,
      depth
    );
    
    return compressed;
  }
  
  /**
   * ä¸ºä¸åŒåŠŸèƒ½æ„å»ºé€‚é…çš„ä¸Šä¸‹æ–‡
   */
  static async buildForFeature(
    userId: string,
    featureType: 'ziwei' | 'tarot' | 'yijing' | 'triple' | 'dilemma'
  ): Promise<string> {
    const profile = await getProfile(userId);
    const userContext = profile.preferences?.userContext || {};
    const implicitTraits = profile.implicit_traits || {};
    
    // æ ¹æ®åŠŸèƒ½ç±»å‹é€‰æ‹©ç›¸å…³ä¿¡æ¯
    const relevantContext = ContextInjector.selectRelevantContext(
      featureType,
      userContext,
      implicitTraits
    );
    
    // é€‚é…æ ¼å¼
    return ContextAdapter.adaptContextForFeature(featureType, relevantContext);
  }
}
```

---

## ğŸ“Š Swagger/OpenAPI æ–‡æ¡£ç”Ÿæˆ

### 1. ä½¿ç”¨ Swagger/OpenAPI è§„èŒƒ

**å»ºè®®å·¥å…·**ï¼š
- Node.js: `swagger-jsdoc` + `swagger-ui-express`
- Python: `flask-swagger-ui` æˆ– `fastapi`ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- Go: `swaggo/swag`

**ç¤ºä¾‹é…ç½®**ï¼ˆNode.js + Expressï¼‰ï¼š
```typescript
// swagger.ts
import swaggerJsdoc from 'swagger-jsdoc';

const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'ç”¨æˆ·æ•°å­—å­ªç”Ÿç³»ç»Ÿ API',
      version: '1.0.0',
      description: 'ç”¨æˆ·æ•°å­—å­ªç”Ÿç³»ç»Ÿ API æ–‡æ¡£'
    },
    servers: [
      {
        url: 'http://localhost:3000/api',
        description: 'å¼€å‘ç¯å¢ƒ'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      }
    }
  },
  apis: ['./routes/**/*.ts'] // APIè·¯ç”±æ–‡ä»¶è·¯å¾„
};

export const swaggerSpec = swaggerJsdoc(swaggerOptions);
```

### 2. APIæ–‡æ¡£æ³¨é‡Šç¤ºä¾‹

```typescript
/**
 * @swagger
 * /api/user/destiny-card:
 *   get:
 *     summary: è·å–å‘½ä¸»ååˆº
 *     tags: [å‘½ä¸»ååˆº]
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: æˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   $ref: '#/components/schemas/DestinyCard'
 *       401:
 *         description: æœªæˆæƒ
 */
```

---

## ğŸ§ª Mockæµ‹è¯•æ•°æ®

### 1. Mockæ•°æ®ç”Ÿæˆ

```typescript
// tests/mocks/userContextMock.ts
export const mockUserContext = {
  mbti: 'INTP',
  currentStatus: 'åˆšè¢«è£å‘˜ï¼Œæƒ³åˆ›ä¸š',
  identity: 'ç´«å¾®ä¸ƒæ€Â·åŒ–æ€ä¸ºæƒ',
  profession: 'ç‹¬ç«‹å¼€å‘è€…',
  wishes: ['è´¢åŠ¡è‡ªç”±', 'å®¶åº­å’Œç¦'],
  energyLevel: 'balanced' as const
};

export const mockImplicitTraits = {
  inferred_roles: ['parent', 'spouse'],
  interest_tags: ['wealth', 'career', 'relationship'],
  risk_tolerance: 'medium' as const,
  interaction_style: 'detailed' as const,
  last_active_topic: 'career',
  family_structure: {
    has_spouse: true,
    has_children: true,
    children_count: 1
  }
};
```

### 2. å•å…ƒæµ‹è¯•ç¤ºä¾‹

```typescript
// tests/services/completeness.test.ts
describe('calculateCompleteness', () => {
  it('should return 0 for empty context', () => {
    const result = calculateCompleteness({}, null);
    expect(result).toBe(0);
  });
  
  it('should return 40 for birth data only', () => {
    const result = calculateCompleteness({}, new Date('1990-01-15'));
    expect(result).toBe(40);
  });
  
  it('should return 100 for complete context', () => {
    const context = {
      mbti: 'INTP',
      profession: 'Developer',
      currentStatus: 'Working',
      wishes: ['Goal1', 'Goal2']
    };
    const result = calculateCompleteness(context, new Date('1990-01-15'));
    expect(result).toBe(100);
  });
});
```

---

## ğŸ” æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰

- **ç”Ÿè¾°ä¿¡æ¯åŒæ­¥**ï¼š
  - âœ… **ä»¥æ•°æ®åº“è§¦å‘å™¨ä¸ºå‡†**ï¼šä¸šåŠ¡ä»£ç ä¸­ä¸å†æ‰‹åŠ¨åŒå†™ `userContext` é‡Œçš„ç”Ÿæ—¥
  - âœ… **æ—¶åŒºç»Ÿä¸€**ï¼šç¡®ä¿ `birth_date` (Dateç±»å‹) å’Œ JSON ä¸­çš„å­—ç¬¦ä¸²æ ¼å¼æ—¥æœŸåœ¨æ—¶åŒºå¤„ç†ä¸Šä¸€è‡´ï¼Œç»Ÿä¸€å­˜å‚¨ä¸º UTC æˆ–æ˜ç¡®çš„ ISO8601 å­—ç¬¦ä¸²
- **å®Œæ•´åº¦è®¡ç®—**ï¼šç¡®ä¿è®¡ç®—é€»è¾‘ä¸å‰ç«¯ä¸€è‡´ï¼ˆä½¿ç”¨å…±äº«çš„è®¡ç®—å‡½æ•°ï¼‰
- **å¥–åŠ±å‘æ”¾**ï¼šä½¿ç”¨ `completeness_rewards` è¡¨è®°å½•å·²å‘æ”¾çš„å¥–åŠ±ï¼Œé˜²æ­¢é‡å¤å‘æ”¾

### 2. å®‰å…¨æ€§ï¼ˆå…³é”®ï¼‰

- **æƒé™æ§åˆ¶**ï¼š
  - âœ… **éšå¼ä¿¡æ¯æ›´æ–°**ï¼š`POST /api/user/implicit-traits` éœ€è¦ç®¡ç†å‘˜æƒé™æˆ–ç³»ç»Ÿè°ƒç”¨
  - âœ… **ç”¨æˆ·èµ„æ–™æ›´æ–°**ï¼šä¸¥æ ¼è¿‡æ»¤ `preferences.implicit_traits` å­—æ®µï¼Œç¦æ­¢ç”¨æˆ·é€šè¿‡å‰ç«¯ç›´æ¥æ›´æ–°
- **å‰ç«¯è„±æ•**ï¼š
  - âœ… **GETæ¥å£**ï¼šè€ƒè™‘æ˜¯å¦è¿”å›å…¨éƒ¨éšæ€§æ ‡ç­¾ï¼Œæˆ–å¢åŠ  `visible_to_user` çš„è¿‡æ»¤é€»è¾‘
  - âœ… **æ•æ„Ÿå­—æ®µ**ï¼š`inferred_roles`, `family_structure`, `profession_hints` ç­‰å¯èƒ½ä¸é€‚åˆç›´æ¥å±•ç¤ºç»™ç”¨æˆ·
- **æ•°æ®éªŒè¯**ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥çš„æ•°æ®æ ¼å¼å’ŒèŒƒå›´
- **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

### 3. æ€§èƒ½ä¼˜åŒ–

- **JSONBæŸ¥è¯¢**ï¼šä½¿ç”¨GINç´¢å¼•ä¼˜åŒ– `preferences` å’Œ `implicit_traits` çš„æŸ¥è¯¢
- **å¼‚æ­¥å¤„ç†**ï¼šéšæ€§ä¿¡æ¯æå–ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- **æ‰¹é‡æ›´æ–°**ï¼šåˆå¹¶å¤šæ¬¡æ›´æ–°æ“ä½œï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
- **Tokenç†”æ–­**ï¼šé™åˆ¶éšæ€§ä¿¡æ¯å†…å®¹é•¿åº¦ï¼Œé˜²æ­¢AIæ³¨å…¥æ—¶Tokençˆ†ç‚¸

### 4. å¹‚ç­‰æ€§ä¿è¯

- **å¥–åŠ±å‘æ”¾**ï¼šä½¿ç”¨å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤å‘æ”¾
- **æ•°æ®æ›´æ–°**ï¼šä½¿ç”¨ä¹è§‚é”æˆ–ç‰ˆæœ¬å·é˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
- **å¼‚æ­¥ä»»åŠ¡**ï¼šä½¿ç”¨ä»»åŠ¡IDç¡®ä¿ä»»åŠ¡åªæ‰§è¡Œä¸€æ¬¡

### 5. å‘åå…¼å®¹

- **é»˜è®¤å€¼å¤„ç†**ï¼šå¦‚æœ `preferences` æˆ– `implicit_traits` ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå¯¹è±¡
- **å­—æ®µå¯é€‰**ï¼šæ‰€æœ‰æ–°å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- **APIç‰ˆæœ¬**ï¼šè€ƒè™‘ä½¿ç”¨APIç‰ˆæœ¬æ§åˆ¶ï¼ˆå¦‚ `/api/v1/user/profile`ï¼‰

### 6. å“åº”ä½“å¢å¼ºï¼ˆå³æ—¶åé¦ˆï¼‰

- **eventså­—æ®µ**ï¼šåœ¨ `PUT /api/user/destiny-card` å“åº”ä¸­å¢åŠ  `events` æ•°ç»„
- **å‰ç«¯ä½¿ç”¨**ï¼šå‰ç«¯æ‹¿åˆ°å“åº”åå¯ä»¥ç«‹å³å¼¹å‡ºå¥–åŠ±åŠ¨ç”»ï¼Œä¸éœ€è¦å†è½®è¯¢é’±åŒ…æ¥å£

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æ•°å­—å­ªç”Ÿç³»ç»Ÿé‡æ„æ–¹æ¡ˆ](../memory-bank/plans/system/260131-ç”¨æˆ·æ•°å­—å­ªç”Ÿç³»ç»Ÿé‡æ„æ–¹æ¡ˆ.md)
- [å‘½ä¸»ååˆºä¸ç”¨æˆ·ä¸ªäººä¿¡æ¯ç³»ç»Ÿæ¢³ç†](./å‘½ä¸»ååˆºä¸ç”¨æˆ·ä¸ªäººä¿¡æ¯ç³»ç»Ÿæ¢³ç†.md)
- [ä¸Šä¸‹æ–‡å‹ç¼©å™¨](./ä¸Šä¸‹æ–‡å£“ç¸®å™¨.md)

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

- **2026-01-31**ï¼šåˆ›å»ºåˆå§‹åç«¯å¼€å‘æŒ‡å—
