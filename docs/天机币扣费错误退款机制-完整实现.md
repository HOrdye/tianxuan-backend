# 天机币扣费错误退款机制 - 完整实现

## 📋 概述

已为所有涉及用户支付天机币的功能添加了错误处理和自动退款机制。当服务发生错误时，系统会自动退还用户已扣费的天机币，并明确告知用户。

## ✅ 已修复的功能

### 1. 塔罗牌解读 (`TarotPage.vue`)
- ✅ 已添加退款逻辑
- ✅ 解读失败时自动退款
- ✅ 明确告知用户已退款

### 2. 天象解码 (`CelestialResonancePage.vue`)
- ✅ 已添加退款逻辑
- ✅ 生成专业解读失败时自动退款

### 3. 易经占卜 (`HexagramDivination.vue`)
- ✅ 已添加退款逻辑
- ✅ LLM解读失败时自动退款
- ✅ 占卜流程失败时自动退款

### 4. 三维决策系统 (`TripleAnalysisPage.vue`)
- ✅ 已添加退款逻辑
- ✅ 生成裁决书失败时自动退款

### 5. 时空解锁 (`timeSpaceUnlockService.ts`)
- ✅ 已添加退款逻辑
- ✅ 记录解锁状态失败时自动退款

### 6. 深度洞察 (`PaymentService.ts`)
- ✅ 已有退款机制（使用流式生成）
- ✅ 生成失败时自动退款

### 7. 今日运势 (`DailyGuidance.vue`)
- ℹ️ 此组件只触发解锁事件，实际生成在父组件
- ℹ️ 退款逻辑在父组件中处理

## 🔧 实现方案

### 1. 通用退款工具 (`src/utils/refundHelper.ts`)

创建了通用的退款辅助工具，包含：

- **`refundCoins()`**: 根据扣费明细精确退款
- **`getDeductionDetail()`**: 从扣费结果获取扣费明细（支持降级方案）

**使用示例**：
```typescript
import { refundCoins, getDeductionDetail } from '@/utils/refundHelper';

// 获取扣费明细
const deductionDetail = getDeductionDetail(consumeResult, price);

// 退款
if (hasDeducted && deductionDetail) {
  const refundResult = await refundCoins(
    deductionDetail,
    '服务失败退款',
    requestId
  );
}
```

### 2. 扣费明细传递

修改了 `QuotaService.consumeQuota()` 返回扣费明细：

```typescript
export interface QuotaConsumeResult {
  // ... 其他字段
  deduction?: {
    daily_coins_grant: number;
    activity_coins_grant: number;
    tianji_coins_balance: number;
  }; // 🔧 新增：扣费明细（用于退款）
}
```

### 3. 退款流程

1. **保存扣费明细**：扣费成功后，保存扣费明细
2. **执行服务**：调用AI生成服务
3. **错误处理**：如果服务失败，自动调用退款函数
4. **用户提示**：明确告知用户已退款

## 📝 退款逻辑说明

### 精确退款

根据扣费明细精确退款到对应的余额类型：
- `daily_coins_grant` → 退到每日赠送余额 (`source: 'checkin'`)
- `activity_coins_grant` → 退到活动赠送余额 (`source: 'activity'`)
- `tianji_coins_balance` → 退到储值余额 (`source: 'recharge'`)

### 降级方案

如果无法获取精确的扣费明细，使用降级方案：
- 根据 `source` 字段估算扣费明细
- 优先退到储值余额（更安全）

## 🚨 注意事项

1. **幂等性检查**：如果 `consumed=false`（未实际扣费），不进行退款
2. **错误处理**：退款失败时记录错误日志，但不影响错误提示
3. **用户提示**：明确告知用户已退款，包括退款金额

## 📊 覆盖范围

| 功能 | 文件 | 状态 | 备注 |
|------|------|------|------|
| 塔罗牌解读 | `TarotPage.vue` | ✅ | 已实现 |
| 天象解码 | `CelestialResonancePage.vue` | ✅ | 已实现 |
| 易经占卜 | `HexagramDivination.vue` | ✅ | 已实现 |
| 三维决策 | `TripleAnalysisPage.vue` | ✅ | 已实现 |
| 时空解锁 | `timeSpaceUnlockService.ts` | ✅ | 已实现 |
| 深度洞察 | `PaymentService.ts` | ✅ | 已有机制 |
| 今日运势 | `DailyGuidance.vue` | ℹ️ | 父组件处理 |

## 🔍 测试建议

1. **测试正常流程**：确保扣费和生成正常
2. **测试错误退款**：模拟服务失败，验证退款是否成功
3. **测试幂等性**：重复请求时不应重复扣费和退款
4. **测试用户提示**：验证错误提示是否明确告知退款信息

## 📚 相关文档

- `docs/塔罗解读错误修复-后端提示.md` - 后端需要实现的流水记录功能
- `src/utils/refundHelper.ts` - 退款工具函数实现
