# 开悟者签到奖励问题调试说明

## 🐛 问题描述

**问题现象**：
- 开悟者等级（basic）会员签到，应该奖励45币（第1天）
- 实际只奖励了2币（这是探索者explorer的奖励）
- 天命师账号能够正确获得500币

**问题分析**：
可能的原因：
1. 数据库中用户的 `tier` 字段值不是 `'basic'`
2. `tier` 字段值为 `null` 或空字符串，导致使用默认值 `'explorer'`
3. `tier` 字段值有空格或其他字符，导致识别失败
4. 等级识别逻辑有问题

## ✅ 已添加的修复

### 1. 增强等级识别逻辑

**文件位置**：`src/services/checkin.service.ts`

**修改内容**：
- ✅ 添加了 `trim()` 处理，去除tier值的空格
- ✅ 添加了详细的等级验证逻辑
- ✅ 添加了调试日志，记录等级识别过程

### 2. 增强奖励计算调试

**修改内容**：
- ✅ 在 `calculateCheckinReward` 函数中添加了详细的调试日志
- ✅ 记录输入的tier值、验证后的tier值、连续天数、计算的奖励等

## 🧪 测试步骤

### 步骤1：查看后端日志

1. **启动后端服务**（如果还没有启动）
2. **让开悟者用户进行签到**
3. **查看后端控制台输出**，应该能看到以下日志：

```
[签到服务] 用户等级信息: {
  userId: 'xxx',
  rawTier: 'basic',  // 或 'BASIC'、'Basic'、null等
  userTier: 'basic', // 或 'explorer'（如果识别失败）
  isValidTier: true  // 或 false
}

[签到奖励计算] 奖励计算详情: {
  tier: 'basic',     // 或 'explorer'（如果识别失败）
  validTier: 'basic', // 或 'explorer'
  consecutiveDays: 1,
  dayIndex: 0,        // 第1天（索引0）
  reward: 45,         // 或 2（如果识别失败）
  rewardTable: [45, 48, 50, 52, 55, 58, 70]  // 或 [2, 3, 3, 4, 4, 5, 5]
}

[签到服务] 最终奖励计算: {
  userId: 'xxx',
  userTier: 'basic',  // 或 'explorer'
  consecutiveDays: 1,
  totalReward: 45     // 或 2
}
```

### 步骤2：检查数据库中的tier值

**SQL查询**：
```sql
SELECT id, email, tier, subscription_status, subscription_end_at
FROM public.profiles
WHERE tier = 'basic' OR tier = 'BASIC' OR tier = 'Basic'
LIMIT 10;
```

**检查点**：
- `tier` 字段的值应该是 `'basic'`（小写）
- 如果看到 `'BASIC'`、`'Basic'` 或其他值，说明数据库中的值不一致
- 如果看到 `null` 或空字符串，说明用户等级没有正确设置

### 步骤3：检查订阅记录

**SQL查询**：
```sql
SELECT user_id, tier, status, expires_at, created_at
FROM public.subscriptions
WHERE user_id = '你的用户ID'
ORDER BY created_at DESC
LIMIT 5;
```

**检查点**：
- 最新的订阅记录的 `tier` 值应该是 `'basic'`
- `status` 应该是 `'active'`
- `expires_at` 应该还没有过期

### 步骤4：验证修复

**如果日志显示 `rawTier` 不是 `'basic'`**：
- 需要检查数据库中的tier值是否正确
- 可能需要手动更新数据库中的tier值

**如果日志显示 `rawTier` 是 `'basic'` 但 `userTier` 是 `'explorer'`**：
- 说明等级识别逻辑有问题
- 需要检查代码中的等级验证逻辑

**如果日志显示 `userTier` 是 `'basic'` 但 `reward` 是 `2`**：
- 说明奖励计算逻辑有问题
- 需要检查 `REWARD_TABLE` 配置

## 🔧 可能的解决方案

### 方案1：手动更新数据库tier值

如果数据库中的tier值不正确，可以手动更新：

```sql
-- 更新特定用户的tier值
UPDATE public.profiles
SET tier = 'basic', updated_at = NOW()
WHERE id = '用户ID';

-- 批量更新所有开悟者用户的tier值（如果值不一致）
UPDATE public.profiles
SET tier = 'basic', updated_at = NOW()
WHERE tier IN ('BASIC', 'Basic', 'Basic ') OR tier IS NULL;
```

### 方案2：检查订阅服务是否更新了tier

如果订阅服务在检查过期订阅时错误地将tier降级了，需要检查：
- `subscription_end_at` 是否已过期
- 订阅服务的过期检查逻辑是否正确

### 方案3：检查前端传递的等级值

如果前端在某个地方覆盖了tier值，需要检查：
- 前端是否正确读取了用户等级
- 前端是否正确传递了等级值给后端

## 📋 调试检查清单

- [ ] 查看后端日志，确认等级识别过程
- [ ] 检查数据库中的tier值是否正确
- [ ] 检查订阅记录中的tier值是否正确
- [ ] 确认订阅状态是否为active且未过期
- [ ] 验证奖励计算逻辑是否正确
- [ ] 测试天命师账号是否正常（确认奖励配置正确）

## 🎯 预期结果

**正确的日志输出应该是**：
```
[签到服务] 用户等级信息: {
  userId: 'xxx',
  rawTier: 'basic',
  userTier: 'basic',
  isValidTier: true
}

[签到奖励计算] 奖励计算详情: {
  tier: 'basic',
  validTier: 'basic',
  consecutiveDays: 1,
  dayIndex: 0,
  reward: 45,
  rewardTable: [45, 48, 50, 52, 55, 58, 70]
}

[签到服务] 最终奖励计算: {
  userId: 'xxx',
  userTier: 'basic',
  consecutiveDays: 1,
  totalReward: 45
}
```

**如果看到不同的输出，请将日志内容反馈给我，我会根据日志进一步分析问题。**
