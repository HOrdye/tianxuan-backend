# åç«¯APIå¼€å‘Cursor Rules - è¯¦ç»†ç‰ˆ

> è¿™æ˜¯å®Œæ•´ç‰ˆæœ¬çš„å¼€å‘è§„èŒƒï¼ŒåŒ…å«è¯¦ç»†çš„ä»£ç ç¤ºä¾‹ã€‚ç²¾ç®€ç‰ˆè¯·æŸ¥çœ‹ `.cursorrules` æ–‡ä»¶ã€‚

## ğŸ“‹ é¡¹ç›®æ¶æ„è§„èŒƒ

### ä»£ç ç»“æ„
- **ä¸‰å±‚æ¶æ„**ï¼šControllerï¼ˆè·¯ç”±å¤„ç†ï¼‰ â†’ Serviceï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ â†’ Databaseï¼ˆæ•°æ®è®¿é—®ï¼‰
- **æ–‡ä»¶ç»„ç»‡**ï¼š
  - `src/controllers/` - æ§åˆ¶å™¨å±‚ï¼Œå¤„ç†HTTPè¯·æ±‚å“åº”
  - `src/services/` - æœåŠ¡å±‚ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘
  - `src/routes/` - è·¯ç”±å®šä¹‰
  - `src/middleware/` - ä¸­é—´ä»¶ï¼ˆè®¤è¯ã€æƒé™ç­‰ï¼‰
  - `src/utils/` - å·¥å…·å‡½æ•°ï¼ˆå“åº”æ ¼å¼åŒ–ç­‰ï¼‰
  - `src/types/` - TypeScriptç±»å‹å®šä¹‰

### å‘½åè§„èŒƒ
- **æ–‡ä»¶å‘½å**ï¼šä½¿ç”¨kebab-caseï¼ˆå¦‚ `checkin.service.ts`ï¼‰
- **å‡½æ•°å‘½å**ï¼šä½¿ç”¨camelCaseï¼ˆå¦‚ `dailyCheckIn`ï¼‰
- **ç±»å‹å‘½å**ï¼šä½¿ç”¨PascalCaseï¼ˆå¦‚ `CheckInResult`ï¼‰
- **å¸¸é‡å‘½å**ï¼šä½¿ç”¨UPPER_SNAKE_CASEï¼ˆå¦‚ `REWARD_TABLE`ï¼‰

---

## ğŸ”Œ APIå¼€å‘è§„èŒƒ

### 1. è·¯ç”±è·¯å¾„å’Œå‚æ•°å‘½å

**è§„åˆ™**ï¼š
- âœ… **å¿…é¡»å¯¹ç…§å‰ç«¯éœ€æ±‚æ–‡æ¡£**ï¼Œç¡®ä¿APIè·¯å¾„å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬å¤§å°å†™ã€å•å¤æ•°ï¼‰
- âœ… **å‚æ•°å…¼å®¹æ€§**ï¼šåŒæ—¶æ”¯æŒcamelCaseï¼ˆå‰ç«¯ï¼‰å’Œsnake_caseï¼ˆåç«¯ï¼‰å‚æ•°å
- âœ… **å“åº”æ ¼å¼å¯¹é½**ï¼šå­—æ®µåã€æ•°æ®ç»“æ„å¿…é¡»ä¸å‰ç«¯æœŸæœ›æ ¼å¼å®Œå…¨åŒ¹é…

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šè·¯å¾„ä¸å‰ç«¯ä¸€è‡´
router.post('/daily', authenticateToken, dailyCheckIn);

// âœ… æ­£ç¡®ï¼šæ”¯æŒä¸¤ç§å‚æ•°å‘½å
const { taskType, task_type } = req.body;
const taskTypeValue = taskType || task_type;

// âŒ é”™è¯¯ï¼šè·¯å¾„ä¸ä¸€è‡´
router.post('/checkin', ...); // å‰ç«¯æœŸæœ› /daily
```

### 2. å“åº”æ ¼å¼ç»Ÿä¸€

**è§„åˆ™**ï¼š
- âœ… **å¿…é¡»ä½¿ç”¨** `sendSuccess()` å’Œ `sendError()` ç»Ÿä¸€å“åº”æ ¼å¼
- âœ… **æˆåŠŸå“åº”**ï¼š`{ success: true, data: {...}, message?: string }`
- âœ… **é”™è¯¯å“åº”**ï¼š`{ success: false, error: string, message?: string }`

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€å“åº”å‡½æ•°
import { sendSuccess, sendError, sendBadRequest } from '../utils/response';

export async function getStatus(req: AuthRequest, res: Response): Promise<void> {
  try {
    const result = await service.getStatus(userId);
    sendSuccess(res, result, 'è·å–æˆåŠŸ');
  } catch (error: any) {
    sendError(res, 'è·å–å¤±è´¥', error.message, 500);
  }
}

// âŒ é”™è¯¯ï¼šç›´æ¥è¿”å›JSON
res.json({ data: result }); // ç¼ºå°‘ç»Ÿä¸€æ ¼å¼
```

### 3. é”™è¯¯å¤„ç†è§„èŒƒ

**è§„åˆ™**ï¼š
- âœ… **ä½¿ç”¨ç»Ÿä¸€é”™è¯¯å‡½æ•°**ï¼š`sendBadRequest`, `sendUnauthorized`, `sendNotFound`, `sendInternalError`
- âœ… **è®°å½•è¯¦ç»†æ—¥å¿—**ï¼šæ‰€æœ‰é”™è¯¯å¿…é¡»è®°å½•åˆ°æ§åˆ¶å°ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… **é”™è¯¯åˆ†ç±»**ï¼šæ ¹æ®é”™è¯¯ç±»å‹è¿”å›åˆé€‚çš„HTTPçŠ¶æ€ç 

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šåˆ†ç±»é”™è¯¯å¤„ç†
try {
  const result = await service.process(userId);
  sendSuccess(res, result);
} catch (error: any) {
  console.error('å¤„ç†å¤±è´¥:', {
    userId,
    error: error.message,
    errorCode: error.code,
  });
  
  if (error.message?.includes('ä¸å­˜åœ¨')) {
    sendNotFound(res, error.message);
  } else if (error.message?.includes('å‚æ•°é”™è¯¯')) {
    sendBadRequest(res, error.message);
  } else {
    sendInternalError(res, 'å¤„ç†å¤±è´¥', error);
  }
}
```

### 4. å‚æ•°éªŒè¯

**è§„åˆ™**ï¼š
- âœ… **æ‰€æœ‰è¾“å…¥å‚æ•°å¿…é¡»éªŒè¯**ï¼šæ£€æŸ¥å¿…å¡«å­—æ®µã€ç±»å‹ã€èŒƒå›´
- âœ… **æ—©æœŸè¿”å›**ï¼šéªŒè¯å¤±è´¥ç«‹å³è¿”å›é”™è¯¯ï¼Œä¸ç»§ç»­æ‰§è¡Œ
- âœ… **å‹å¥½é”™è¯¯æ¶ˆæ¯**ï¼šè¿”å›æ¸…æ™°çš„é”™è¯¯æç¤º

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå®Œæ•´å‚æ•°éªŒè¯
export async function createOrder(req: AuthRequest, res: Response): Promise<void> {
  const { amount, coinsAmount } = req.body;
  
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!amount || amount <= 0) {
    sendBadRequest(res, 'æ”¯ä»˜é‡‘é¢å¿…é¡»å¤§äº0');
    return;
  }
  
  if (!coinsAmount || coinsAmount <= 0) {
    sendBadRequest(res, 'å¤©æœºå¸æ•°é‡å¿…é¡»å¤§äº0');
    return;
  }
  
  // éªŒè¯èŒƒå›´
  if (amount > 100000) {
    sendBadRequest(res, 'æ”¯ä»˜é‡‘é¢ä¸èƒ½è¶…è¿‡100000å…ƒ');
    return;
  }
  
  // éªŒè¯é€šè¿‡åç»§ç»­å¤„ç†
  const result = await service.createOrder(userId, amount, coinsAmount);
  sendSuccess(res, result);
}
```

### 5. è®¤è¯å’Œæƒé™

**è§„åˆ™**ï¼š
- âœ… **æ‰€æœ‰éœ€è¦è®¤è¯çš„API**ï¼šå¿…é¡»ä½¿ç”¨ `authenticateToken` ä¸­é—´ä»¶
- âœ… **ç”¨æˆ·éš”ç¦»**ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- âœ… **ç®¡ç†å‘˜æƒé™**ï¼šç®¡ç†å‘˜APIå¿…é¡»è°ƒç”¨ `is_admin()` å‡½æ•°éªŒè¯

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨è®¤è¯ä¸­é—´ä»¶
import { authenticateToken } from '../middleware/auth.middleware';

router.get('/status', authenticateToken, getStatus);

// âœ… æ­£ç¡®ï¼šéªŒè¯ç”¨æˆ·æƒé™
export async function getUserData(req: AuthRequest, res: Response): Promise<void> {
  const userId = req.user?.userId;
  const targetUserId = req.params.userId;
  
  // ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
  if (userId !== targetUserId) {
    sendForbidden(res, 'æ— æƒè®¿é—®å…¶ä»–ç”¨æˆ·çš„æ•°æ®');
    return;
  }
  
  const data = await service.getUserData(userId);
  sendSuccess(res, data);
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ“ä½œè§„èŒƒ

### 1. äº‹åŠ¡å¤„ç†

**è§„åˆ™**ï¼š
- âœ… **å…³é”®æ“ä½œå¿…é¡»ä½¿ç”¨äº‹åŠ¡**ï¼šæ”¯ä»˜ã€æ‰£è´¹ã€ç­¾åˆ°ã€è®¢é˜…ç­‰
- âœ… **ä½¿ç”¨åŒä¸€ä¸ªclient**ï¼šäº‹åŠ¡ä¸­å¿…é¡»ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥
- âœ… **é”™è¯¯å›æ»š**ï¼šcatchå—ä¸­å¿…é¡»æ‰§è¡ŒROLLBACK
- âœ… **é‡Šæ”¾è¿æ¥**ï¼šfinallyå—ä¸­å¿…é¡»é‡Šæ”¾è¿æ¥

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„äº‹åŠ¡å¤„ç†
export async function processPayment(orderId: string): Promise<PaymentResult> {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');
    
    // 1. æŸ¥è¯¢è®¢å•ï¼ˆä½¿ç”¨FOR UPDATEé”å®šï¼‰
    const orderResult = await client.query(
      `SELECT * FROM transactions WHERE id = $1 FOR UPDATE`,
      [orderId]
    );
    
    if (orderResult.rows.length === 0) {
      await client.query('ROLLBACK');
      throw new Error('è®¢å•ä¸å­˜åœ¨');
    }
    
    // 2. å¹‚ç­‰æ€§æ£€æŸ¥
    if (orderResult.rows[0].status === 'completed') {
      await client.query('ROLLBACK');
      return { success: true, message: 'è®¢å•å·²å¤„ç†' };
    }
    
    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    await client.query(
      `UPDATE transactions SET status = 'completed' WHERE id = $1`,
      [orderId]
    );
    
    // 4. æ›´æ–°ä½™é¢
    await client.query(
      `UPDATE profiles SET tianji_coins_balance = tianji_coins_balance + $1 WHERE id = $2`,
      [coinsAmount, userId]
    );
    
    await client.query('COMMIT');
    return { success: true };
    
  } catch (error: any) {
    await client.query('ROLLBACK');
    console.error('å¤„ç†æ”¯ä»˜å¤±è´¥:', { orderId, error: error.message });
    throw error;
  } finally {
    client.release();
  }
}
```

### 2. å¹¶å‘å®‰å…¨

**è§„åˆ™**ï¼š
- âœ… **ä½¿ç”¨FOR UPDATEé”å®š**ï¼šé˜²æ­¢å¹¶å‘ä¿®æ”¹åŒä¸€è¡Œæ•°æ®
- âœ… **å¹‚ç­‰æ€§æ£€æŸ¥**ï¼šæ”¯ä»˜ã€ç­¾åˆ°ç­‰æ“ä½œå¿…é¡»æ”¯æŒé‡å¤è°ƒç”¨
- âœ… **å”¯ä¸€çº¦æŸ**ï¼šåˆ©ç”¨æ•°æ®åº“å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ•°æ®

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨FOR UPDATEé˜²æ­¢å¹¶å‘
const orderResult = await client.query(
  `SELECT * FROM transactions WHERE id = $1 FOR UPDATE`,
  [orderId]
);

// âœ… æ­£ç¡®ï¼šå¹‚ç­‰æ€§æ£€æŸ¥
if (order.status === 'completed') {
  return { success: true, message: 'è®¢å•å·²å¤„ç†è¿‡' };
}
```

### 3. æ—¶åŒºå¤„ç†

**è§„åˆ™**ï¼š
- âœ… **ä½¿ç”¨æ•°æ®åº“å‡½æ•°**ï¼šæ—¥æœŸæ¯”è¾ƒä½¿ç”¨ `CURRENT_DATE`ï¼ˆPostgreSQLæœåŠ¡å™¨æ—¶åŒºï¼‰
- âœ… **é¿å…åº”ç”¨å±‚è®¡ç®—**ï¼šä¸è¦åœ¨JavaScriptä¸­è®¡ç®—æ—¥æœŸï¼Œä½¿ç”¨æ•°æ®åº“å‡½æ•°
- âœ… **ç»Ÿä¸€æ—¥æœŸæ ¼å¼**ï¼šè¿”å›ç»™å‰ç«¯æ—¶ç»Ÿä¸€æ ¼å¼åŒ–ä¸º `YYYY-MM-DD`

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“CURRENT_DATE
const todayCheckInResult = await client.query(
  `SELECT * FROM check_in_logs 
   WHERE user_id = $1 AND check_in_date = CURRENT_DATE`,
  [userId]
);

// âœ… æ­£ç¡®ï¼šæ ¼å¼åŒ–æ—¥æœŸè¿”å›
function formatDateString(date: Date | string): string {
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  const year = dateObj.getFullYear();
  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
  const day = String(dateObj.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// âŒ é”™è¯¯ï¼šåœ¨åº”ç”¨å±‚è®¡ç®—æ—¥æœŸ
const today = new Date(); // å¯èƒ½æœ‰æ—¶åŒºé—®é¢˜
const todayStr = today.toISOString().split('T')[0];
```

### 4. å‚æ•°åŒ–æŸ¥è¯¢

**è§„åˆ™**ï¼š
- âœ… **å¿…é¡»ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢**ï¼šé˜²æ­¢SQLæ³¨å…¥
- âœ… **ç±»å‹è½¬æ¢**ï¼šæ—¥æœŸç±»å‹ä½¿ç”¨ `::date` æ˜¾å¼è½¬æ¢
- âœ… **NULLå¤„ç†**ï¼šä½¿ç”¨ `COALESCE` å¤„ç†å¯é€‰å‚æ•°

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå‚æ•°åŒ–æŸ¥è¯¢
const result = await pool.query(
  `SELECT * FROM users WHERE id = $1 AND status = $2`,
  [userId, status]
);

// âœ… æ­£ç¡®ï¼šæ—¥æœŸç±»å‹è½¬æ¢
const result = await pool.query(
  `SELECT * FROM cache 
   WHERE period_start = $1::date AND expires_at > NOW()`,
  [periodStart]
);

// âœ… æ­£ç¡®ï¼šNULLå¤„ç†
await client.query(
  `UPDATE transactions 
   SET payment_provider = COALESCE($1, payment_provider),
       paid_at = COALESCE($2, NOW())
   WHERE id = $3`,
  [paymentProvider, paidAt, orderId]
);
```

---

## ğŸ› è°ƒè¯•å’Œæ—¥å¿—è§„èŒƒ

### 1. è°ƒè¯•æ—¥å¿—

**è§„åˆ™**ï¼š
- âœ… **å…³é”®ä¸šåŠ¡é€»è¾‘æ·»åŠ æ—¥å¿—**ï¼šè®°å½•è¾“å…¥å‚æ•°ã€ä¸­é—´ç»“æœã€æœ€ç»ˆç»“æœ
- âœ… **é”™è¯¯æ—¥å¿—åŒ…å«ä¸Šä¸‹æ–‡**ï¼šè®°å½•userIdã€orderIdç­‰å…³é”®ä¿¡æ¯
- âœ… **ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨å¯¹è±¡æ ¼å¼è®°å½•æ—¥å¿—ï¼Œä¾¿äºåˆ†æ

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šè¯¦ç»†çš„ç»“æ„åŒ–æ—¥å¿—
console.log('[ç­¾åˆ°æœåŠ¡] ç”¨æˆ·ç­‰çº§ä¿¡æ¯:', {
  userId,
  rawTier,
  userTier,
  isValidTier: validTiers.includes(userTier),
});

console.log('[ç­¾åˆ°å¥–åŠ±è®¡ç®—] å¥–åŠ±è®¡ç®—è¯¦æƒ…:', {
  tier,
  validTier,
  consecutiveDays,
  dayIndex: dayIndex + 1,
  reward,
  rewardTable,
});

// âœ… æ­£ç¡®ï¼šé”™è¯¯æ—¥å¿—åŒ…å«ä¸Šä¸‹æ–‡
console.error('å¤„ç†æ”¯ä»˜å¤±è´¥:', {
  orderId,
  userId,
  error: error.message,
  errorCode: error.code,
  errorDetail: error.detail,
});
```

### 2. æ•°æ®éªŒè¯æ—¥å¿—

**è§„åˆ™**ï¼š
- âœ… **è®°å½•éªŒè¯å¤±è´¥åŸå› **ï¼šå½“æ•°æ®éªŒè¯å¤±è´¥æ—¶ï¼Œè®°å½•å…·ä½“åŸå› 
- âœ… **è®°å½•é»˜è®¤å€¼ä½¿ç”¨**ï¼šå½“ä½¿ç”¨é»˜è®¤å€¼æ—¶ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šè®°å½•éªŒè¯å’Œé»˜è®¤å€¼
if (!validTiers.includes(tier)) {
  console.warn('[ç­¾åˆ°æœåŠ¡] æ— æ•ˆçš„tierå€¼:', {
    userId,
    rawTier,
    tierLower,
    'ä½¿ç”¨é»˜è®¤å€¼explorer': true,
  });
  userTier = 'explorer';
}
```

---

## ğŸ”’ ä¸šåŠ¡é€»è¾‘è§„èŒƒ

### 1. å¹‚ç­‰æ€§è®¾è®¡

**è§„åˆ™**ï¼š
- âœ… **æ”¯ä»˜å›è°ƒ**ï¼šå¿…é¡»æ”¯æŒå¹‚ç­‰æ€§æ£€æŸ¥ï¼Œé˜²æ­¢é‡å¤å¤„ç†
- âœ… **ç­¾åˆ°æ“ä½œ**ï¼šæ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°ï¼Œå·²ç­¾åˆ°ç›´æ¥è¿”å›
- âœ… **è®¢å•å¤„ç†**ï¼šæ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œå·²å¤„ç†ç›´æ¥è¿”å›ç»“æœ

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå¹‚ç­‰æ€§æ£€æŸ¥
if (order.status === 'completed') {
  await client.query('ROLLBACK');
  return {
    success: true,
    message: 'è®¢å•å·²å¤„ç†è¿‡',
    order_id: orderId,
  };
}
```

### 2. æ•°æ®ä¸€è‡´æ€§

**è§„åˆ™**ï¼š
- âœ… **ä½¿ç”¨æ•°æ®åº“å‡½æ•°**ï¼šæ‰£è´¹ã€ç­¾åˆ°ç­‰æ“ä½œä¼˜å…ˆä½¿ç”¨æ•°æ®åº“å‡½æ•°ï¼ˆå·²åŒ…å«äº‹åŠ¡å’Œé”ï¼‰
- âœ… **äº‹åŠ¡è¾¹ç•Œæ¸…æ™°**ï¼šä¸€ä¸ªä¸šåŠ¡æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆ
- âœ… **é¿å…è·¨äº‹åŠ¡æŸ¥è¯¢**ï¼šäº‹åŠ¡ä¸­ä½¿ç”¨åŒä¸€ä¸ªclientæŸ¥è¯¢

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ•°æ®åº“å‡½æ•°ï¼ˆå·²åŒ…å«äº‹åŠ¡ï¼‰
await pool.query('SELECT deduct_coins($1, $2, $3)', [userId, amount, reason]);

// âœ… æ­£ç¡®ï¼šäº‹åŠ¡ä¸­ä½¿ç”¨åŒä¸€ä¸ªclient
const client = await pool.connect();
try {
  await client.query('BEGIN');
  const profile = await client.query('SELECT * FROM profiles WHERE id = $1', [userId]);
  await client.query('UPDATE profiles SET ... WHERE id = $1', [userId]);
  await client.query('COMMIT');
} finally {
  client.release();
}
```

### 3. ç±»å‹å®‰å…¨

**è§„åˆ™**ï¼š
- âœ… **å®šä¹‰TypeScriptæ¥å£**ï¼šæ‰€æœ‰å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å®šä¹‰ç±»å‹
- âœ… **ä½¿ç”¨ç±»å‹æ–­è¨€**ï¼šæ•°æ®åº“æŸ¥è¯¢ç»“æœä½¿ç”¨ç±»å‹æ–­è¨€
- âœ… **é¿å…anyç±»å‹**ï¼šå°½é‡ä¸ä½¿ç”¨anyï¼Œä½¿ç”¨å…·ä½“ç±»å‹æˆ–unknown

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå®šä¹‰æ¥å£
export interface CheckInResult {
  success: boolean;
  message?: string;
  coins_earned?: number;
  consecutive_days?: number;
}

export async function dailyCheckIn(userId: string): Promise<CheckInResult> {
  // ...
}

// âœ… æ­£ç¡®ï¼šç±»å‹æ–­è¨€
const row = result.rows[0] as {
  id: string;
  user_id: string;
  coins_earned: number;
};
```

---

## ğŸ“ ä»£ç è´¨é‡è§„èŒƒ

### 1. ä»£ç æ³¨é‡Š

**è§„åˆ™**ï¼š
- âœ… **å‡½æ•°æ³¨é‡Š**ï¼šæ‰€æœ‰å¯¼å‡ºå‡½æ•°å¿…é¡»æœ‰JSDocæ³¨é‡Š
- âœ… **å¤æ‚é€»è¾‘æ³¨é‡Š**ï¼šå¤æ‚ä¸šåŠ¡é€»è¾‘æ·»åŠ æ³¨é‡Šè¯´æ˜
- âœ… **TODOæ ‡è®°**ï¼šä½¿ç”¨ `// TODO:` æ ‡è®°å¾…å®ŒæˆåŠŸèƒ½

**ç¤ºä¾‹**ï¼š
```typescript
/**
 * æ¯æ—¥ç­¾åˆ°ï¼ˆè°ƒç”¨æ•°æ®åº“å‡½æ•° handle_daily_check_inï¼‰
 * 
 * @param userId ç”¨æˆ·ID
 * @returns Promise<CheckInResult> ç­¾åˆ°ç»“æœ
 * 
 * @throws Error å¦‚æœç­¾åˆ°å¤±è´¥ï¼ˆä»Šæ—¥å·²ç­¾åˆ°ã€ç”¨æˆ·ä¸å­˜åœ¨ç­‰ï¼‰
 */
export async function dailyCheckIn(userId: string): Promise<CheckInResult> {
  // âœ… ä½¿ç”¨ PostgreSQL çš„ CURRENT_DATE å‡½æ•°ï¼ˆæœåŠ¡å™¨æœ¬åœ°æ—¶åŒºï¼‰
  // è¿™æ ·æ— è®ºæœåŠ¡å™¨åœ¨å“ªä¸ªæ—¶åŒºï¼Œéƒ½ä¼šä½¿ç”¨æ•°æ®åº“æœåŠ¡å™¨çš„æ—¶åŒºè®¾ç½®
  const todayCheckInResult = await pool.query(
    `SELECT 1 FROM check_in_logs 
     WHERE user_id = $1 AND check_in_date = CURRENT_DATE`,
    [userId]
  );
}
```

### 2. é”™è¯¯å¤„ç†å®Œæ•´æ€§

**è§„åˆ™**ï¼š
- âœ… **æ•è·æ‰€æœ‰é”™è¯¯**ï¼štry-catchè¦†ç›–æ‰€æœ‰å¯èƒ½å‡ºé”™çš„æ“ä½œ
- âœ… **åˆ†ç±»é”™è¯¯å¤„ç†**ï¼šæ ¹æ®é”™è¯¯ç±»å‹ï¼ˆæ•°æ®åº“é”™è¯¯ã€ä¸šåŠ¡é”™è¯¯ï¼‰åˆ†åˆ«å¤„ç†
- âœ… **è®°å½•é”™è¯¯æ—¥å¿—**ï¼šæ‰€æœ‰é”™è¯¯å¿…é¡»è®°å½•æ—¥å¿—

**ç¤ºä¾‹**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†
try {
  const result = await service.process(userId);
  sendSuccess(res, result);
} catch (error: any) {
  console.error('å¤„ç†å¤±è´¥:', {
    userId,
    error: error.message,
    errorCode: error.code,
  });
  
  // å¤„ç†æ•°æ®åº“é”™è¯¯
  if (error.code === '23505') {
    sendConflict(res, 'èµ„æºå·²å­˜åœ¨');
    return;
  }
  
  if (error.code === '23503') {
    sendBadRequest(res, 'å¤–é”®çº¦æŸè¿å');
    return;
  }
  
  // å¤„ç†ä¸šåŠ¡é”™è¯¯
  if (error.message?.includes('ä¸å­˜åœ¨')) {
    sendNotFound(res, error.message);
    return;
  }
  
  // å…¶ä»–é”™è¯¯
  sendInternalError(res, 'å¤„ç†å¤±è´¥', error);
}
```

---

## ğŸš¨ å¸¸è§é”™è¯¯é¿å…

### 1. APIè·¯å¾„ä¸ä¸€è‡´
- âŒ **é”™è¯¯**ï¼šå‰ç«¯ä½¿ç”¨ `/daily`ï¼Œåç«¯å®ç° `/checkin`
- âœ… **æ­£ç¡®**ï¼šå¯¹ç…§å‰ç«¯éœ€æ±‚æ–‡æ¡£ï¼Œç¡®ä¿è·¯å¾„å®Œå…¨ä¸€è‡´

### 2. å‚æ•°å‘½åä¸ä¸€è‡´
- âŒ **é”™è¯¯**ï¼šå‰ç«¯ä¼ é€’ `taskType`ï¼Œåç«¯åªæ¥å— `task_type`
- âœ… **æ­£ç¡®**ï¼šåŒæ—¶æ”¯æŒä¸¤ç§å‘½åï¼Œæˆ–ç»Ÿä¸€ä½¿ç”¨å‰ç«¯å‘½å

### 3. å“åº”æ ¼å¼ä¸ä¸€è‡´
- âŒ **é”™è¯¯**ï¼šç›´æ¥è¿”å› `{ data: ... }`ï¼Œç¼ºå°‘ `success` å­—æ®µ
- âœ… **æ­£ç¡®**ï¼šä½¿ç”¨ `sendSuccess()` ç»Ÿä¸€å“åº”æ ¼å¼

### 4. æ—¶åŒºé—®é¢˜
- âŒ **é”™è¯¯**ï¼šåœ¨JavaScriptä¸­è®¡ç®—æ—¥æœŸï¼Œå¯èƒ½æœ‰æ—¶åŒºé—®é¢˜
- âœ… **æ­£ç¡®**ï¼šä½¿ç”¨æ•°æ®åº“ `CURRENT_DATE` å‡½æ•°

### 5. äº‹åŠ¡ä½¿ç”¨é”™è¯¯
- âŒ **é”™è¯¯**ï¼šäº‹åŠ¡ä¸­ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“è¿æ¥
- âœ… **æ­£ç¡®**ï¼šäº‹åŠ¡ä¸­ä½¿ç”¨åŒä¸€ä¸ªclient

### 6. ç¼ºå°‘å¹‚ç­‰æ€§æ£€æŸ¥
- âŒ **é”™è¯¯**ï¼šæ”¯ä»˜å›è°ƒå¯èƒ½é‡å¤å¤„ç†åŒä¸€è®¢å•
- âœ… **æ­£ç¡®**ï¼šæ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œå·²å¤„ç†ç›´æ¥è¿”å›

### 7. ç¼ºå°‘å‚æ•°éªŒè¯
- âŒ **é”™è¯¯**ï¼šç›´æ¥ä½¿ç”¨ `req.body` ä¸­çš„æ•°æ®ï¼Œä¸éªŒè¯
- âœ… **æ­£ç¡®**ï¼šéªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°

### 8. ç¼ºå°‘æƒé™éªŒè¯
- âŒ **é”™è¯¯**ï¼šç”¨æˆ·å¯èƒ½è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ•°æ®
- âœ… **æ­£ç¡®**ï¼šéªŒè¯ç”¨æˆ·æƒé™ï¼Œç¡®ä¿æ•°æ®éš”ç¦»

---

## ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•

### å®ç°å‰å¿…æŸ¥
- [ ] å¯¹ç…§å‰ç«¯éœ€æ±‚æ–‡æ¡£ï¼Œç¡®è®¤APIè·¯å¾„å®Œå…¨ä¸€è‡´
- [ ] ç¡®è®¤å‚æ•°åå…¼å®¹ï¼ˆæ”¯æŒcamelCaseå’Œsnake_caseï¼‰
- [ ] ç¡®è®¤å“åº”æ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸€è‡´

### å®ç°åå¿…éªŒ
- [ ] è·¯å¾„æ˜ å°„æ£€æŸ¥ï¼šå‰ç«¯è·¯å¾„ä¸åç«¯è·¯ç”±ä¸€è‡´
- [ ] å“åº”æ ¼å¼æ£€æŸ¥ï¼šä½¿ç”¨ `sendSuccess` ç»Ÿä¸€æ ¼å¼
- [ ] å‚æ•°å…¼å®¹æ£€æŸ¥ï¼šå…³é”®å‚æ•°æ”¯æŒä¸¤ç§å‘½å
- [ ] ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§ï¼šè¿”å›å‰ç«¯éœ€è¦çš„æ‰€æœ‰å­—æ®µ
- [ ] é”™è¯¯å¤„ç†æ£€æŸ¥ï¼šæ‰€æœ‰é”™è¯¯éƒ½æœ‰åˆé€‚çš„å¤„ç†
- [ ] æ—¥å¿—è®°å½•æ£€æŸ¥ï¼šå…³é”®æ“ä½œæœ‰æ—¥å¿—è®°å½•

### æµ‹è¯•éªŒè¯
- [ ] ä½¿ç”¨Postmanæµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
- [ ] æµ‹è¯•é”™è¯¯åœºæ™¯ï¼ˆå‚æ•°é”™è¯¯ã€æƒé™é”™è¯¯ç­‰ï¼‰
- [ ] æµ‹è¯•å¹¶å‘åœºæ™¯ï¼ˆé‡å¤æäº¤ã€å¹¶å‘è¯·æ±‚ç­‰ï¼‰
- [ ] æµ‹è¯•è¾¹ç•Œåœºæ™¯ï¼ˆç©ºå€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ç­‰ï¼‰

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **APIéœ€æ±‚æ˜ å°„è¡¨**ï¼š`260130-å‰ç«¯è½¬åç«¯APIéœ€æ±‚æ˜ å°„è¡¨.md`
- **ä»»åŠ¡ç³»ç»ŸAPIè§„èŒƒ**ï¼š`åç«¯APIå¼€å‘æç¤ºè¯-ä»»åŠ¡ç³»ç»Ÿ.md`
- **ç´«å¾®æ–—æ•°APIè§„èŒƒ**ï¼š`ç´«å¾®æ–—æ•°APIå¼€å‘è§„èŒƒ.md`
- **æ”¯ä»˜APIè¯´æ˜**ï¼š`æ”¯ä»˜APIå®ç°è¯´æ˜.md`

---

**æœ€åæ›´æ–°**ï¼š2025å¹´1æœˆ30æ—¥  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
